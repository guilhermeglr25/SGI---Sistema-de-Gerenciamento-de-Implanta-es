<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SGI - Sistema de Gerenciamento de Implantações</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="icon" type="image/x-icon" href="linx.ico?v=2000">

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7c3aed">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SGI">
  
<style>

/* ===== BASE STYLES ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  min-height: 100vh;
  background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
  color: #e0e6ed;
}

body::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"><rect fill="%23ffffff" opacity="0.05" width="300" height="200"/></svg>') no-repeat left center;
  background-size: 300px auto;
  opacity: 0.25;
  z-index: 0;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(17, 24, 39, 0.8);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(124, 58, 237, 0.6);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(124, 58, 237, 0.8);
}

/* ===== ANIMATIONS ===== */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideInRight {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
  to { transform: translateX(400px); opacity: 0; }
}

@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
  50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
}

@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

@keyframes float {
  0%, 100% { transform: translateY(0) translateX(0); }
  50% { transform: translateY(-20px) translateX(20px); }
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes scaleIn {
  0% { transform: scale(0) rotate(-180deg); }
  50% { transform: scale(1.2) rotate(10deg); }
  100% { transform: scale(1) rotate(0); }
}

@keyframes achievementSlideIn {
  from { transform: translateX(500px) rotate(10deg); opacity: 0; }
  to { transform: translateX(0) rotate(0); opacity: 1; }
}

@keyframes sparkleFloat {
  0% { transform: translateY(0) rotate(0deg); opacity: 1; }
  100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
}

@keyframes confettiFall {
  to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

@keyframes slideUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes itemMoving {
  0% {
    opacity: 1;
    transform: translateX(0) scale(1);
  }
  50% {
    opacity: 0.5;
    transform: translateX(20px) scale(0.95);
  }
  100% {
    opacity: 0;
    transform: translateX(40px) scale(0.9);
  }
}

.item-moving {
  animation: itemMoving 0.4s ease-out;
}

@keyframes slideOutRight {
  to { 
    transform: translateX(400px); 
    opacity: 0; 
    height: 0;
    padding: 0;
    margin: 0;
  }
}

/* ===== LOGIN SCREEN ===== */
#login-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 20px;
  position: relative;
  z-index: 2;
}

#login-screen {
  background: rgba(26, 26, 46, 0.95);
  padding: 30px 35px;
  border-radius: 15px;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
  text-align: center;
  max-width: 400px;
  width: 100%;
  border: 1px solid rgba(124, 58, 237, 0.3);
  max-height: 90vh;
  overflow-y: auto;
}

#login-screen h2 {
  color: #7c3aed;
  margin-bottom: 10px;
}

#login-screen p {
  color: #9ca3af;
  margin-bottom: 20px;
}

#login-screen input {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border: 2px solid #374151;
  border-radius: 8px;
  font-size: 14px;
  background: #1f2937;
  color: #e5e7eb;
}

#login-screen input:focus {
  outline: none;
  border-color: #7c3aed;
}

#cadastro-box {
  display: none;
  margin-top: 20px;
}

/* ===== LOGIN MELHORADO ===== */
.login-logo {
  width: 60px;
  height: 60px;
  margin: 0 auto 15px;
  background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 20px rgba(124, 58, 237, 0.3);
}

.login-logo svg {
  width: 32px;
  height: 32px;
}

#login-screen h2 {
  color: #7c3aed;
  margin-bottom: 5px;
  font-size: 24px;
  font-weight: 700;
}

#login-screen p {
  color: #9ca3af;
  margin-bottom: 20px;
  font-size: 13px;
}

#login-screen p.subtitle {
  margin-bottom: 20px;
  font-size: 13px;
}

/* Input Groups */
.input-group {
  margin-bottom: 16px;
  text-align: left;
}

.input-group label {
  display: block;
  color: #e5e7eb;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
}

.input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.input-wrapper input {
  width: 100%;
  padding: 10px 45px 10px 12px;
  border: 2px solid #374151;
  border-radius: 8px;
  font-size: 14px;
  background: #1f2937;
  color: #e5e7eb;
  transition: all 0.3s;
}

.input-wrapper input:focus {
  outline: none;
  border-color: #7c3aed;
  background: #2d3748;
}

.input-wrapper input.error {
  border-color: #ef4444;
}

.input-wrapper input.success {
  border-color: #10b981;
}

.input-icon {
  position: absolute;
  right: 15px;
  font-size: 18px;
  pointer-events: none;
  opacity: 0.5;
}

.toggle-password {
  position: absolute;
  right: 12px;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 18px;
  padding: 5px;
  opacity: 0.6;
  transition: opacity 0.3s;
}

.toggle-password:hover {
  opacity: 1;
}

.input-hint {
  display: block;
  color: #9ca3af;
  font-size: 11px;
  margin-top: 4px;
}

.input-error {
  display: block;
  color: #ef4444;
  font-size: 11px;
  margin-top: 4px;
  min-height: 16px;
}

/* Login Options */
.login-options {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 12px 0 16px 0;
  font-size: 13px;
}

.checkbox-wrapper {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #d1d5db;
  cursor: pointer;
  font-size: 13px;
}

.checkbox-wrapper input[type="checkbox"] {
  width: 16px;
  height: 16px;
  cursor: pointer;
}

.forgot-password {
  color: #7c3aed;
  text-decoration: none;
  font-weight: 600;
  transition: color 0.3s;
}

.forgot-password:hover {
  color: #6d28d9;
  text-decoration: underline;
}

/* Buttons */
.btn-block {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.btn-secondary {
  background: transparent;
  color: #e5e7eb;
  border: 2px solid #374151;
}

.btn-secondary:hover {
  background: #374151;
  border-color: #4b5563;
}

.btn-back {
  background: transparent;
  border: none;
  color: #9ca3af;
  font-size: 13px;
  cursor: pointer;
  margin-bottom: 15px;
  padding: 6px;
  transition: color 0.3s;
  text-align: left;
  width: 100%;
}

.btn-back:hover {
  color: #e5e7eb;
}

/* Loading Spinner */
.spinner {
  animation: rotate 1s linear infinite;
  width: 20px;
  height: 20px;
}

.spinner .path {
  stroke: currentColor;
  stroke-linecap: round;
  animation: dash 1.5s ease-in-out infinite;
}

@keyframes rotate {
  100% { transform: rotate(360deg); }
}

@keyframes dash {
  0% {
    stroke-dasharray: 1, 150;
    stroke-dashoffset: 0;
  }
  50% {
    stroke-dasharray: 90, 150;
    stroke-dashoffset: -35;
  }
  100% {
    stroke-dasharray: 90, 150;
    stroke-dashoffset: -124;
  }
}

/* Divider */
.divider {
  display: flex;
  align-items: center;
  text-align: center;
  margin: 14px 0;
  color: #6b7280;
}

.divider span {
  padding: 0 12px;
  font-size: 12px;
}

.divider::before,
.divider::after {
  content: '';
  flex: 1;
  border-bottom: 1px solid #374151;
}

.divider span {
  padding: 0 15px;
  font-size: 13px;
}

/* Password Strength */
.password-strength {
  margin-top: 8px;
}

.strength-bar {
  height: 3px;
  background: #374151;
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 4px;
}

.strength-text {
  font-size: 11px;
  color: #9ca3af;
}

.strength-fill {
  height: 100%;
  width: 0%;
  transition: all 0.3s;
  border-radius: 2px;
}

.strength-fill.weak {
  width: 33%;
  background: #ef4444;
}

.strength-fill.medium {
  width: 66%;
  background: #f59e0b;
}

.strength-fill.strong {
  width: 100%;
  background: #10b981;
}

.strength-text {
  font-size: 12px;
  color: #9ca3af;
}

.strength-text.weak {
  color: #ef4444;
}

.strength-text.medium {
  color: #f59e0b;
}

.strength-text.strong {
  color: #10b981;
}

/* Recovery */
.recovery-icon {
  font-size: 48px;
  margin-bottom: 15px;
}

.recovery-success {
  text-align: center;
  padding: 30px;
  background: rgba(16, 185, 129, 0.1);
  border-radius: 12px;
  border: 2px solid rgba(16, 185, 129, 0.3);
  margin-top: 20px;
}

.success-icon {
  font-size: 48px;
  margin-bottom: 15px;
}

.recovery-success h4 {
  color: #10b981;
  margin-bottom: 10px;
}

.recovery-success p {
  color: #9ca3af;
  font-size: 14px;
  line-height: 1.6;
}

/* Animations */
@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#cadastro-box,
#recuperar-senha-box {
  animation: slideInUp 0.4s ease-out;
}

/* ===== BUTTONS ===== */
.btn {
  padding: 10px 18px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  margin: 4px;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.btn-block {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin: 8px 0;
}

.btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn:active::before {
  width: 300px;
  height: 300px;
}

.btn-primary {
  background: #7c3aed;
  color: white;
}

.btn-primary:hover {
  background: #6d28d9;
  transform: translateY(-1px);
}

.btn-warning {
  background: #f59e0b;
  color: white;
}

.btn-warning:hover {
  background: #d97706;
  transform: translateY(-1px);
}

.btn-danger {
  background: #ef4444;
  color: white;
}

.btn-danger:hover {
  background: #dc2626;
  transform: translateY(-1px);
}

.btn-success {
  background: #10b981;
  color: white;
}

.btn-success:hover {
  background: #059669;
  transform: translateY(-1px);
}

.btn-sm {
  padding: 5px 10px;
  font-size: 12px;
}

/* ===== APP CONTAINER ===== */
#app {
  width: 100%;
  min-height: 100vh;
  position: relative;
  z-index: 2;
}

/* Controle de visibilidade via inline style */
#app[style*="display: block"] {
  display: block !important;
}

.container {
  width: 95%;
  margin: 20px auto;
  background: rgba(31, 41, 55, 0.9);
  border-radius: 15px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  overflow: hidden;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(75, 85, 99, 0.3);
}

/* ===== NAVIGATION TABS (OLD - HIDDEN IN NEW LAYOUT) ===== */
.header {
  background: linear-gradient(135deg, #1f2937, #374151);
  color: white;
  padding: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  border-bottom: 1px solid rgba(75, 85, 99, 0.3);
}

.header h1 {
  color: #7c3aed;
  cursor: pointer;
}

.nav-tabs {
  display: flex;
  background: rgba(17, 24, 39, 0.8);
  border-bottom: 1px solid rgba(75, 85, 99, 0.3);
  flex-wrap: wrap;
}

.tab-button {
  flex: 1;
  padding: 15px 20px;
  background: none;
  border: none;
  cursor: pointer;
  transition: 0.3s;
  font-weight: 500;
  min-width: 120px;
  color: #9ca3af;
}

.tab-button:hover {
  background: rgba(124, 58, 237, 0.1);
  color: #7c3aed;
}

.tab-button.active {
  background: rgba(124, 58, 237, 0.2);
  border-bottom: 3px solid #7c3aed;
  color: #7c3aed;
}

/* ===== TAB CONTENT ===== */
.tab-content {
  display: none;
  padding: 30px;
  background: rgba(31, 41, 55, 0.5);
  animation: fadeIn 0.4s ease-in-out;
}

.tab-content.active {
  display: block;
}

/* ===== FORMS ===== */
form label {
  display: block;
  margin-top: 10px;
  font-weight: 600;
  color: #d1d5db;
}

form input,
form select,
form textarea {
  width: 100%;
  padding: 8px;
  margin: 5px 0 15px 0;
  border: 1px solid #374151;
  border-radius: 6px;
  background: #1f2937;
  color: #e5e7eb;
}

form input:focus,
form select:focus,
form textarea:focus {
  outline: none;
  border-color: #7c3aed;
}

form input.valid,
form select.valid,
form textarea.valid {
  border-color: #10b981;
}

form input.invalid,
form select.invalid,
form textarea.invalid {
  border-color: #ef4444;
}

/* ===== CARDS ===== */

.projeto-termo-card {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
  padding: 20px;
  margin: 15px 0;
  border-radius: 12px;
  border: 2px solid rgba(124, 58, 237, 0.3);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.projeto-termo-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(124, 58, 237, 0.2), transparent);
  transition: left 0.5s;
}

.projeto-termo-card:hover::before {
  left: 100%;
}

.projeto-termo-card:hover {
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 20px 40px rgba(124, 58, 237, 0.4);
  border-color: rgba(124, 58, 237, 0.8);
}

.projeto-termo-card:active {
  transform: translateY(-2px) scale(1.01);
}

.implantacao-card,
.stat-card,
.projeto-termo-card,
.treinamento-item {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.implantacao-card {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
  padding: 20px;
  margin: 15px 0;
  border-radius: 12px;
  border-left: 4px solid #7c3aed;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(75, 85, 99, 0.2);
}

.implantacao-card:hover,
.stat-card:hover,
.projeto-termo-card:hover {
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 20px 40px rgba(124, 58, 237, 0.4);
}

.implantacao-header {
  font-size: 18px;
  font-weight: bold;
  color: #7c3aed;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.implantacao-logo {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  object-fit: cover;
  border: 2px solid rgba(124, 58, 237, 0.3);
}

.implantacao-info {
  margin: 5px 0;
  font-size: 14px;
  color: #d1d5db;
}

.implantacao-info strong {
  color: #f3f4f6;
}

/* ===== STATS ===== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.stat-card {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
  padding: 20px;
  border-radius: 12px;
  border-left: 4px solid #7c3aed;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  text-align: center;
  border: 1px solid rgba(75, 85, 99, 0.3);
}

.stat-number {
  font-size: 2em;
  font-weight: bold;
  color: #7c3aed;
  text-shadow: 0 0 10px rgba(124, 58, 237, 0.3);
}

.stat-label {
  color: #9ca3af;
  margin-top: 5px;
}

/* ===== PROGRESS BARS ===== */
.progress-bar {
  width: 100%;
  height: 24px;
  background: linear-gradient(145deg, rgba(17, 24, 39, 0.8), rgba(31, 41, 55, 0.6));
  border-radius: 12px;
  overflow: hidden;
  margin: 10px 0;
  border: 1px solid rgba(75, 85, 99, 0.3);
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #10b981, #059669);
  transition: width 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 12px;
  box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
}

/* ===== PROGRESS DETAILS ===== */
.progress-details {
  display: none;
  margin-top: 15px;
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.4s ease;
}

.progress-details.show {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

.toggle-details {
  background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(109, 40, 217, 0.15));
  backdrop-filter: blur(10px);
  border: 1px solid rgba(124, 58, 237, 0.3);
  color: #7c3aed;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  padding: 10px 20px;
  margin: 10px 0;
  border-radius: 8px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 15px rgba(124, 58, 237, 0.1);
}

.toggle-details:hover {
  background: linear-gradient(135deg, rgba(124, 58, 237, 0.2), rgba(109, 40, 217, 0.25));
  border-color: rgba(124, 58, 237, 0.5);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(124, 58, 237, 0.2);
}

.toggle-details:active {
  transform: translateY(0);
}

.toggle-details .icon {
  display: inline-block;
  transition: transform 0.3s ease;
  font-size: 16px;
}

.toggle-details.expanded .icon {
  transform: rotate(180deg);
}

.toggle-details.expanded {
  background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(109, 40, 217, 0.2));
  border-color: rgba(124, 58, 237, 0.4);
}

/* ===== SECTIONS ===== */
.section-header {
  background: linear-gradient(145deg, rgba(124, 58, 237, 0.1), rgba(109, 40, 217, 0.2));
  padding: 15px 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  border-left: 4px solid #7c3aed;
  border: 1px solid rgba(124, 58, 237, 0.3);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.section-header h3 {
  color: #7c3aed;
  margin: 0;
}

/* ===== CHECKLIST ===== */
.checklist-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
  padding: 10px;
  background: rgba(17, 24, 39, 0.6);
  border-radius: 6px;
  border: 1px solid rgba(75, 85, 99, 0.3);
}

.modulos-box {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 8px;
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
  border: 1px solid #374151;
  border-radius: 6px;
  background: rgba(17, 24, 39, 0.5);
}

.modulos-box label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: normal;
  cursor: pointer;
  color: #d1d5db;
}

.editar-checklist {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 30px;
  border: 2px solid rgba(59, 130, 246, 0.3);
  backdrop-filter: blur(10px);
}

.editar-checklist h3 {
  color: #60a5fa;
}

.checklist-optico {
  background: linear-gradient(145deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.2));
  border-color: rgba(16, 185, 129, 0.3);
}

.checklist-optico h3 {
  color: #10b981;
}

.checklist-editor {
  display: flex;
  gap: 10px;
  margin: 10px 0;
  align-items: center;
}

/* ===== VISUALIZAÇÃO FALTANTES ===== */
.missing-items-view {
  display: none;
}

.missing-items-view.active {
  display: block;
}

.missing-stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 15px;
  margin: 20px 0;
}

.missing-stat-card {
  background: linear-gradient(145deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.25));
  border: 2px solid rgba(239, 68, 68, 0.4);
  border-radius: 15px;
  padding: 20px;
  text-align: center;
  position: relative;
  overflow: hidden;
  transition: all 0.3s;
  cursor: pointer;
}

.missing-stat-card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
  animation: shine 3s infinite;
}

.missing-stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 30px rgba(239, 68, 68, 0.4);
}

.missing-stat-card.active {
  transform: scale(1.05);
  box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.5) !important;
}

.missing-stat-icon {
  font-size: 36px;
  margin-bottom: 10px;
  animation: bounce 2s infinite;
}

.missing-stat-number {
  font-size: 40px;
  font-weight: 800;
  color: #ef4444;
  text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
  margin: 10px 0;
}

.missing-stat-label {
  font-size: 13px;
  color: #fca5a5;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 600;
}

.missing-items-kanban {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 20px;
  margin: 30px 0;
}

.missing-item-card {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.95), rgba(17, 24, 39, 0.98));
  border: 2px solid rgba(239, 68, 68, 0.4);
  border-radius: 15px;
  padding: 20px;
  position: relative;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  animation: slideUp 0.4s ease-out;
  cursor: pointer;
}

.missing-item-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.2), transparent);
  transition: left 0.5s;
}

.missing-item-card:hover::before {
  left: 100%;
}

.missing-item-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 15px 40px rgba(239, 68, 68, 0.5);
  border-color: rgba(239, 68, 68, 0.8);
}

.missing-item-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
  gap: 10px;
}

.missing-item-number {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  width: 35px;
  height: 35px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 16px;
  box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
  flex-shrink: 0;
}

.missing-item-badge {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: 1px solid rgba(245, 158, 11, 0.3);
}

.missing-item-text {
  color: #e5e7eb;
  font-size: 15px;
  line-height: 1.6;
  margin: 15px 0;
  font-weight: 500;
}

.missing-item-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.copy-item-btn {
  flex: 1;
  background: linear-gradient(135deg, #7c3aed, #6d28d9);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.copy-item-btn:hover {
  background: linear-gradient(135deg, #6d28d9, #7c3aed);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(124, 58, 237, 0.5);
}

.copy-item-btn:active {
  transform: translateY(0);
}

.copy-item-btn svg {
  width: 16px;
  height: 16px;
}

.mark-done-btn {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.mark-done-btn:hover {
  background: linear-gradient(135deg, #059669, #10b981);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(16, 185, 129, 0.5);
}

.copied-indicator {
  position: absolute;
  top: 10px;
  right: 10px;
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  padding: 8px 15px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 700;
  display: none;
  align-items: center;
  gap: 5px;
  animation: slideInRight 0.3s ease-out;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
}

.copied-indicator.show {
  display: flex;
}

.missing-empty-state {
  text-align: center;
  padding: 80px 20px;
  background: linear-gradient(145deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.2));
  border: 2px dashed rgba(16, 185, 129, 0.4);
  border-radius: 20px;
  margin: 30px 0;
}

.empty-state-icon {
  font-size: 80px;
  margin-bottom: 20px;
  animation: float 3s ease-in-out infinite;
}

.empty-state-title {
  font-size: 28px;
  font-weight: 700;
  color: #10b981;
  margin-bottom: 15px;
  text-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
}

.empty-state-text {
  font-size: 16px;
  color: #9ca3af;
  line-height: 1.6;
}

.copy-all-section {
  background: linear-gradient(145deg, rgba(124, 58, 237, 0.15), rgba(109, 40, 217, 0.25));
  border: 2px solid rgba(124, 58, 237, 0.4);
  border-radius: 15px;
  padding: 25px;
  margin: 30px 0;
  text-align: center;
}

.copy-all-btn {
  background: linear-gradient(135deg, #7c3aed, #6d28d9);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
}

.copy-all-btn:hover {
  background: linear-gradient(135deg, #6d28d9, #7c3aed);
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 12px 35px rgba(124, 58, 237, 0.6);
}

.copy-all-btn:active {
  transform: translateY(-1px) scale(1.02);
}

.copy-all-btn svg {
  width: 20px;
  height: 20px;
}

@keyframes pulse-ring {
  0% {
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
  }
  70% {
    box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
  }
}

.missing-item-card.pulse {
  animation: pulse-ring 2s infinite;
}

/* ===== DRAG AND DROP CHECKLIST ===== */
.checklist-editor {
  display: flex;
  gap: 10px;
  margin: 10px 0;
  align-items: center;
  padding: 10px;
  background: rgba(17, 24, 39, 0.6);
  border-radius: 8px;
  border: 2px solid transparent;
  cursor: move;
  transition: all 0.3s;
}

.checklist-editor:hover {
  background: rgba(31, 41, 55, 0.8);
  border-color: rgba(124, 58, 237, 0.3);
}

.checklist-editor.dragging {
  opacity: 0.5;
  background: rgba(124, 58, 237, 0.2);
  border-color: #7c3aed;
  transform: scale(0.95);
}

.checklist-editor.drag-over {
  border-color: #10b981;
  background: rgba(16, 185, 129, 0.1);
}

.drag-handle {
  cursor: grab;
  color: #9ca3af;
  font-size: 20px;
  padding: 0 5px;
  user-select: none;
}

.drag-handle:active {
  cursor: grabbing;
}

.drag-handle:hover {
  color: #7c3aed;
}

.checklist-editor input {
  flex: 1;
}

.item-order {
  min-width: 30px;
  text-align: center;
  font-weight: bold;
  color: #7c3aed;
  font-size: 14px;
}

body.light-mode .checklist-editor {
  background: rgba(243, 244, 246, 0.8);
}

body.light-mode .checklist-editor:hover {
  background: rgba(229, 231, 235, 0.9);
}

/* ===== TREINAMENTOS ===== */
.treinamento-item {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
  padding: 15px;
  margin: 10px 0;
  border-radius: 10px;
  border: 1px solid rgba(75, 85, 99, 0.3);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.treinamento-item:hover {
  transform: translateY(-1px);
}

/* ===== BADGES ===== */
.optico-badge {
  color: #10b981;
  font-weight: bold;
  margin-left: 10px;
  background: rgba(16, 185, 129, 0.1);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
}

.separador-optico {
  margin: 20px 0;
  text-align: center;
  color: #10b981;
  font-weight: bold;
  font-size: 16px;
  padding: 15px;
  background: linear-gradient(145deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.2));
  border-radius: 10px;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.badge-shimmer {
  position: relative;
  overflow: hidden;
}

.badge-shimmer::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: shimmer 2s infinite;
}

/* ===== NOVO LAYOUT COM SIDEBAR ===== */
.app-wrapper {
  display: flex !important;
  min-height: 100vh;
}

.sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: 70px;
  height: 100vh;
  background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
  border-right: 1px solid rgba(124, 58, 237, 0.2);
  z-index: 1000;
  overflow-y: auto;
  overflow-x: hidden;
  transition: width 0.3s ease;
}

.sidebar:hover {
  width: 260px;
}

.sidebar-header {
  padding: 25px 20px;
  border-bottom: 1px solid rgba(124, 58, 237, 0.2);
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
}

.sidebar-logo-mini {
  font-size: 28px;
  opacity: 1;
  transition: opacity 0.3s ease;
}

.sidebar:hover .sidebar-logo-mini {
  opacity: 0;
  display: none;
}

.sidebar-logo {
  font-size: 24px;
  font-weight: 700;
  background: linear-gradient(135deg, #7c3aed, #10b981);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  display: none;
}

.sidebar:hover .sidebar-logo {
  display: block;
}

.sidebar-subtitle {
  font-size: 11px;
  color: #9ca3af;
  margin-top: 5px;
  letter-spacing: 1px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.sidebar:hover .sidebar-subtitle {
  opacity: 1;
}

.sidebar-nav {
  padding: 20px 0;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 20px;
  color: #d1d5db;
  cursor: pointer;
  transition: all 0.3s;
  border-left: 3px solid transparent;
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
}

.nav-item span:not(.nav-icon) {
  opacity: 0;
  transition: opacity 0.3s ease;
}

.sidebar:hover .nav-item span:not(.nav-icon) {
  opacity: 1;
}

.nav-item:hover {
  background: rgba(124, 58, 237, 0.1);
  border-left-color: rgba(124, 58, 237, 0.5);
  color: #7c3aed;
}

.nav-item.active {
  background: rgba(124, 58, 237, 0.15);
  border-left-color: #7c3aed;
  color: #7c3aed;
}

.nav-icon {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.nav-icon svg {
  width: 20px;
  height: 20px;
  stroke-width: 2;
  transition: all 0.3s ease;
}

.nav-item:hover .nav-icon svg {
  transform: scale(1.1);
}

.nav-divider {
  height: 1px;
  background: rgba(124, 58, 237, 0.2);
  margin: 15px 20px;
}

/* Footer alignment */
footer {
  margin-left: 70px;
  width: calc(100% - 70px);
  transition: margin-left 0.3s ease, width 0.3s ease;
}

@media (max-width: 768px) {
  footer {
    margin-left: 0;
    width: 100%;
  }
}

.sidebar-footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  padding: 20px;
  border-top: 1px solid rgba(124, 58, 237, 0.2);
}

.main-wrapper {
  margin-left: 70px;
  width: calc(100% - 70px);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  transition: margin-left 0.3s ease, width 0.3s ease;
}

.top-header {
  position: sticky;
  top: 0;
  z-index: 999;
  background: rgba(31, 41, 55, 0.95);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(75, 85, 99, 0.3);
  padding: 15px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.header-left h2 {
  color: #e5e7eb;
  font-size: 20px;
  margin: 0;
}

.header-breadcrumb {
  font-size: 12px;
  color: #9ca3af;
  margin-top: 2px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

.header-icon-btn {
  position: relative;
  background: rgba(124, 58, 237, 0.1);
  border: 1px solid rgba(124, 58, 237, 0.3);
  color: #7c3aed;
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 18px;
}

.header-icon-btn:hover {
  background: rgba(124, 58, 237, 0.2);
  transform: translateY(-2px);
}

.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ef4444;
  color: white;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  font-size: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  border: 2px solid #1f2937;
}

.user-menu {
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: rgba(124, 58, 237, 0.1);
  border: 1px solid rgba(124, 58, 237, 0.3);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s;
}

.user-menu:hover {
  background: rgba(124, 58, 237, 0.2);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: linear-gradient(135deg, #7c3aed, #10b981);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 14px;
}

.user-info {
  display: flex;
  flex-direction: column;
}

.user-name {
  font-size: 13px;
  font-weight: 600;
  color: #e5e7eb;
}

.user-role {
  font-size: 10px;
  color: #9ca3af;
}

.user-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 10px;
  background: rgba(31, 41, 55, 0.98);
  border: 1px solid rgba(124, 58, 237, 0.3);
  border-radius: 12px;
  padding: 8px;
  min-width: 200px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  display: none;
  z-index: 10000;
}

.user-menu.active .user-dropdown {
  display: block;
  animation: fadeIn 0.2s;
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  color: #e5e7eb;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.2s;
  font-size: 13px;
}

.dropdown-item:hover {
  background: rgba(124, 58, 237, 0.2);
  color: #7c3aed;
}

.dropdown-item span:first-child {
  display: flex;
  align-items: center;
  justify-content: center;
}

.dropdown-item svg {
  width: 16px;
  height: 16px;
}

.dropdown-divider {
  height: 1px;
  background: rgba(124, 58, 237, 0.2);
  margin: 5px 0;
}

.content-area {
  flex: 1;
  padding: 30px;
  background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
}

/* Mobile responsivo */
.mobile-menu-btn {
  display: none;
  background: rgba(124, 58, 237, 0.1);
  border: 1px solid rgba(124, 58, 237, 0.3);
  color: #7c3aed;
  width: 40px;
  height: 40px;
  border-radius: 10px;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 20px;
}

@media (max-width: 768px) {
  .sidebar {
    width: 260px;
    transform: translateX(-260px);
  }
  
  .sidebar.mobile-open {
    transform: translateX(0);
  }
  
  .sidebar:hover {
    width: 260px;
  }
  
  .main-wrapper {
    margin-left: 0;
    width: 100%;
  }
  
  .mobile-menu-btn {
    display: flex;
  }
}

/* Perfil Modal */
.profile-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10001;
  animation: fadeIn 0.3s;
}

.profile-modal.active {
  display: flex;
}

.profile-content {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.98), rgba(17, 24, 39, 0.98));
  border: 2px solid rgba(124, 58, 237, 0.5);
  border-radius: 20px;
  padding: 40px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  position: relative;
}

.profile-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(239, 68, 68, 0.2);
  border: none;
  color: #ef4444;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.3s;
}

.profile-close:hover {
  background: rgba(239, 68, 68, 0.3);
  transform: rotate(90deg);
}

.profile-avatar-large {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: linear-gradient(135deg, #7c3aed, #10b981);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 40px;
  margin: 0 auto 20px;
  border: 4px solid rgba(124, 58, 237, 0.3);
}

.profile-info-group {
  margin: 20px 0;
}

.profile-label {
  font-size: 11px;
  color: #9ca3af;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 5px;
}

.profile-value {
  font-size: 16px;
  color: #e5e7eb;
  padding: 10px;
  background: rgba(17, 24, 39, 0.8);
  border-radius: 8px;
  border: 1px solid rgba(75, 85, 99, 0.3);
}

.profile-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin: 20px 0;
}

.profile-stat {
  text-align: center;
  padding: 15px;
  background: rgba(124, 58, 237, 0.1);
  border: 1px solid rgba(124, 58, 237, 0.3);
  border-radius: 12px;
}

.profile-stat-value {
  font-size: 24px;
  font-weight: 700;
  color: #7c3aed;
}

.profile-stat-label {
  font-size: 11px;
  color: #9ca3af;
  margin-top: 5px;
}

/* ===== UPLOAD DE FOTO DE PERFIL ===== */
.profile-photo-section {
  position: relative;
  margin: 0 auto 20px;
  width: 100px;
  height: 100px;
}

.profile-avatar-large {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: linear-gradient(135deg, #7c3aed, #10b981);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 40px;
  border: 4px solid rgba(124, 58, 237, 0.3);
  overflow: hidden;
  position: relative;
}

.profile-avatar-large img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-photo-upload-btn {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #7c3aed, #6d28d9);
  border: 2px solid #1f2937;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  font-size: 16px;
}

.profile-photo-upload-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(135deg, #6d28d9, #7c3aed);
  box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
}

.profile-photo-remove-btn {
  position: absolute;
  top: 0;
  right: 0;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: rgba(239, 68, 68, 0.9);
  border: 2px solid #1f2937;
  color: white;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  font-size: 14px;
}

.profile-photo-remove-btn:hover {
  background: #dc2626;
  transform: scale(1.1);
}

.profile-photo-section:hover .profile-photo-remove-btn {
  display: flex;
}

/* Ajustes no container antigo */
body.new-layout .container {
  background: transparent;
  box-shadow: none;
  border: none;
  margin: 0;
  width: 100%;
}

body.new-layout .header,
body.new-layout .nav-tabs {
  display: none;
}

body.new-layout .tab-content {
  background: transparent;
  padding: 0;
  display: block !important;
}

body.new-layout .tab-content:not(.active-content) {
  display: none !important;
}

/* ===== NOTIFICATIONS DROPDOWN ===== */
.notifications-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 10px;
  background: rgba(31, 41, 55, 0.98);
  border: 1px solid rgba(124, 58, 237, 0.3);
  border-radius: 12px;
  padding: 8px;
  min-width: 320px;
  max-width: 400px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  display: none;
  z-index: 10000;
  max-height: 400px;
  overflow-y: auto;
}

.notifications-dropdown.active {
  display: block;
  animation: fadeIn 0.2s;
}

.notifications-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(124, 58, 237, 0.3);
  margin-bottom: 8px;
}

.notifications-title {
  font-weight: 600;
  color: #e5e7eb;
  font-size: 14px;
}

.notifications-clear {
  background: none;
  border: none;
  color: #7c3aed;
  cursor: pointer;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s;
}

.notifications-clear:hover {
  background: rgba(124, 58, 237, 0.2);
}

.notification-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px;
  margin: 4px 0;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  border-left: 3px solid transparent;
}

.notification-item:hover {
  background: rgba(124, 58, 237, 0.1);
  border-left-color: #7c3aed;
}

.notification-item.unread {
  background: rgba(124, 58, 237, 0.05);
  border-left-color: #7c3aed;
}

.notification-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.notification-icon.warning {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
}

.notification-icon.error {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

.notification-icon.info {
  background: rgba(59, 130, 246, 0.2);
  color: #3b82f6;
}

.notification-icon.success {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
}

.notification-content {
  flex: 1;
}

.notification-text {
  color: #e5e7eb;
  font-size: 13px;
  margin-bottom: 4px;
  line-height: 1.4;
}

.notification-time {
  color: #9ca3af;
  font-size: 11px;
}

.notifications-empty {
  text-align: center;
  padding: 40px 20px;
  color: #9ca3af;
}

.notifications-empty-icon {
  font-size: 48px;
  margin-bottom: 10px;
  opacity: 0.5;
}

/* ===== GO LIVE & TERMO ===== */
.golive-section {
  background: linear-gradient(145deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.25));
  border: 2px solid rgba(16, 185, 129, 0.4);
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  position: relative;
  overflow: hidden;
}

.golive-section::before {
  content: "";
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(16, 185, 129, 0.1), transparent);
  animation: shine 3s infinite;
}

.golive-btn {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: all 0.3s;
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.golive-btn:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
}

.golive-btn:active {
  transform: translateY(-1px) scale(1.02);
}

.golive-btn.completed {
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  cursor: not-allowed;
}

.golive-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: rgba(16, 185, 129, 0.2);
  border: 2px solid #10b981;
  color: #10b981;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 700;
  font-size: 14px;
  animation: pulse 2s infinite;
}

.termo-enviado-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: rgba(99, 102, 241, 0.2);
  border: 2px solid #6366f1;
  color: #6366f1;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 700;
  font-size: 14px;
}

.status-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}

.status-icon.pending {
  background: #f59e0b;
  animation: blink 1.5s infinite;
}

.status-icon.completed {
  background: #10b981;
}

/* ===== MELHORIAS PARA VISUALIZAÇÃO DO TERMO ===== */
.termo-email {
  max-height: none !important;
  overflow: visible !important;
  min-height: 600px;
}

#termo-container {
  max-height: none !important;
  overflow-y: visible !important;
  height: auto !important;
  padding-bottom: 100px;
}

#template-termo-visual {
  max-height: 1200px !important;
  min-height: 800px !important;
  overflow-y: auto !important;
}

.termo-email::-webkit-scrollbar,
#template-termo-visual::-webkit-scrollbar {
  width: 10px;
}

.termo-email::-webkit-scrollbar-track,
#template-termo-visual::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 5px;
}

.termo-email::-webkit-scrollbar-thumb,
#template-termo-visual::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 5px;
}

.termo-email::-webkit-scrollbar-thumb:hover,
#template-termo-visual::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* ===== EQUIPE ===== */
.equipe-item {
  background: rgba(17, 24, 39, 0.5);
  padding: 15px;
  margin: 10px 0;
  border-radius: 8px;
  border: 1px solid rgba(124, 58, 237, 0.3);
}

.equipe-item label {
  margin-top: 5px;
}

.equipe-item input {
  margin-bottom: 10px;
}

/* ===== UPLOAD ZONE ===== */
.logo-upload-area,
.upload-zone {
  border: 3px dashed rgba(124, 58, 237, 0.4);
  border-radius: 15px;
  padding: 40px;
  text-align: center;
  background: linear-gradient(145deg, rgba(17, 24, 39, 0.5), rgba(31, 41, 55, 0.3));
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.upload-zone::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(124, 58, 237, 0.2), transparent);
  transition: left 0.5s;
}

.upload-zone:hover::before {
  left: 100%;
}

.upload-zone:hover,
.logo-upload-area:hover {
  border-color: #7c3aed;
  background: rgba(124, 58, 237, 0.15);
  transform: scale(1.02);
}

.upload-zone.dragover {
  border-color: #10b981;
  background: rgba(16, 185, 129, 0.1);
  transform: scale(1.05);
}

.upload-icon {
  font-size: 48px;
  color: #7c3aed;
  margin-bottom: 15px;
}

.upload-text {
  color: #d1d5db;
  font-size: 14px;
}

.upload-preview {
  margin-top: 20px;
  display: flex;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
}

.preview-item {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 10px;
  overflow: hidden;
  border: 2px solid rgba(124, 58, 237, 0.3);
}

.preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.preview-remove {
  position: absolute;
  top: 5px;
  right: 5px;
  background: rgba(239, 68, 68, 0.9);
  border: none;
  color: white;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.preview-remove:hover {
  background: #dc2626;
  transform: scale(1.1);
}

.logo-preview {
  max-width: 150px;
  max-height: 150px;
  margin: 10px auto;
  border-radius: 8px;
  border: 2px solid rgba(124, 58, 237, 0.3);
}

/* ===== ACTIONS ROW ===== */
.actions-row {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
}

/* ===== SUCCESS MESSAGE ===== */
.success-message {
  background: linear-gradient(145deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3));
  color: #10b981;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 20px;
  border: 1px solid rgba(16, 185, 129, 0.3);
  backdrop-filter: blur(10px);
}

/* ===== PROJETOS SCROLL ===== */
.projetos-scroll {
  max-height: 600px;
  overflow-y: auto;
  padding-right: 10px;
}

/* ===== TOAST NOTIFICATIONS ===== */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 400px;
}

.toast {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.98), rgba(17, 24, 39, 0.98));
  border: 2px solid;
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}

.toast.success {
  border-color: #10b981;
}

.toast.error {
  border-color: #ef4444;
}

.toast.warning {
  border-color: #f59e0b;
}

.toast.info {
  border-color: #3b82f6;
}

.toast-icon {
  width: 24px;
  height: 24px;
  flex-shrink: 0;
  font-size: 20px;
}

.toast-content {
  flex: 1;
  color: #e5e7eb;
}

.toast-title {
  font-weight: 600;
  margin-bottom: 4px;
}

.toast-message {
  font-size: 13px;
  color: #d1d5db;
}

.toast-close {
  background: none;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  font-size: 20px;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s;
}

.toast-close:hover {
  color: #fff;
}

.toast.removing {
  animation: slideOutRight 0.3s forwards;
}

/* ===== LIGHT MODE ===== */
body.light-mode {
  background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 50%, #d1d5db 100%);
  color: #1f2937;
}

/* Sidebar em light mode */
body.light-mode .sidebar {
  background: linear-gradient(180deg, #ffffff 0%, #f9fafb 100%);
  border-right: 1px solid rgba(209, 213, 219, 0.5);
}

body.light-mode .sidebar-logo {
  background: linear-gradient(135deg, #7c3aed, #10b981);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

body.light-mode .sidebar-subtitle {
  color: #6b7280;
}

body.light-mode .nav-item {
  color: #4b5563;
}

body.light-mode .nav-item:hover {
  background: rgba(124, 58, 237, 0.1);
  color: #7c3aed;
}

body.light-mode .nav-item.active {
  background: rgba(124, 58, 237, 0.15);
  color: #7c3aed;
}

body.light-mode .nav-divider {
  background: rgba(209, 213, 219, 0.5);
}

/* Header em light mode */
body.light-mode .top-header {
  background: rgba(255, 255, 255, 0.95);
  border-bottom: 1px solid rgba(209, 213, 219, 0.5);
}

body.light-mode .header-left h2 {
  color: #1f2937;
}

body.light-mode .header-breadcrumb {
  color: #6b7280;
}

body.light-mode .header-icon-btn {
  background: rgba(124, 58, 237, 0.1);
  border-color: rgba(124, 58, 237, 0.3);
  color: #7c3aed;
}

body.light-mode .header-icon-btn:hover {
  background: rgba(124, 58, 237, 0.2);
}

body.light-mode .user-menu {
  background: rgba(124, 58, 237, 0.1);
  border-color: rgba(124, 58, 237, 0.3);
}

body.light-mode .user-name {
  color: #1f2937;
}

body.light-mode .user-role {
  color: #6b7280;
}

body.light-mode .user-dropdown {
  background: rgba(255, 255, 255, 0.98);
  border-color: rgba(209, 213, 219, 0.5);
}

body.light-mode .dropdown-item {
  color: #1f2937;
}

body.light-mode .dropdown-item:hover {
  background: rgba(124, 58, 237, 0.1);
  color: #7c3aed;
}

/* Content area em light mode */
body.light-mode .content-area {
  background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 50%, #d1d5db 100%);
}

/* Cards e elementos em light mode */
body.light-mode .container,
body.light-mode .implantacao-card,
body.light-mode .stat-card,
body.light-mode .treinamento-item,
body.light-mode .editar-checklist,
body.light-mode .chart-container,
body.light-mode .analytics-card {
  background: rgba(255, 255, 255, 0.9);
  border-color: rgba(209, 213, 219, 0.5);
}

body.light-mode .section-header {
  background: rgba(124, 58, 237, 0.1);
  border-color: rgba(124, 58, 237, 0.3);
}

body.light-mode .section-header h3 {
  color: #7c3aed;
}

body.light-mode .tab-content {
  background: transparent;
}

body.light-mode form input,
body.light-mode form select,
body.light-mode form textarea {
  background: #fff;
  border-color: #d1d5db;
  color: #1f2937;
}

body.light-mode .implantacao-info,
body.light-mode label {
  color: #374151;
}

body.light-mode .implantacao-info strong {
  color: #1f2937;
}

body.light-mode .implantacao-header {
  color: #7c3aed;
}

/* Notificações em light mode */
body.light-mode .notifications-dropdown {
  background: rgba(255, 255, 255, 0.98);
  border-color: rgba(209, 213, 219, 0.5);
}

body.light-mode .notifications-title,
body.light-mode .notification-text {
  color: #1f2937;
}

body.light-mode .notification-time {
  color: #6b7280;
}

body.light-mode .notifications-empty {
  color: #6b7280;
}

/* Profile modal em light mode */
body.light-mode .profile-content {
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(249, 250, 251, 0.98));
  border-color: rgba(124, 58, 237, 0.5);
}

body.light-mode .profile-label {
  color: #6b7280;
}

body.light-mode .profile-value {
  background: rgba(243, 244, 246, 0.8);
  border-color: rgba(209, 213, 219, 0.5);
  color: #1f2937;
}

/* ===== CHARTS & ANALYTICS ===== */
.chart-container {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
  padding: 25px;
  border-radius: 15px;
  margin: 20px 0;
  border: 1px solid rgba(75, 85, 99, 0.3);
}

.chart-container canvas {
  max-height: 300px;
}

.chart-legend {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  margin-top: 15px;
  padding: 10px;
  font-size: 11px;
  color: #9ca3af;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
}

.legend-color {
  width: 12px;
  height: 12px;
  border-radius: 3px;
  display: inline-block;
}

.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.analytics-card {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
  padding: 20px;
  border-radius: 12px;
  border: 1px solid rgba(75, 85, 99, 0.3);
}

.analytics-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.analytics-title {
  color: #7c3aed;
  font-weight: 600;
  font-size: 14px;
}

.analytics-value {
  font-size: 2em;
  font-weight: bold;
  color: #7c3aed;
  margin: 10px 0;
}

.analytics-trend {
  font-size: 13px;
  color: #10b981;
}

.analytics-trend.down {
  color: #ef4444;
}

/* ===== EXPORT MENU ===== */
.export-menu {
  position: relative;
  display: inline-block;
}

.export-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 5px;
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.98), rgba(17, 24, 39, 0.98));
  border: 1px solid rgba(124, 58, 237, 0.3);
  border-radius: 10px;
  padding: 8px;
  min-width: 200px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  display: none;
  z-index: 1000;
}

.export-menu.active .export-dropdown {
  display: block;
  animation: fadeIn 0.2s;
}

.export-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  color: #e5e7eb;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
}

.export-option:hover {
  background: rgba(124, 58, 237, 0.2);
  color: #7c3aed;
}

.export-option-icon {
  font-size: 18px;
}

/* ===== MODALS ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  animation: fadeIn 0.3s;
}

.modal-content {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.98), rgba(17, 24, 39, 0.98));
  border: 2px solid rgba(124, 58, 237, 0.5);
  border-radius: 20px;
  padding: 40px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  animation: slideUp 0.3s;
  position: relative;
}

.modal-header {
  text-align: center;
  margin-bottom: 30px;
}

.modal-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 20px;
  background: linear-gradient(135deg, #10b981, #059669);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  animation: scaleIn 0.5s;
}

.modal-title {
  font-size: 24px;
  font-weight: 700;
  color: #10b981;
  margin-bottom: 10px;
}

.modal-body {
  color: #d1d5db;
  line-height: 1.6;
  margin-bottom: 30px;
}

.modal-actions {
  display: flex;
  gap: 15px;
  justify-content: center;
}

/* ===== SPARKLES & CONFETTI ===== */
.sparkle {
  position: fixed;
  pointer-events: none;
  font-size: 20px;
  animation: sparkleFloat 2s forwards;
}

.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  animation: confettiFall 3s linear;
}
</style>
</head>

<body>

<!-- Container de Toasts -->
<div class="toast-container" id="toast-container"></div>

<!-- Camadas de Parallax -->
<div class="parallax-layer parallax-layer-1"></div>
<div class="parallax-layer parallax-layer-2"></div>

<!-- LOGIN SCREEN -->
<div id="login-wrapper">
  <div id="login-screen">
    <div class="login-logo">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="20" x2="18" y2="10"></line>
        <line x1="12" y1="20" x2="12" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="14"></line>
      </svg>
    </div>
    
    <h2>Bem-vindo à SGI</h2>
    <p>Sistema de Gerenciamento de Implantações</p>
    
    <!-- FORMULÁRIO DE LOGIN -->
    <form id="form-login" onsubmit="fazerLogin(event)">
      <div class="input-group">
        <label for="username">Email</label>
        <div class="input-wrapper">
          <input 
            type="email" 
            class="equipe-email" 
            id="username" 
            name="email"
            placeholder="email@linx.com.br"
            onblur="validarEmailCampo(this)"
            autocomplete="email"
            required
            spellcheck="false"
          >
          <span class="input-icon">📧</span>
        </div>
        <span class="input-error" id="email-error"></span>
      </div>
      
      <div class="input-group">
        <label for="password">Senha</label>
        <div class="input-wrapper">
          <input 
            type="password" 
            id="password" 
            name="password"
            placeholder="••••••••"
            autocomplete="current-password"
            required
            minlength="6"
          >
          <button type="button" class="toggle-password" onclick="togglePassword('password')" tabindex="-1">
            👁️
          </button>
        </div>
        <span class="input-error" id="password-error"></span>
      </div>
      
      <div class="login-options">
        <label class="checkbox-wrapper">
          <input type="checkbox" id="remember-me">
          <span>Lembrar-me</span>
        </label>
        <a href="#" class="forgot-password" onclick="mostrarRecuperarSenha(); return false;">
          Esqueceu a senha?
        </a>
      </div>
      
      <button type="submit" class="btn btn-primary btn-block" id="btn-login">
        <span class="btn-text">Entrar</span>
        <span class="btn-loader" style="display:none;">
          <svg class="spinner" viewBox="0 0 50 50">
            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
          </svg>
        </span>
      </button>
      
      <div class="divider">
        <span>ou</span>
      </div>
      
      <button type="button" class="btn btn-secondary btn-block" onclick="mostrarCadastro()">
        Criar nova conta
      </button>
    </form>
    
    <!-- FORMULÁRIO DE CADASTRO -->
    <div id="cadastro-box" style="display:none;">
      <button class="btn-back" onclick="voltarLogin()">
        ← Voltar
      </button>
      
      <h3>Criar Conta</h3>
      <p class="subtitle">Preencha os dados abaixo</p>
      
      <form id="form-cadastro" onsubmit="cadastrarUsuario(event)">
        <div class="input-group">
          <label for="novo-usuario">Email</label>
          <div class="input-wrapper">
            <input 
              type="email" 
              id="novo-usuario" 
              name="email"
              placeholder="seu@email.com"
              autocomplete="email"
              required
              spellcheck="false"
            >
            <span class="input-icon">📧</span>
          </div>
          <span class="input-hint">Use um email válido para recuperação</span>
          <span class="input-error" id="novo-email-error"></span>
        </div>
        
        <div class="input-group">
          <label for="nova-senha">Senha</label>
          <div class="input-wrapper">
            <input 
              type="password" 
              id="nova-senha" 
              name="password"
              placeholder="Mínimo 6 caracteres"
              autocomplete="new-password"
              required
              minlength="6"
              oninput="validarForcaSenha(this.value)"
            >
            <button type="button" class="toggle-password" onclick="togglePassword('nova-senha')" tabindex="-1">
              👁️
            </button>
          </div>
          
          <!-- Indicador de força da senha -->
          <div class="password-strength" id="password-strength">
            <div class="strength-bar">
              <div class="strength-fill" id="strength-fill"></div>
            </div>
            <span class="strength-text" id="strength-text">Digite uma senha</span>
          </div>
          
          <span class="input-error" id="nova-senha-error"></span>
        </div>
        
        <div class="input-group">
          <label for="confirmar-senha">Confirmar Senha</label>
          <div class="input-wrapper">
            <input 
              type="password" 
              id="confirmar-senha" 
              name="password-confirm"
              placeholder="Digite a senha novamente"
              autocomplete="new-password"
              required
              minlength="6"
            >
            <button type="button" class="toggle-password" onclick="togglePassword('confirmar-senha')" tabindex="-1">
              👁️
            </button>
          </div>
          <span class="input-error" id="confirmar-senha-error"></span>
        </div>
        
        <button type="submit" class="btn btn-primary btn-block" id="btn-cadastro">
          <span class="btn-text">Criar Conta</span>
          <span class="btn-loader" style="display:none;">
            <svg class="spinner" viewBox="0 0 50 50">
              <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
            </svg>
          </span>
        </button>
      </form>
    </div>
    
    <!-- FORMULÁRIO DE RECUPERAÇÃO DE SENHA -->
    <div id="recuperar-senha-box" style="display:none;">
      <button class="btn-back" onclick="voltarLogin()">
        ← Voltar
      </button>
      
      <div class="recovery-icon">🔑</div>
      
      <h3>Recuperar Senha</h3>
      <p class="subtitle">Digite seu email para receber o link de redefinição</p>
      
      <form id="form-recuperar" onsubmit="enviarEmailRecuperacao(event)">
        <div class="input-group">
          <label for="email-recuperacao">Email</label>
          <div class="input-wrapper">
            <input 
              type="email" 
              id="email-recuperacao" 
              placeholder="seu@email.com"
              autocomplete="email"
              required
              spellcheck="false"
            >
            <span class="input-icon">📧</span>
          </div>
          <span class="input-hint">Enviaremos um link para redefinir sua senha</span>
          <span class="input-error" id="email-recuperacao-error"></span>
        </div>
        
        <button type="submit" class="btn btn-primary btn-block" id="btn-recuperar">
          <span class="btn-text">Enviar Link</span>
          <span class="btn-loader" style="display:none;">
            <svg class="spinner" viewBox="0 0 50 50">
              <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
            </svg>
          </span>
        </button>
      </form>
      
      <div class="recovery-success" id="recovery-success" style="display:none;">
        <div class="success-icon">✅</div>
        <h4>Email Enviado!</h4>
        <p>Verifique sua caixa de entrada e spam. O link expira em 1 hora.</p>
      </div>
    </div>
  </div>
</div>

<div id="app" style="display:none;">
  <div class="app-wrapper">
    
    <!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo-mini">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <line x1="18" y1="20" x2="18" y2="10"></line>
        <line x1="12" y1="20" x2="12" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="14"></line>
      </svg>
    </div>
    <div class="sidebar-logo">SGI - SISTEMA</div>
    <div class="sidebar-subtitle">GERENCIAMENTO DE IMPLANTAÇÕES</div>
  </div>
      
      <nav class="sidebar-nav">
        <div class="nav-item active" onclick="navigateTo('dashboard', this)">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
          </span>
          <span>Dashboard</span>
        </div>
        
        <div class="nav-item" onclick="navigateTo('nova-implantacao', this)">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
          </span>
          <span>Nova Implantação</span>
        </div>
        
        <div class="nav-item" onclick="navigateTo('implantacoes', this)">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
              <path d="M9 12h6M9 16h6"></path>
            </svg>
          </span>
          <span>Gerenciar</span>
        </div>
        
        <div class="nav-item" onclick="navigateTo('treinamentos', this)">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
              <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
            </svg>
          </span>
          <span>Treinamentos</span>
        </div>
        
        <div class="nav-item" onclick="navigateTo('termo', this)">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
          </span>
          <span>Termo</span>
        </div>
        
        <div class="nav-item" onclick="navigateTo('visao-times', this)">
  <span class="nav-icon">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
      <circle cx="9" cy="7" r="4"></circle>
      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      <line x1="2" y1="12" x2="22" y2="12"></line>
    </svg>
  </span>
  <span>Visão por Times</span>
</div>

        <div class="nav-item" onclick="navigateTo('configuracoes', this)">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
            </svg>
          </span>
          <span>Configurações</span>
        </div>
        
        <div class="nav-divider"></div>
        
        <div class="nav-item" onclick="abrirPerfil()">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span>Meu Perfil</span>
        </div>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-wrapper">
      
      <!-- TOP HEADER -->
      <header class="top-header">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        
        <div class="header-left">
          <h2 id="page-title">Dashboard</h2>
          <div class="header-breadcrumb" id="breadcrumb">Início / Dashboard</div>
        </div>
        
        <div class="header-right">
          <!-- Notificações -->
          <div class="header-icon-btn" id="notifications-btn" onclick="toggleNotifications(event)" title="Notificações" style="position: relative;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 01-3.46 0"></path>
            </svg>
            <span class="notification-badge" id="notif-count" style="display: none;">0</span>
            
            <!-- Dropdown de notificações -->
            <div class="notifications-dropdown" id="notifications-dropdown">
              <div class="notifications-header">
                <span class="notifications-title">Notificações</span>
                <button class="notifications-clear" onclick="limparNotificacoes(event)">Limpar todas</button>
              </div>
              <div id="notifications-list"></div>
            </div>
          </div>
          
          <!-- Tema -->
          <div class="header-icon-btn" id="theme-toggle-header" onclick="toggleTheme()" title="Alternar Tema">
            <svg id="theme-icon-svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
            </svg>
          </div>
          
          <!-- Menu Usuário -->
          <div class="user-menu" id="user-menu" onclick="toggleUserMenu()">
            <div class="user-avatar" id="user-avatar">A</div>
            <div class="user-info">
              <div class="user-name" id="user-name-display">Admin</div>
              <div class="user-role">Administrador</div>
            </div>
            <span style="color:#9ca3af;">▼</span>
            
            <div class="user-dropdown" id="user-dropdown">
              <div class="dropdown-item" onclick="abrirPerfil()">
                <span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </span>
                <span>Meu Perfil</span>
              </div>
              <div class="dropdown-item" onclick="navigateTo('configuracoes'); toggleUserMenu();">
                <span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                  </svg>
                </span>
                <span>Configurações</span>
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-item" onclick="logout()">
                <span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                  </svg>
                </span>
                <span>Sair</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- CONTENT AREA -->
      <div class="content-area">
        <div class="container">
          
          <!-- TAB: DASHBOARD -->
          <div id="dashboard" class="tab-content active-content">
            <div class="section-header">
              <h3>Dashboard Executivo</h3>

              <div class="export-menu">
                <button class="btn btn-primary" onclick="toggleExportMenu()">Exportar Dados</button>
                <div class="export-dropdown" id="export-dropdown">
                  <div class="export-option" onclick="exportarPDF()">
                    <span class="export-option-icon">📄</span>
                    <span>Exportar como PDF</span>
                  </div>
                  <div class="export-option" onclick="exportarExcel()">
                    <span class="export-option-icon">📊</span>
                    <span>Exportar para Excel</span>
                  </div>

<div class="export-option" onclick="exportarRelatorioPersonalizado()">
      <span class="export-option-icon">📋</span>
      <span>Relatório Personalizado</span>
    </div>

                  <div class="export-option" onclick="exportarJSON()">
                    <span class="export-option-icon">💾</span>
                    <span>Backup JSON</span>
                  </div>
                </div>
              </div>
            </div>

            
            <div class="chart-container">
              <canvas id="progressChart"></canvas>
            </div>

            <div class="chart-container">
  <h4 style="color: #7c3aed; margin-bottom: 15px; text-align: center;">
    📊 Desempenho por Time
  </h4>
  <canvas id="timeChart"></canvas>
</div>
            
            <div class="analytics-grid">
              <div class="analytics-card">
                <div class="analytics-header">
                  <span class="analytics-title">TEMPO MÉDIO DE IMPLANTAÇÃO</span>
                </div>
                <div class="analytics-value" id="tempo-medio">0 dias</div>
                <div class="analytics-trend" id="tempo-trend">↑ 12% vs. mês anterior</div>
              </div>
              
              <div class="analytics-card">
                <div class="analytics-header">
                  <span class="analytics-title">TAXA DE SUCESSO</span>
                </div>
                <div class="analytics-value" id="taxa-sucesso">0%</div>
                <div class="analytics-trend" id="taxa-trend">↑ Excelente desempenho</div>
              </div>
              
              <div class="analytics-card">
                <div class="analytics-header">
                  <span class="analytics-title">PROJETOS ESTE MÊS</span>
                </div>
                <div class="analytics-value" id="projetos-mes">0</div>
                <div class="analytics-trend" id="projetos-trend">↑ 3 novos projetos</div>
              </div>
            </div>
            
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="total-implantacoes">0</div>
                <div class="stat-label">Total Implantações</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="implantacoes-andamento">0</div>
                <div class="stat-label">Em Andamento</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="implantacoes-concluidas">0</div>
                <div class="stat-label">Concluídas</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="progresso-medio">0%</div>
                <div class="stat-label">Progresso Médio Geral</div>
              </div>
            </div>

            <div class="section-header">
              <h3>Todas as Implantações</h3>
            </div>
            <div class="projetos-scroll" id="todas-implantacoes"></div>
          </div>

          <!-- TAB: NOVA IMPLANTAÇÃO -->
          <div id="nova-implantacao" class="tab-content">
            <div class="section-header">
              <h3>Nova Implantação</h3>
            </div>
            <div id="success-alert" style="display:none;" class="success-message"></div>
            <form id="nova-implantacao-form" onsubmit="return salvarImplantacao(event)">
              <label>Logo da Empresa</label>
              <div class="upload-zone" id="logo-upload-zone">
                <div class="upload-icon">📤</div>
                <div class="upload-text">
                  <strong>Clique ou arraste</strong> para fazer upload da logo<br>
                  <small>Formatos aceitos: PNG, JPG, SVG (máx. 2MB)</small>
                </div>
                <div class="upload-preview" id="logo-preview-container" style="display:none;"></div>
              </div>
              <input type="file" id="logo-input" accept="image/*" style="display:none;">
              <img id="logo-preview" class="logo-preview" style="display:none;">
              
              <label>Número do Portal *</label>
              <input type="text" id="numero-portal" required>
              
              <label>Razão Social / Nome Fantasia *</label>
              <input type="text" id="razao-social" required>
              
              <label>Empresa *</label>
              <select id="empresa" required onchange="ajustarEmpresa()">
                <option value="">Selecione</option>
                <option value="unica">Única</option>
                <option value="matriz">Matriz/Filiais</option>
              </select>
              <div id="empresa-detalhes"></div>
              
              <label>Módulos do Sistema</label>
              <div class="modulos-box" id="modulos-lista">
                <label><input type="checkbox" value="Conciliador">Conciliador</label>
                <label><input type="checkbox" value="Linx Mobilidade">Linx Mobilidade</label>
                <label><input type="checkbox" value="Hub GiftCard">Hub GiftCard</label>
                <label><input type="checkbox" value="Hub Fidelidade">Hub Fidelidade</label>
                <label><input type="checkbox" value="NF-e">NF-e</label>
                <label><input type="checkbox" value="NFC-e">NFC-e</label>
                <label><input type="checkbox" value="NFS-e">NFS-e</label>
                <label><input type="checkbox" value="Gestão Fiscal - DOME">Gestão Fiscal - DOME</label>
                <label><input type="checkbox" value="Parceiro Fidelidade">Parceiro Fidelidade</label>
                <label><input type="checkbox" value="Ramo Óptico">Ramo Óptico</label>
                <label><input type="checkbox" value="SAT">SAT</label>
                <label><input type="checkbox" value="Serviços">Serviços</label>
                <label><input type="checkbox" value="SFA">SFA</label>
                <label><input type="checkbox" value="SPED Contábil">SPED Contábil</label>
                <label><input type="checkbox" value="SPED Contribuições">SPED Contribuições</label>
                <label><input type="checkbox" value="SPED Fiscal">SPED Fiscal</label>
                <label><input type="checkbox" value="SPED ECF">SPED ECF</label>
                <label><input type="checkbox" value="Troca Nacional">Troca Nacional</label>
                <label><input type="checkbox" value="Neomode">Neomode</label>
                <label><input type="checkbox" value="Gestor Tributário">Gestor Tributário</label>
                <label><input type="checkbox" value="Linx Estética">Linx Estética</label>
                <label><input type="checkbox" value="Recomendação de Compras">Recomendação de Compras</label>
                <label><input type="checkbox" value="B2C - OMS">B2C - OMS</label>
                <label><input type="checkbox" value="Linx Promo">Linx Promo</label>
                <label><input type="checkbox" value="Vitrine">Vitrine</label>
                <label><input type="checkbox" value="Venda Fácil Mobile">Venda Fácil Mobile</label>
                <label><input type="checkbox" value="QR Linx">QR Linx</label>
                <label><input type="checkbox" value="CRM&Bônus">CRM&Bônus</label>
                <label><input type="checkbox" value="Integração Correios (Terceiro N49)">Integração Correios (Terceiro N49)</label>
                <label><input type="checkbox" value="Link de Pagamento (Linx PayHub)">Link de Pagamento (Linx PayHub)</label>
                <label><input type="checkbox" value="Meu Crediário">Meu Crediário</label>
                <label><input type="checkbox" value="Catálogo Digital">Catálogo Digital</label>
                <label><input type="checkbox" value="Visiolens">Visiolens</label>
                <label><input type="checkbox" value="Crediário Fácil">Crediário Fácil</label>
                <label><input type="checkbox" value="Multimarca">Multimarca</label>
                <label><input type="checkbox" value="Beauty">Beauty</label>
                <label><input type="checkbox" value="Analytic Ways">Analytic Ways</label>
                <label><input type="checkbox" value="B2C - E-commerce Terceiros">B2C - E-commerce Terceiros</label>
                <label><input type="checkbox" value="B2C - Linx Commerce">B2C - Linx Commerce</label>
                <label><input type="checkbox" value="B2C - Plugg To">B2C - Plugg To</label>
                <label><input type="checkbox" value="B2C - Smart Sales">B2C - Smart Sales</label>
                <label><input type="checkbox" value="B2C - Neomode">B2C - Neomode</label>
                <label><input type="checkbox" value="Bus Carrier">Bus Carrier</label>
                <label><input type="checkbox" value="POS Connect">POS Connect</label>
                <label><input type="checkbox" value="B2C - Conectme">B2C - Conectme</label>
                <label><input type="checkbox" value="Split de Pagamento">Split de Pagamento</label>
              </div>

              <label>Plano Comercial *</label>
              <select id="plano-comercial" required>
                <option value="">Selecione o Plano Comercial</option>
                <option value="Microvix GO">Microvix GO</option>
                <option value="Microvix Full">Microvix Full</option>
                <option value="Microvix Go + Óptico">Microvix Go + Óptico</option>
                <option value="Microvix Full + Óptico">Microvix Full + Óptico</option>
              </select>
              
              <label>Gerente do Projeto</label>
              <input type="text" id="gerente">
              
              <label>Gerente do Projeto</label>
<input type="text" id="gerente">

<label>Time Responsável <span style="color: #ef4444;">*</span></label>
<select id="time-responsavel" required style="padding: 10px; border-radius: 6px; border: 1px solid #4b5563; background: #1f2937; color: #e5e7eb;">
  <option value="">Selecione o time</option>
  <option value="SMB">🏪 SMB - Small & Medium Business</option>
  <option value="BASE">📊 BASE - Base de Clientes</option>
  <option value="KA">⭐ KA - Key Accounts</option>
</select>

              <div class="section-header" style="margin-top: 20px;">
                <h3>Usuários do Sistema</h3>
              </div>

              <label>Usuário 1</label>
              <input type="text" id="usuario-admin" placeholder="Login / Senha">

              <label>Usuário 2</label>
              <input type="text" id="usuario-gerente" placeholder="Login / Senha">

              <label>Usuário 3</label>
              <input type="text" id="usuario-caixa" placeholder="Login / Senha">

              <label>Usuário 4</label>
              <input type="text" id="usuario-estoque" placeholder="Login / Senha">

              <label>Usuário 5</label>
              <input type="text" id="usuario-financeiro" placeholder="Login / Senha">

              <!-- ADICIONE ESTE NOVO CAMPO: -->
              <label>Usuário 6</label>
              <input type="text" id="usuario-sexto" placeholder="Login / Senha">

              <label>Ambiente</label>
              <select id="ambiente">
                <option value="">Selecione</option>
                <option value="Produção">Produção</option>
                <option value="Homologação">Homologação</option>
              </select>
              
              <label>Série de NF-e</label>
              <input type="text" id="serie-nfe" placeholder="Ex: 1">
              
              <label>Série de NFC-e</label>
              <input type="text" id="serie-nfce" placeholder="Ex: 1">
              
              <div class="section-header" style="margin-top: 20px;">
                <h3>Informações de Contato do Cliente</h3>
              </div>
                              
              <label>Contato</label>
              <input 
                type="email" 
                id="contato-email" 
                placeholder="contato@empresa.com"
                onblur="validarEmailCampo(this)"
              >

              <label>Telefone</label>
              <input type="text" id="contato-telefone" placeholder="Ex: 27 99912-8508">
              
              <div class="section-header" style="margin-top: 20px;">
                <h3>Equipe Linx Responsável</h3>
              </div>
              
              <div id="equipe-container">
                <div class="equipe-item">
                  <label>Analista</label>
                  <input type="text" class="equipe-nome" placeholder="Nome do Analista">
                  <label>E-mail</label>
                  <input type="email" class="equipe-email" placeholder="email@linx.com.br">
                  <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">Remover</button>
                </div>
              </div>
              <button type="button" class="btn btn-success" onclick="adicionarMembroEquipe()">Adicionar Membro da Equipe</button>
              
              <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Salvar</button>
            </form>
          </div>

          <!-- TAB: GERENCIAR IMPLANTAÇÕES -->
          <div id="implantacoes" class="tab-content">
            <div class="section-header">
              <h3>Gerenciar Implantações</h3>
              <button class="btn btn-primary" onclick="forceReloadImplantacoes()" style="margin-left: 10px;">Atualizar Lista</button>
            </div>
            <div id="lista-implantacoes"></div>
          </div>

          <!-- TAB: TREINAMENTOS -->
          <div id="treinamentos" class="tab-content">
            <div class="section-header">
              <h3>Gerenciar Treinamentos</h3>
            </div>
            <div id="lista-treinamentos"></div>
          </div>

         <!-- TAB: CHECKLIST -->
<div id="checklist" class="tab-content">
  <div id="checklist-container">
    <p>Selecione uma implantação na aba "Gerenciar Implantações" para acompanhar seu checklist.</p>
  </div>
</div>
         <!-- TAB: TERMO DE ENCERRAMENTO -->
<div id="termo" class="tab-content">
  <div class="section-header">
    <h3>Gerar Termo de Encerramento</h3>
  </div>
  <div id="termo-container" style="background:transparent;">
    <p style="color:#9ca3af;">Selecione uma implantação para gerar o termo de encerramento:</p>
    <div id="lista-projetos-termo"></div>
  </div>
</div>

          <!-- TAB: CONFIGURAÇÕES -->
          <div id="configuracoes" class="tab-content">
            <div class="section-header">
              <h3>Configurações do Sistema</h3>
          </div>

          <!-- SEÇÃO DE BACKUPS -->
  <div class="editar-checklist" style="margin-bottom: 30px;">
    <h3>🔄 Backups Automáticos</h3>
    <p style="color: #9ca3af; margin-bottom: 15px;">
      O sistema cria backups automáticos a cada 30 minutos. Você pode restaurar qualquer um dos 5 últimos backups disponíveis.
    </p>
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
      <button class="btn btn-primary" onclick="exibirBackups()">
        📋 Ver Backups Disponíveis
      </button>
      <button class="btn btn-success" onclick="criarBackupManual()">
        💾 Criar Backup Manual
      </button>
    </div>
    
    <div id="lista-backups" style="margin-top: 20px;"></div>
  </div>
  
  <!-- SEÇÃO DE HISTÓRICO -->
  <div class="editar-checklist" style="margin-bottom: 30px;">
    <h3>📜 Histórico de Alterações</h3>
    <p style="color: #9ca3af; margin-bottom: 15px;">
      Registro de todas as ações realizadas no sistema (últimas 50 ações)
    </p>
    
    <button class="btn btn-primary" onclick="exibirHistorico()">
      📖 Ver Histórico Completo
    </button>
    
    <div id="container-historico" style="margin-top: 20px; max-height: 500px; overflow-y: auto;"></div>
  </div>

            <!-- TEMPLATE DO TERMO -->
            <div class="editar-checklist" style="background:linear-gradient(145deg, rgba(59,130,246,0.1), rgba(37,99,235,0.2));">
              <h3>Template do Termo de Encerramento</h3>
              <p style="margin-bottom:10px;">Cole seu template do Outlook abaixo e adicione as tags onde necessário:</p>
              <div style="background:rgba(17,24,39,0.8);padding:15px;border-radius:8px;margin:15px 0;font-size:13px;border:1px solid rgba(59,130,246,0.3);">
  <strong style="color:#60a5fa;font-size:14px;">Tags Disponíveis (copie e cole no editor):</strong><br><br>
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;color:#d1d5db;">
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{LOJA}}')">{{LOJA}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{CNPJ}}')">{{CNPJ}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{PORTAL}}')">{{PORTAL}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{CONTATO}}')">{{CONTATO}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{TELEFONE}}')">{{TELEFONE}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{USUARIOS}}')">{{USUARIOS}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{USUARIO_1}}')">{{USUARIO_1}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{USUARIO_2}}')">{{USUARIO_2}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{USUARIO_3}}')">{{USUARIO_3}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{USUARIO_4}}')">{{USUARIO_4}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{USUARIO_5}}')">{{USUARIO_5}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{USUARIO_6}}')">{{USUARIO_6}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{AMBIENTE}}')">{{AMBIENTE}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{SERIE_NFE}}')">{{SERIE_NFE}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{SERIE_NFCE}}')">{{SERIE_NFCE}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{PLANO}}')">{{PLANO}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{MODULOS}}')">{{MODULOS}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{MODULO_1}}')">{{MODULO_1}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{MODULO_2}}')">{{MODULO_2}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{MODULO_3}}')">{{MODULO_3}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{MODULO_4}}')">{{MODULO_4}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{MODULO_5}}')">{{MODULO_5}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{MODULO_6}}')">{{MODULO_6}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{MODULO_7}}')">{{MODULO_7}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{MODULO_8}}')">{{MODULO_8}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{EQUIPE}}')">{{EQUIPE}}</code>
    <code style="background:rgba(124,58,237,0.2);padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="copiarTag('{{TREINAMENTOS}}')">{{TREINAMENTOS}}</code>
  </div>
  
  <p style="margin-top:10px;font-size:11px;color:#9ca3af;">Dica: Clique em uma tag para copiá-la, depois cole no editor onde desejar</p>
</div>
              <label style="display:block;margin:10px 0;font-weight:600;color:#60a5fa;">Editor Visual (Cole do Outlook aqui):</label>

<!-- AVISO -->
<div style="background:rgba(59,130,246,0.1);border-left:3px solid #3b82f6;padding:12px;border-radius:6px;margin-bottom:15px;">
  <p style="color:#93c5fd;font-size:12px;margin:0;display:flex;align-items:center;gap:8px;">
    <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <path d="M12 16v-4M12 8h.01"></path>
    </svg>
    <span><strong>Dica:</strong> Ao colar do Outlook/Gmail, a formatação estranha será removida automaticamente.</span>
  </p>
</div>

<!-- EDITOR -->
<div id="template-termo-visual" 
     contenteditable="true" 
     style="width:100%;
            min-height:800px;
            max-height:1200px;
            height:auto;
            overflow-y:auto;
            padding:30px;
            background:white;
            color:#000;
            border:2px solid #374151;
            border-radius:8px;
            font-family:'Calibri','Segoe UI',sans-serif;
            font-size:11pt;
            line-height:1.6;">
</div>

<!-- Continua com os botões -->
              <div style="display:flex;gap:10px;margin-top:15px;flex-wrap:wrap;">
  <button class="btn btn-primary" onclick="salvarTemplateTermoVisual()">💾 Salvar Template</button>
  <button class="btn btn-warning" onclick="restaurarTemplateOriginal()">🔄 Restaurar Original</button>
</div>
            </div>
            
            <!-- CHECKLIST PADRÃO -->
            <div class="editar-checklist">
              <h3>Editar Checklist Padrão</h3>
              <p>Customize os itens do checklist padrão que serão aplicados a todas as implantações:</p>
              <div id="editor-checklist-padrao"></div>
              <div class="checklist-editor">
                <input type="text" id="novo-item-checklist" placeholder="Digite um novo item do checklist...">
                <button class="btn btn-success" onclick="adicionarItemChecklist()">Adicionar</button>
              </div>
              <button class="btn btn-primary" onclick="salvarChecklistPadrao()">Salvar</button>
            </div>

            <!-- CHECKLIST ÓPTICO -->
            <div class="editar-checklist checklist-optico">
              <h3>Editar Checklist Óptico</h3>
              <p>Customize os itens do checklist específico para implantações com planos ópticos:</p>
              <div id="editor-checklist-optico"></div>
              <div class="checklist-editor">
                <input type="text" id="novo-item-checklist-optico" placeholder="Digite um novo item do checklist óptico...">
                <button class="btn btn-success" onclick="adicionarItemChecklistOptico()">Adicionar</button>
              </div>
              <button class="btn btn-success" onclick="salvarChecklistOptico()">Salvar</button>
            </div>
          </div>
          
        </div> <!-- Fechamento do .container -->
      </div> <!-- Fechamento do .content-area -->
    </main> <!-- Fechamento do main -->

  <!-- MODAL DE PERFIL -->
<div class="profile-modal" id="profile-modal">
  <div class="profile-content">
    <button class="profile-close" onclick="fecharPerfil()">×</button>
    
    <div class="profile-photo-section">
      <div class="profile-avatar-large" id="profile-avatar-large">
        A
      </div>
      <button class="profile-photo-upload-btn" onclick="document.getElementById('profile-photo-input').click()" title="Alterar foto">
        📷
      </button>
      <button class="profile-photo-remove-btn" id="profile-photo-remove-btn" onclick="removerFotoPerfil()" title="Remover foto">
        ×
      </button>
      <input type="file" id="profile-photo-input" accept="image/*" style="display:none;" onchange="handleProfilePhotoUpload(event)">
    </div>
    
    <div style="text-align:center; margin-bottom:30px;">
      <h3 style="color:#7c3aed; margin:0;" id="profile-name">Admin</h3>
      <p style="color:#9ca3af; font-size:13px; margin:5px 0;">Administrador do Sistema</p>
    </div>
    
    <div class="profile-stats">
      <div class="profile-stat">
        <div class="profile-stat-value" id="profile-total-projects">0</div>
        <div class="profile-stat-label">Projetos</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value" id="profile-completed">0</div>
        <div class="profile-stat-label">Concluídos</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value" id="profile-in-progress">0</div>
        <div class="profile-stat-label">Em Andamento</div>
      </div>
    </div>
    
    <div class="profile-info-group">
      <div class="profile-label">Usuário</div>
      <div class="profile-value" id="profile-username">admin</div>
    </div>
    
    <div class="profile-info-group">
      <div class="profile-label">Membro desde</div>
      <div class="profile-value" id="profile-member-since">Janeiro 2025</div>
    </div>
    
    <div class="profile-info-group">
      <div class="profile-label">Último acesso</div>
      <div class="profile-value" id="profile-last-access">Hoje, 14:30</div>
    </div>
    
    <button class="btn btn-primary" onclick="fecharPerfil()" style="width:100%; margin-top:20px;">Fechar</button>
  </div>
</div>
</div>

<script>
// ===== ESTADO GLOBAL DA APLICAÇÃO =====
const AppState = {
  usuarios: [],
  implantacoes: [],
  treinamentos: {},
  checklistPadrao: [],
  checklistOptico: [],
  checklistStatus: {},
  implantacaoAtualId: null,
  logoAtual: null,
  editandoId: null,
  templateTermo: null,
  checklistFilter: 'none'
};

// ⬇️⬇️⬇️ ADICIONE AQUI ⬇️⬇️⬇️
// ===== SISTEMA DE BACKUP AUTOMÁTICO =====

// ===== FUNÇÕES DE BACKUP E HISTÓRICO =====

function criarBackupManual() {
  const data = {
    implantacoes: AppState.implantacoes,
    usuarios: AppState.usuarios,
    checklistStatus: AppState.checklistStatus,
    treinamentos: AppState.treinamentos,
    checklistPadrao: AppState.checklistPadrao,
    checklistOptico: AppState.checklistOptico,
    timestamp: new Date().toISOString(),
    versao: '1.0',
    tipo: 'manual'
  };
  
  const backupKey = 'sgi_backup_manual_' + Date.now();
  localStorage.setItem(backupKey, JSON.stringify(data));
  
  showToast('✅ Backup manual criado com sucesso!', 'success');
  exibirBackups(); // Atualiza a lista
}

function exibirBackups() {
  const backups = listarBackups();
  const container = document.getElementById('lista-backups');
  
  if (backups.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #9ca3af; background: rgba(17, 24, 39, 0.6); border-radius: 8px;">
        <div style="font-size: 48px; margin-bottom: 10px;">📦</div>
        <p>Nenhum backup disponível ainda.</p>
        <p style="font-size: 12px;">O primeiro backup será criado automaticamente em alguns minutos.</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = `
    <div style="background: rgba(17, 24, 39, 0.6); padding: 15px; border-radius: 8px;">
      <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(124, 58, 237, 0.3);">
        <strong style="color: #7c3aed;">Total de Backups: ${backups.length}</strong>
      </div>
      ${backups.map((b, i) => {
        const isManual = b.key.includes('manual');
        return `
          <div style="
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            margin: 8px 0; 
            background: rgba(31, 41, 55, 0.8); 
            border-radius: 6px;
            border-left: 3px solid ${isManual ? '#10b981' : '#7c3aed'};
          ">
            <div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <strong style="color: #e5e7eb;">${isManual ? '💾' : '🔄'} Backup ${i + 1}</strong>
                ${isManual ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">MANUAL</span>' : '<span style="background: #7c3aed; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">AUTO</span>'}
              </div>
              <small style="color: #9ca3af;">📅 ${b.data}</small>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-warning btn-sm" onclick="if(confirm('⚠️ Deseja realmente restaurar este backup?\\n\\nISSO IRÁ SOBRESCREVER TODOS OS DADOS ATUAIS!')) restaurarBackup('${b.key}')">
                ↩️ Restaurar
              </button>
              <button class="btn btn-danger btn-sm" onclick="if(confirm('Deseja excluir este backup?')) excluirBackup('${b.key}')">
                🗑️
              </button>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function excluirBackup(backupKey) {
  localStorage.removeItem(backupKey);
  showToast('Backup excluído!', 'info');
  exibirBackups();
}

function exibirHistorico() {
  const container = document.getElementById('container-historico');
  const historico = AppState.historicoAlteracoes || [];
  
  if (historico.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #9ca3af; background: rgba(17, 24, 39, 0.6); border-radius: 8px;">
        <div style="font-size: 48px; margin-bottom: 10px;">📜</div>
        <p>Nenhum registro ainda.</p>
        <p style="font-size: 12px;">As ações realizadas aparecerão aqui.</p>
      </div>
    `;
    return;
  }
  
  const icones = {
    criacao: '➕',
    edicao: '✏️',
    exclusao: '🗑️',
    golive: '🚀',
    checklist: '✅'
  };
  
  const cores = {
    criacao: '#10b981',
    edicao: '#f59e0b',
    exclusao: '#ef4444',
    golive: '#7c3aed',
    checklist: '#3b82f6'
  };
  
  container.innerHTML = `
    <div style="background: rgba(17, 24, 39, 0.6); padding: 15px; border-radius: 8px;">
      <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(124, 58, 237, 0.3);">
        <strong style="color: #7c3aed;">Últimas 50 Ações</strong>
      </div>
      ${historico.slice(0, 50).map(reg => `
        <div style="
          background: rgba(31, 41, 55, 0.8);
          padding: 12px;
          margin: 8px 0;
          border-radius: 8px;
          border-left: 3px solid ${cores[reg.tipo] || '#7c3aed'};
        ">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <span style="font-size: 18px; margin-right: 8px;">${icones[reg.tipo] || '📝'}</span>
              <strong style="color: #e5e7eb;">${reg.descricao}</strong>
              <div style="font-size: 12px; color: #9ca3af; margin-top: 5px;">
                👤 ${reg.usuario || 'Sistema'} • 📅 ${reg.data}
              </div>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function backupAutomatico() {
  setInterval(() => {
    const data = {
      implantacoes: AppState.implantacoes,
      usuarios: AppState.usuarios,
      checklistStatus: AppState.checklistStatus,
      treinamentos: AppState.treinamentos,
      checklistPadrao: AppState.checklistPadrao,
      checklistOptico: AppState.checklistOptico,
      timestamp: new Date().toISOString(),
      versao: '1.0'
    };
    
    const backupKey = 'sgi_backup_' + Date.now();
    localStorage.setItem(backupKey, JSON.stringify(data));
    
    // Manter apenas os 5 últimos backups
    const backups = Object.keys(localStorage).filter(k => k.startsWith('sgi_backup_'));
    if (backups.length > 5) {
      backups.sort().slice(0, -5).forEach(k => localStorage.removeItem(k));
    }
    
    console.log('✅ Backup automático realizado:', new Date().toLocaleString('pt-BR'));
    adicionarNotificacao('success', 'Backup automático realizado com sucesso', 'Sistema');
  }, 1800000); // 30 minutos
}

function restaurarBackup(backupKey) {
  try {
    const backup = JSON.parse(localStorage.getItem(backupKey));
    if (backup) {
      AppState.implantacoes = backup.implantacoes || [];
      AppState.usuarios = backup.usuarios || [];
      AppState.checklistStatus = backup.checklistStatus || {};
      AppState.treinamentos = backup.treinamentos || {};
      AppState.checklistPadrao = backup.checklistPadrao || [];
      AppState.checklistOptico = backup.checklistOptico || [];
      
      salvarNoStorage();
      showToast('Backup restaurado com sucesso!', 'success');
      location.reload();
    }
  } catch (error) {
    showToast('Erro ao restaurar backup!', 'error');
  }
}

function listarBackups() {
  const backups = Object.keys(localStorage)
    .filter(k => k.startsWith('sgi_backup_'))
    .map(k => {
      const timestamp = parseInt(k.replace('sgi_backup_', ''));
      return {
        key: k,
        data: new Date(timestamp).toLocaleString('pt-BR'),
        timestamp: timestamp
      };
    })
    .sort((a, b) => b.timestamp - a.timestamp);
  
  return backups;
}
// ⬆️⬆️⬆️ ATÉ AQUI ⬆️⬆️⬆️

// ⭐ ADICIONE ESTA LINHA:
let chartInstance = null; // Instância global do gráfico

// ===== SISTEMA DE NOTIFICAÇÕES =====
// ✅ ADICIONAR ao NotificationSystem
const NotificationSystem = {
  notificacoes: [],
  descartadas: new Set(),
  
  init() {
    this.carregarNotificacoes();
    this.carregarDescartadas();
    this.limparAntigas(); // ✅ NOVO: Limpar notificações antigas
  },
  
  // ✅ ADICIONAR NOVA FUNÇÃO
  limparAntigas() {
    const DIAS_MANTER = 30; // Manter notificações por 30 dias
    const agora = new Date();
    
    this.notificacoes = this.notificacoes.filter(notif => {
      const dataNotif = new Date(notif.timestamp);
      const diffDias = Math.floor((agora - dataNotif) / (1000 * 60 * 60 * 24));
      return diffDias <= DIAS_MANTER;
    });
    
    this.salvarNotificacoes();
  },
  
  carregarNotificacoes() {
    const saved = localStorage.getItem('notificacoes');
    if (saved) {
      this.notificacoes = JSON.parse(saved);
    }
  },
  
  carregarDescartadas() {
    const saved = localStorage.getItem('notificacoesDescartadas');
    if (saved) {
      this.descartadas = new Set(JSON.parse(saved));
    }
  },
  
  salvarNotificacoes() {
    localStorage.setItem('notificacoes', JSON.stringify(this.notificacoes));
  },
  
  salvarDescartadas() {
    localStorage.setItem('notificacoesDescartadas', JSON.stringify([...this.descartadas]));
  },
  
  gerarChaveUnica(notif) {
    // Gera chave única baseada no conteúdo da notificação
    return `${notif.tipo}-${notif.implantacaoId}-${notif.texto}`;
  },
  
  foiDescartada(notif) {
    const chave = this.gerarChaveUnica(notif);
    return this.descartadas.has(chave);
  },
  
  adicionarNotificacao(notif) {
    const chave = this.gerarChaveUnica(notif);
    
    // Não adicionar se foi descartada
    if (this.descartadas.has(chave)) {
      return;
    }
    
    // Verificar se já existe
    const existe = this.notificacoes.find(n => this.gerarChaveUnica(n) === chave);
    
    if (!existe) {
      this.notificacoes.push({
        id: Date.now() + Math.random(),
        chaveUnica: chave,
        ...notif,
        lida: false,
        timestamp: new Date().toISOString()
      });
      this.salvarNotificacoes();
    }
  },
  
  marcarComoLida(id) {
    const notif = this.notificacoes.find(n => n.id === id);
    if (notif) {
      notif.lida = true;
      this.salvarNotificacoes();
    }
  },
  
  excluirNotificacao(id) {
    const notif = this.notificacoes.find(n => n.id === id);
    if (notif) {
      // Adicionar à lista de descartadas
      const chave = notif.chaveUnica || this.gerarChaveUnica(notif);
      this.descartadas.add(chave);
      this.salvarDescartadas();
      
      // Remover da lista de notificações
      this.notificacoes = this.notificacoes.filter(n => n.id !== id);
      this.salvarNotificacoes();
    }
  },
  
  limparTodas() {
    // Marcar todas as notificações atuais como descartadas
    this.notificacoes.forEach(notif => {
      const chave = notif.chaveUnica || this.gerarChaveUnica(notif);
      this.descartadas.add(chave);
    });
    this.salvarDescartadas();
    
    // Limpar lista de notificações
    this.notificacoes = [];
    this.salvarNotificacoes();
  },
  
  limparDescartadas() {
    // Usar com cuidado - limpa histórico de descartadas
    this.descartadas.clear();
    this.salvarDescartadas();
  },
  
  obterNaoLidas() {
    return this.notificacoes.filter(n => !n.lida).length;
  }
};
// ===== FIM DO SISTEMA DE NOTIFICAÇÕES =====

// ===== INICIALIZAÇÃO =====



function inicializarVariaveis() {
  let usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
  
  // Se não existir nenhum usuário, cria o admin com data atual
  if(usuarios.length === 0) {
    usuarios = [{
      user: "admin", 
      pass: "Admin@123",
      dataCriacao: new Date().toISOString()
    }];
  } else {
    // Adiciona dataCriacao aos usuários antigos que não têm
    usuarios = usuarios.map(u => {
      if(!u.dataCriacao) {
        u.dataCriacao = new Date().toISOString();
      }
      return u;
    });
  }
  
  AppState.usuarios = usuarios;
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  
  AppState.implantacoes = JSON.parse(localStorage.getItem("implantacoes")) || [];
  AppState.treinamentos = JSON.parse(localStorage.getItem("treinamentos")) || {};
  AppState.checklistStatus = JSON.parse(localStorage.getItem("checklistStatus")) || {};

  AppState.checklistPadrao = JSON.parse(localStorage.getItem("checklistPadrao")) || [
    "Acesso ao Bighost",
    "Acesso ao Portal do Cliente",
    "Validações Iniciais - Verifique se o portal está ativo",
    "Módulos liberados conforme OP",
    "Dados da Empresa - Nome, CNPJ, Endereço e Tributação",
    "Certificado Digital - Upload A1/A3",
    "Cadastro do CSC",
    "Usuários - Cadastrar e configurar",
    "Configuração Tributária",
    "Cadastro de Vendedores/Compradores",
    "Cadastro de Adquirência",
    "Planos de Pagamento",
    "Série Própria",
    "Série de Entrada",
    "Importação Automática de NF-e",
    "Parâmetros Globais - Estoque",
    "Faturamento Gerais",
    "Faturamento NFC-e",
    "POS",
    "Faturamento Frente de Loja",
    "Acesso Restrito - Estoque",
    "Faturamento NF-e Microvix",
    "NFC-e / SAT – Parâmetros Gerais"
  ];

  AppState.checklistOptico = JSON.parse(localStorage.getItem("checklistOptico")) || [
    "CheckList – Parametrizações Ótica",
    "Acesso Restrito - Configurações do Ramo Óptico",
    "Faturamento - Habilitar Utiliza venda futura no orçamento",
    "Faturamento - Habilitar Utiliza rotina de desfazimento de negócio",
    "POS - Habilitar Utiliza DAV",
    "POS - Habilitar Utiliza Pré-Venda",
    "POS - Habilitar Utiliza antecipação financeira",
    "POS - Grupo Entrega Futura",
    "Natureza de Operação - REMESSA FAT. ANTECIPADO",
    "Natureza de Operação - VENDA COM FATURAMENTO ANTECIPADO",
    "Cadastrar ambas as Naturezas",
    "Série Própria - Cadastrar Série para NF de Antecipação",
    "Série será vinculada na rotina Configurações do Ramo Óptico"
  ];
  
  AppState.templateTermo = localStorage.getItem("templateTermo") || obterTemplateOriginal();
  AppState.implantacaoAtualId = null;
  AppState.logoAtual = null;
}

// ===== TEMPLATE ORIGINAL DO TERMO =====
function obterTemplateOriginal() {
  return `<h2>TERMO DE ENCERRAMENTO DE IMPLANTAÇÃO</h2>

<p>Prezado(a) Cliente,</p>

<p>É com satisfação que informamos a conclusão da implantação do sistema <strong>Linx Microvix</strong> em sua empresa. Segue abaixo o resumo das informações do projeto:</p>

<h3>📋 Dados da Empresa</h3>
<table>
  <tr>
    <td style="width:200px;"><strong>Loja:</strong></td>
    <td>{{LOJA}}</td>
  </tr>
  <tr>
    <td><strong>CNPJ:</strong></td>
    <td>{{CNPJ}}</td>
  </tr>
  <tr>
    <td><strong>Portal/Empresa:</strong></td>
    <td>{{PORTAL}}</td>
  </tr>
  <tr>
    <td><strong>Contato:</strong></td>
    <td>{{CONTATO}}</td>
  </tr>
  <tr>
    <td><strong>Telefone:</strong></td>
    <td>{{TELEFONE}}</td>
  </tr>
</table>

<h3>🔐 Informações de Acesso</h3>
{{USUARIOS}}

<h3>⚙️ Configurações do Sistema</h3>
<table>
  <tr>
    <td style="width:200px;"><strong>Ambiente:</strong></td>
    <td>{{AMBIENTE}}</td>
  </tr>
  <tr>
    <td><strong>Série de NF-e:</strong></td>
    <td>{{SERIE_NFE}}</td>
  </tr>
  <tr>
    <td><strong>Série de NFC-e:</strong></td>
    <td>{{SERIE_NFCE}}</td>
  </tr>
</table>

<h3>📦 Módulos Contratados</h3>
{{MODULOS}}

<h3>👥 Equipe Responsável</h3>
<table>
{{EQUIPE}}
</table>

<h3>🎓 Treinamentos Realizados</h3>
{{TREINAMENTOS}}

<h3>✅ Conclusão</h3>
<p>A implantação foi concluída com sucesso em <strong>{{DATA_CRIACAO}}</strong>. Todos os módulos contratados foram configurados e testados.</p>

<p>Nossa equipe de suporte permanece à disposição para quaisquer dúvidas ou necessidades futuras.</p>

<div class="termo-assinatura">
  <p><strong>Atenciosamente,</strong></p>
  <p><strong>{{GERENTE}}</strong><br>
  Gerente de Projetos - Linx Sistemas<br>
  {{DATA_HOJE}}</p>
</div>`;
}

// ===== FUNÇÕES DE ARMAZENAMENTO =====
let saveTimeout = null;

function salvarNoStorage(imediato = false) {
  if(imediato) {
    executarSalvamento();
  } else {
    // Debounce: aguarda 500ms sem mudanças antes de salvar
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(executarSalvamento, 500);
  }
}

function executarSalvamento() {
  try {
    // Salvar em batch (mais rápido)
    const dados = {
      usuarios: AppState.usuarios,
      implantacoes: AppState.implantacoes,
      checklistStatus: AppState.checklistStatus,
      treinamentos: AppState.treinamentos,
      checklistPadrao: AppState.checklistPadrao,
      checklistOptico: AppState.checklistOptico,
      checklistFilter: AppState.checklistFilter
    };

// Salvar cada item
    Object.entries(dados).forEach(([key, value]) => {
      localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
    });
    
    return true;
  } catch (error) {
    console.error("Erro ao salvar dados:", error);
    
    // Verificar se é erro de quota excedida
    if(error.name === 'QuotaExceededError') {
      showToast("Armazenamento cheio! Exporte seus dados e limpe o histórico.", "error");
    } else {
      showToast("Erro ao salvar dados no navegador!", "error");
    }
    
    return false;
  }
}

function carregarDoStorage() {
  try {
    const implantacoesStorage = localStorage.getItem("implantacoes");
    const checklistStorage = localStorage.getItem("checklistStatus");
    const treinamentosStorage = localStorage.getItem("treinamentos");
    const checklistPadraoStorage = localStorage.getItem("checklistPadrao");
    const checklistOpticoStorage = localStorage.getItem("checklistOptico");
    const checklistFilterStorage = localStorage.getItem("checklistFilter");
    
    if (implantacoesStorage) AppState.implantacoes = JSON.parse(implantacoesStorage);
    if (checklistStorage) AppState.checklistStatus = JSON.parse(checklistStorage);
    if (treinamentosStorage) AppState.treinamentos = JSON.parse(treinamentosStorage);
    if (checklistPadraoStorage) AppState.checklistPadrao = JSON.parse(checklistPadraoStorage);
    if (checklistOpticoStorage) AppState.checklistOptico = JSON.parse(checklistOpticoStorage);
    if (checklistFilterStorage) AppState.checklistFilter = checklistFilterStorage;
    
    corrigirStatusImplantacoes();
    return true;
  } catch (error) {
    console.error("Erro ao carregar dados:", error);
    return false;
  }
}

function corrigirStatusImplantacoes() {
  let houveMudanca = false;
  
  AppState.implantacoes.forEach(imp => {
    const progressoChecklist = calcularProgressoImplantacao(imp.id);
    const progressoTreinamento = calcularProgressoTreinamento(imp.id);
    
    if(progressoChecklist === 100 && progressoTreinamento === 100) {
      if(imp.status !== 'Concluída') {
        imp.status = 'Concluída';
        houveMudanca = true;
      }
    } else {
      if(imp.status === 'Concluída') {
        imp.status = 'Em Andamento';
        houveMudanca = true;
      }
    }
  });
  
  if(houveMudanca) {
    salvarNoStorage();
  }
}

// ===== FUNÇÃO AUXILIAR PARA DATAS =====
function formatarDataLocal(dataString) {
  if(!dataString) return 'Não informada';
  
  try {
    // Normalizar para Date
    let data;
    
    if(dataString.includes('-') && dataString.length === 10) {
      // ISO: YYYY-MM-DD
      data = new Date(dataString + 'T12:00:00');
    } else if(dataString.includes('/')) {
      // BR: DD/MM/YYYY -> YYYY-MM-DD
      const [dia, mes, ano] = dataString.split('/');
      data = new Date(`${ano}-${mes}-${dia}T12:00:00`);
    } else {
      data = new Date(dataString);
    }
    
    // Validar se é data válida
    if(isNaN(data.getTime())) {
      console.warn('Data inválida:', dataString);
      return dataString;
    }
    
    return data.toLocaleDateString('pt-BR');
    
  } catch(e) {
    console.error('Erro ao formatar data:', dataString, e);
    return dataString;
  }
}

// ===== FUNÇÕES DE CHECKLIST =====
function temPlanoOptico(implantacao) {
  return implantacao.planoComercial && implantacao.planoComercial.toLowerCase().includes('óptico');
}

function obterChecklistCompleto(implantacaoId) {
  const imp = AppState.implantacoes.find(x => x.id === implantacaoId);
  if (!imp) return AppState.checklistPadrao;
  
  let checklistCompleto = [...AppState.checklistPadrao];
  
  if (temPlanoOptico(imp)) {
    checklistCompleto = checklistCompleto.concat(AppState.checklistOptico);
  }
  
  return checklistCompleto;
}

// ===== CÁLCULO DE PROGRESSO =====
function calcularProgressoImplantacao(id) {
  const status = AppState.checklistStatus[id] || {};
  const checklistCompleto = obterChecklistCompleto(id);
  
  if (checklistCompleto.length === 0) return 0;
  
  const itensCompletos = Object.values(status).filter(x => x === true).length;
  return Math.round((itensCompletos / checklistCompleto.length) * 100);
}

function calcularProgressoTreinamento(implantacaoId) {
  const treinamentosImp = AppState.treinamentos[implantacaoId] || [];
  if(treinamentosImp.length === 0) return 0;
  
  const concluidos = treinamentosImp.filter(t => t.concluido).length;
  return Math.round((concluidos / treinamentosImp.length) * 100);
}

function calcularProgressoGeral(id) {
  const progressoChecklist = calcularProgressoImplantacao(id);
  const progressoTreinamento = calcularProgressoTreinamento(id);
  const imp = AppState.implantacoes.find(x => x.id === id);
  
  let progressoBase = Math.round(((progressoChecklist + progressoTreinamento) / 2) * 0.8);
  
  if(imp && imp.goLiveRealizado) {
    progressoBase += 10;
  }
  
  if(imp && imp.termoEnviado) {
    progressoBase += 10;
  }
  
  return Math.min(progressoBase, 100);
}

// ===== AUTENTICAÇÃO COM FIREBASE =====
async function fazerLogin(event){
  event.preventDefault();
  
  const email = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();
  
  const btnLogin = document.getElementById('btn-login');
  const btnText = btnLogin.querySelector('.btn-text');
  const btnLoader = btnLogin.querySelector('.btn-loader');

  btnLogin.disabled = true;
  btnText.style.display = 'none';
  btnLoader.style.display = 'inline-block';

  if(!email || !pass) {
    showToast("Por favor, preencha email e senha!", "warning");
    btnLogin.disabled = false;
    btnText.style.display = 'inline';
    btnLoader.style.display = 'none';
    return;  
  }

  if (!email.includes('@')) {
    showToast('❌ Digite um email válido!', 'error');
    btnLogin.disabled = false;
    btnText.style.display = 'inline';
    btnLoader.style.display = 'none';
    return;
  }
  
  // ✅ VERIFICAÇÃO MELHORADA
  if (!window.firebaseAuth || !window.auth) {
    showToast('❌ Sistema de autenticação não carregado. Recarregue a página.', 'error');
    btnLogin.disabled = false;
    btnText.style.display = 'inline';
    btnLoader.style.display = 'none';
    return;
  }
  
  try {
    const { signInWithEmailAndPassword } = window.firebaseAuth;
    const userCredential = await signInWithEmailAndPassword(window.auth, email, pass);
    // ... resto do código
    const user = userCredential.user;

    // ✅ LOGIN APROVADO
    console.log('✅ Login aprovado:', user.email);
    
    localStorage.setItem("usuarioLogado", user.email);
    console.log('✅ Usuário salvo no localStorage');
    
    // Esconder login e mostrar app com logs
    const loginWrapper = document.getElementById("login-wrapper");
    const app = document.getElementById("app");
    
    console.log('🔍 Elementos encontrados:', {
      loginWrapper: !!loginWrapper,
      app: !!app
    });
    
    if (loginWrapper) {
      loginWrapper.style.display = "none";
      console.log('✅ Login escondido');
    }
    
    if (app) {
  // Forçar display block
  app.style.display = "block";
  app.style.setProperty('display', 'block', 'important');
  
  console.log('✅ App mostrado');
  console.log('📊 Display style:', app.style.display);
  console.log('📊 Display computed:', window.getComputedStyle(app).display);
  
  // Verificar se realmente mudou
  setTimeout(() => {
    const computedDisplay = window.getComputedStyle(app).display;
    console.log('🔍 Display após 100ms:', computedDisplay);
    
    if (computedDisplay === 'none') {
      console.error('❌ ERRO: CSS está bloqueando o display!');
      // Forçar com !important via style inline
      app.setAttribute('style', 'display: block !important;');
      console.log('🔧 Forçado com !important');
    }
  }, 100);
}
    
    document.body.classList.add('new-layout');
    console.log('✅ Classe adicionada');
    
    // Atualizar avatar
    const avatar = user.email.charAt(0).toUpperCase();
    const userAvatar = document.getElementById('user-avatar');
    const userNameDisplay = document.getElementById('user-name-display');
    
    if(userAvatar) {
      userAvatar.textContent = avatar;
      console.log('✅ Avatar:', avatar);
    }
    if(userNameDisplay) {
      userNameDisplay.textContent = user.email;
      console.log('✅ Nome:', user.email);
    }
    
    // Carregar sistema com proteção
    console.log('🔄 Carregando sistema...');
    
    try { carregarDoStorage(); } catch (e) { console.warn('⚠️ Storage:', e); }
    try { carregarFotoPerfilHeader(); } catch (e) { console.warn('⚠️ Foto:', e); }
    try { atualizarDashboard(); } catch (e) { console.warn('⚠️ Dashboard:', e); }
    try { carregarEditorChecklistPadrao(); } catch (e) { console.warn('⚠️ Checklist:', e); }
    try { carregarEditorChecklistOptico(); } catch (e) { console.warn('⚠️ Óptico:', e); }
    try { initUploadZone(); } catch (e) { console.warn('⚠️ Upload:', e); }
    try { initValidations(); } catch (e) { console.warn('⚠️ Validations:', e); }
    
    setTimeout(() => {
      try { initCharts(); } catch (e) { console.warn('⚠️ Charts:', e); }
      try { calcularAnalytics(); } catch (e) { console.warn('⚠️ Analytics:', e); }
      try { mostrarLembretes(); } catch (e) { console.warn('⚠️ Lembretes:', e); }
      try { verificarGoLivesAgendados(); } catch (e) { console.warn('⚠️ GoLives:', e); }
    }, 500);
    
    setTimeout(() => {
      try {
        navigateTo('dashboard');
        console.log('✅ Dashboard navegado');
      } catch (e) {
        console.error('❌ Erro navegação:', e);
      }
    }, 100);
    
    console.log('✅ Sistema carregado!');
    showToast("Login realizado com sucesso! Bem-vindo(a) " + user.email, "success");
    
  } catch (error) {
    console.error("❌ Erro no login:", error);
    
    let mensagem = 'Erro ao fazer login!';
    
    switch (error.code) {
      case 'auth/invalid-email':
        mensagem = 'Email inválido!';
        break;
      case 'auth/user-disabled':
        mensagem = 'Usuário desativado!';
        break;
      case 'auth/user-not-found':
        mensagem = 'Usuário não encontrado!';
        break;
      case 'auth/wrong-password':
        mensagem = 'Senha incorreta!';
        break;
      case 'auth/invalid-credential':
        mensagem = 'Email ou senha incorretos!';
        break;
      case 'auth/too-many-requests':
        mensagem = 'Muitas tentativas. Tente novamente mais tarde!';
        break;
      default:
        mensagem = error.message;
    }
    
    showToast(mensagem, "error");
    
  } finally {
    btnLogin.disabled = false;
    btnText.style.display = 'inline';
    btnLoader.style.display = 'none';
  }
}

function mostrarCadastro(){
  // Esconder formulário de login
  document.getElementById('form-login').style.display = 'none';
  // Mostrar formulário de cadastro
  document.getElementById('cadastro-box').style.display = 'block';
  // Focar no primeiro campo
  document.getElementById('novo-usuario').focus();
}

async function cadastrarUsuario(){
  event.preventDefault();

  const email = document.getElementById("novo-usuario").value.trim();
  const senha = document.getElementById("nova-senha").value.trim();
  const confirmarSenha = document.getElementById("confirmar-senha").value.trim(); // ADICIONAR

// ADICIONAR LOADING
  const btnCadastro = document.getElementById('btn-cadastro');
  const btnText = btnCadastro.querySelector('.btn-text');
  const btnLoader = btnCadastro.querySelector('.btn-loader');
  
  btnCadastro.disabled = true;
  btnText.style.display = 'none';
  btnLoader.style.display = 'inline-block';

  if(!email || !senha) {
    showToast("Preencha todos os campos!", "warning");
    btnCadastro.disabled = false;
    btnText.style.display = 'inline';
    btnLoader.style.display = 'none';
    return;
  }

  // ADICIONAR VALIDAÇÃO DE CONFIRMAÇÃO
  if (senha !== confirmarSenha) {
    showToast('❌ As senhas não coincidem!', 'error');
    btnCadastro.disabled = false;
    btnText.style.display = 'inline';
    btnLoader.style.display = 'none';
    return;
  }

  // Validação de email
  if (!email.includes('@')) {
    showToast('❌ Digite um email válido!', 'error');
    btnCadastro.disabled = false;
    btnText.style.display = 'inline';
    btnLoader.style.display = 'none';
    return;
  }

  // Validação de senha
  if (senha.length < 6) {
    showToast('❌ A senha deve ter no mínimo 6 caracteres!', 'error');
    btnCadastro.disabled = false;
    btnText.style.display = 'inline';
    btnLoader.style.display = 'none';
    return;
  }
  
  try {
    const auth = window.auth;
    
    if (!auth) {
      throw new Error('Firebase Authentication não inicializado!');
    }

    // 🔐 Criar usuário no Firebase Authentication
    const { createUserWithEmailAndPassword } = window.firebaseAuth;
    const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
    const user = userCredential.user;

    showToast('✅ Usuário cadastrado com sucesso!', 'success');
    console.log('✅ Usuário criado:', user.email);
    
    document.getElementById("novo-usuario").value = "";
    document.getElementById("nova-senha").value = "";
    document.getElementById("cadastro-box").style.display = "none";

  } catch (error) {
    console.error('❌ Erro ao cadastrar:', error);
    
    // Mensagens de erro mais amigáveis
    let mensagem = 'Erro ao cadastrar usuário!';
    
    switch (error.code) {
      case 'auth/email-already-in-use':
        mensagem = 'Este email já está cadastrado!';
        break;
      case 'auth/invalid-email':
        mensagem = 'Email inválido!';
        break;
      case 'auth/operation-not-allowed':
        mensagem = 'Operação não permitida. Verifique as configurações do Firebase!';
        break;
      case 'auth/weak-password':
        mensagem = 'Senha muito fraca! Use no mínimo 6 caracteres.';
        break;
      default:
        mensagem = error.message;
    }
    
    showToast(mensagem, 'error');
    
  } finally {
    // Remover loading
    btnCadastro.disabled = false;
    btnText.style.display = 'inline';
    btnLoader.style.display = 'none';
  }
}

async function logout(){
  try {
    const auth = window.auth;
    
    if (!auth) {
      throw new Error('Firebase Authentication não inicializado!');
    }

    const { signOut } = window.firebaseAuth;
    await signOut(auth);
    
    // Limpar dados locais
    localStorage.removeItem("usuarioLogado");
    window.usuarioLogado = null;
    
    showToast('✅ Logout realizado com sucesso!', 'success');
    console.log('✅ Usuário desconectado');
    
    // Recarregar a página
    location.reload();
    
  } catch (error) {
    console.error('❌ Erro ao fazer logout:', error);
    showToast('❌ Erro ao sair: ' + error.message, 'error');
    // Mesmo com erro, force o logout
    localStorage.removeItem("usuarioLogado");
    location.reload();
  }
}

// ═══════════════════════════════════════════════════════
// 🔐 RECUPERAÇÃO DE SENHA
// ═══════════════════════════════════════════════════════

function mostrarRecuperarSenha() {
  document.getElementById('form-login').style.display = 'none';
  document.getElementById('recuperar-senha-box').style.display = 'block';
  document.getElementById('email-recuperacao').focus();
}

function voltarLogin() {
  document.getElementById('form-login').style.display = 'block';
  document.getElementById('cadastro-box').style.display = 'none';
  document.getElementById('recuperar-senha-box').style.display = 'none';
  document.getElementById('recovery-success').style.display = 'none';
  
  // Limpar campos
  document.getElementById('email-recuperacao').value = '';
  document.getElementById('novo-usuario').value = '';
  document.getElementById('nova-senha').value = '';
  document.getElementById('confirmar-senha').value = '';
}

async function enviarEmailRecuperacao(event) {
  event.preventDefault();
  
  const email = document.getElementById('email-recuperacao').value.trim();
  const btnRecuperar = document.getElementById('btn-recuperar');
  const btnText = btnRecuperar.querySelector('.btn-text');
  const btnLoader = btnRecuperar.querySelector('.btn-loader');
  
  if (!email) {
    showToast('❌ Digite seu email!', 'error');
    return;
  }
  
  if (!email.includes('@')) {
    showToast('❌ Digite um email válido!', 'error');
    return;
  }
  
  // Mostrar loading
  btnRecuperar.disabled = true;
  btnText.style.display = 'none';
  btnLoader.style.display = 'inline-block';
  
  try {
    // Importar sendPasswordResetEmail
    const { sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
    const auth = window.auth;
    
    if (!auth) {
      throw new Error('Firebase Authentication não inicializado!');
    }
    
    // Enviar email de recuperação
    await sendPasswordResetEmail(auth, email, {
      url: window.location.origin,
      handleCodeInApp: false
    });
    
    // Mostrar sucesso
    document.getElementById('form-recuperar').style.display = 'none';
    document.getElementById('recovery-success').style.display = 'block';
    
    showToast('✅ Email enviado com sucesso!', 'success', 'Verifique sua caixa de entrada');
    console.log('✅ Email de recuperação enviado para:', email);
    
  } catch (error) {
    console.error('❌ Erro ao enviar email:', error);
    
    let mensagem = 'Erro ao enviar email!';
    
    switch (error.code) {
      case 'auth/user-not-found':
        mensagem = 'Email não encontrado!';
        break;
      case 'auth/invalid-email':
        mensagem = 'Email inválido!';
        break;
      case 'auth/too-many-requests':
        mensagem = 'Muitas tentativas. Aguarde alguns minutos.';
        break;
      default:
        mensagem = error.message;
    }
    
    showToast('❌ ' + mensagem, 'error');
    
  } finally {
    // Remover loading
    btnRecuperar.disabled = false;
    btnText.style.display = 'inline';
    btnLoader.style.display = 'none';
  }
}

// ═══════════════════════════════════════════════════════
// 👁️ MOSTRAR/OCULTAR SENHA
// ═══════════════════════════════════════════════════════

function togglePassword(inputId) {
  const input = document.getElementById(inputId);
  const button = input.nextElementSibling;
  
  if (input.type === 'password') {
    input.type = 'text';
    button.textContent = '🙈';
    button.title = 'Ocultar senha';
  } else {
    input.type = 'password';
    button.textContent = '👁️';
    button.title = 'Mostrar senha';
  }
}

// ═══════════════════════════════════════════════════════
// ✅ VALIDAÇÃO EM TEMPO REAL
// ═══════════════════════════════════════════════════════

function validarForcaSenha(senha) {
  const strengthFill = document.getElementById('strength-fill');
  const strengthText = document.getElementById('strength-text');
  
  if (!strengthFill || !strengthText) return;
  
  // Limpar classes
  strengthFill.className = 'strength-fill';
  strengthText.className = 'strength-text';
  
  if (senha.length === 0) {
    strengthText.textContent = 'Digite uma senha';
    return;
  }
  
  if (senha.length < 6) {
    strengthFill.classList.add('weak');
    strengthText.classList.add('weak');
    strengthText.textContent = 'Senha muito fraca';
    return;
  }
  
  // Calcular força
  let forca = 0;
  
  // Critérios
  if (senha.length >= 8) forca++;
  if (senha.length >= 12) forca++;
  if (/[a-z]/.test(senha)) forca++;
  if (/[A-Z]/.test(senha)) forca++;
  if (/[0-9]/.test(senha)) forca++;
  if (/[^A-Za-z0-9]/.test(senha)) forca++;
  
  if (forca <= 2) {
    strengthFill.classList.add('weak');
    strengthText.classList.add('weak');
    strengthText.textContent = 'Senha fraca';
  } else if (forca <= 4) {
    strengthFill.classList.add('medium');
    strengthText.classList.add('medium');
    strengthText.textContent = 'Senha média';
  } else {
    strengthFill.classList.add('strong');
    strengthText.classList.add('strong');
    strengthText.textContent = 'Senha forte';
  }
}

function validarEmail(email, errorElementId) {
  const errorElement = document.getElementById(errorElementId);
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  
  if (!email) {
    errorElement.textContent = 'Email é obrigatório';
    return false;
  }
  
  if (!emailRegex.test(email)) {
    errorElement.textContent = 'Email inválido';
    return false;
  }
  
  errorElement.textContent = '';
  return true;
}

function validarSenha(senha, errorElementId) {
  const errorElement = document.getElementById(errorElementId);
  
  if (!senha) {
    errorElement.textContent = 'Senha é obrigatória';
    return false;
  }
  
  if (senha.length < 6) {
    errorElement.textContent = 'Senha deve ter no mínimo 6 caracteres';
    return false;
  }
  
  errorElement.textContent = '';
  return true;
}

// ===== FORMULÁRIO DE EMPRESA =====
function ajustarEmpresa() {
  const tipo = document.getElementById('empresa').value;
  const detalhes = document.getElementById('empresa-detalhes');
  
  if (tipo === 'unica') {
    detalhes.innerHTML = `
      <label>CNPJ da Empresa *</label>
      <input 
        type="text" 
        id="cnpj-unica" 
        class="cnpj-input"
        placeholder="00.000.000/0000-00"
        maxlength="18"
        required
        oninput="this.value = mascaraCNPJ(this.value)"
        onblur="validarCNPJCampoGenerico(this)"
      >
      <span class="input-error" id="cnpj-unica-error"></span>
    `;
  } else if (tipo === 'matriz') {
    detalhes.innerHTML = `
      <label>Quantidade de Empresas *</label>
      <input type="number" id="qtd-empresas" min="2" value="2" onchange="gerarCamposFiliais()">
      
      <label>CNPJ da Matriz *</label>
      <input 
        type="text" 
        id="cnpj-matriz" 
        class="cnpj-input"
        placeholder="00.000.000/0000-00"
        maxlength="18"
        required
        oninput="this.value = mascaraCNPJ(this.value)"
        onblur="validarCNPJCampoGenerico(this)"
      >
      <span class="input-error" id="cnpj-matriz-error"></span>
      
      <div id="filiais-container"></div>
    `;
    gerarCamposFiliais();
  } else {
    detalhes.innerHTML = '';
  }
}

function gerarCamposFiliais() {
  const qtd = parseInt(document.getElementById('qtd-empresas')?.value || 2);
  const container = document.getElementById('filiais-container');
  
  if (!container) return;
  
  let html = '';
  // Menos 1 porque a matriz já conta
  for (let i = 1; i < qtd; i++) {
    html += `
      <label>CNPJ da Filial ${i} *</label>
      <input 
        type="text" 
        class="cnpj-filial cnpj-input" 
        placeholder="00.000.000/0000-00"
        maxlength="18"
        required
        oninput="this.value = mascaraCNPJ(this.value)"
        onblur="validarCNPJCampoGenerico(this)"
      >
      <span class="input-error cnpj-filial-error"></span>
    `;
  }
  
  container.innerHTML = html;
}

// ===== EQUIPE =====
function adicionarMembroEquipe(nome = '', email = '') {
  const container = document.getElementById('equipe-container');
  
  const isFirstItem = container.children.length === 0;
  if(isFirstItem && !nome && !email) {
    nome = 'Guilherme Leite Reginato';
    email = 'guilherme.reginato@linx.com.br';
  }
  
  const div = document.createElement('div');
  div.className = 'equipe-item';
  div.innerHTML = `
    <label>Analista</label>
    <input type="text" class="equipe-nome" value="${nome}" placeholder="Nome do Analista">
    <label>E-mail</label>
    <input type="email" class="equipe-email" value="${email}" placeholder="email@linx.com.br">
    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">Remover</button>
  `;
  container.appendChild(div);
}

// ===== NAVEGAÇÃO - VERSÃO CORRIGIDA =====
function navigateTo(tabName, navElement) {
  console.log('🔄 Navegando para:', tabName);
  
  // 1. Remover active de todos os itens
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // 2. Remover active de todos os conteúdos
  document.querySelectorAll('.tab-content').forEach(t => {
    t.classList.remove('active', 'active-content');
  });
  
  // 3. Ativar APENAS a tab correta
  const targetTab = document.getElementById(tabName);
  if(targetTab) {
    targetTab.classList.add('active-content');
  } else {
    console.error('❌ Tab não encontrada:', tabName);
    return; // ✅ ADICIONAR EARLY RETURN
  }
  
  // 4. Ativar item correto da sidebar
  const sidebarNavItems = document.querySelectorAll('.sidebar .nav-item');
  let itemAtivado = false;
  
  sidebarNavItems.forEach(item => {
    const onclick = item.getAttribute('onclick');
    if(onclick && onclick.includes(`'${tabName}'`)) {
      item.classList.add('active');
      itemAtivado = true;
    }
  });
  
  if(!itemAtivado) {
    console.warn('⚠️ Item de navegação não encontrado para:', tabName);
  }
  
  // 5. Atualizar títulos (adicionar verificações)
  const titles = {
    'dashboard': 'Dashboard',
    'nova-implantacao': 'Nova Implantação',
    'implantacoes': 'Gerenciar Implantações',
    'treinamentos': 'Treinamentos',
    'checklist': 'Checklist',
    'termo': 'Termo de Encerramento',
    'configuracoes': 'Configurações',
    'visao-times': 'Visão por Times'
  };
  
  const breadcrumbs = {
    'dashboard': 'Início / Dashboard',
    'nova-implantacao': 'Implantações / Nova',
    'implantacoes': 'Implantações / Gerenciar',
    'treinamentos': 'Gestão / Treinamentos',
    'checklist': 'Acompanhamento / Checklist',
    'termo': 'Documentos / Termo',
    'configuracoes': 'Sistema / Configurações',
    'visao-times': 'Gestão / Visão por Times'
  };
  
  const pageTitle = document.getElementById('page-title');
  const breadcrumb = document.getElementById('breadcrumb');
  
  if(pageTitle) pageTitle.textContent = titles[tabName] || 'Sistema';
  if(breadcrumb) breadcrumb.textContent = breadcrumbs[tabName] || 'Início';
  
  // 6. Fechar elementos abertos
  const sidebar = document.getElementById('sidebar');
  if(sidebar) sidebar.classList.remove('mobile-open');
  
  const userMenu = document.getElementById('user-menu');
  if(userMenu) userMenu.classList.remove('active');
  
  // 7. Carregar dados
  try {
    carregarDoStorage();
  } catch(e) {
    console.error('Erro ao carregar storage:', e);
  }
  
  // 8. Executar ações específicas com try-catch
  try {
    switch(tabName) {
      case 'dashboard':
        atualizarDashboard();
        setTimeout(() => {
          initCharts();
          calcularAnalytics();
        }, 100);
        break;
      case 'implantacoes':
        carregarListaImplantacoes();
        break;
      case 'treinamentos':
        carregarListaTreinamentos();
        break;
      case 'checklist':
        const checklistContainer = document.getElementById('checklist-container');
        if (AppState.implantacaoAtualId) {
          carregarChecklist();
        } else if(checklistContainer) {
          checklistContainer.innerHTML = `
            <div class="implantacao-card" style="text-align:center;padding:60px 20px;">
              <div style="font-size:48px;margin-bottom:20px;opacity:0.5;">📋</div>
              <h3 style="color:#9ca3af;margin-bottom:15px;">Nenhuma implantação selecionada</h3>
              <p style="color:#6b7280;margin-bottom:30px;">Selecione uma implantação em "Gerenciar Implantações".</p>
              <button class="btn btn-primary" onclick="navigateTo('implantacoes')">
                Ir para Gerenciar Implantações
              </button>
            </div>
          `;
        }
        break;
      case 'termo':
        carregarListaProjetosTermo();
        break;
      case 'configuracoes':
        carregarEditorChecklistPadrao();
        carregarEditorChecklistOptico();
        carregarTemplateTermo();
        break;
      case 'visao-times':
        atualizarVisaoTimes('TODOS');
        break;
    }
  } catch(e) {
    console.error('Erro ao executar ação da tab:', e);
    showToast('Erro ao carregar conteúdo. Tente novamente.', 'error');
  }
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  if(sidebar) sidebar.classList.toggle('mobile-open');
}

function toggleUserMenu() {
  const menu = document.getElementById('user-menu');
  if(menu) menu.classList.toggle('active');
}

// ===== SALVAR IMPLANTAÇÃO =====
function salvarImplantacao(e){
  e.preventDefault();
  
  // Validar Time Responsável
  const timeResponsavel = document.getElementById('time-responsavel').value;
  if (!timeResponsavel) {
    showToast("❌ Por favor, selecione o Time Responsável!", "warning");
    return false;
  }
  
  const selecionados = [...document.querySelectorAll('.modulos-box input:checked')].map(i => i.value);
  let empresaInfo = "";
  const tipo = document.getElementById('empresa').value;
  
  if(tipo === "unica"){
    const cnpj = document.getElementById('cnpj-unica').value;
    if(!cnpj) {
      showToast("CNPJ da empresa é obrigatório!", "warning");
      return false;
    }

  // ⬇️ ADICIONE VALIDAÇÃO AQUI ⬇️
  if (!validarCNPJ(cnpj)) {
      showToast("CNPJ da empresa é inválido!", "error");
      document.getElementById('cnpj-unica').focus();
      return false;
    }
    // ⬆️ ATÉ AQUI ⬆️

    empresaInfo = "CNPJ: " + cnpj;
  } else if(tipo === "matriz"){
    const matriz = document.getElementById('cnpj-matriz');
    const filiais = [...document.querySelectorAll('.cnpj-filial')];
    
    if(!matriz || !matriz.value) {
      showToast("CNPJ da matriz é obrigatório!", "warning");
      return false;
    }
    
 // ⬇️ ADICIONE VALIDAÇÃO DA MATRIZ ⬇️
    if (!validarCNPJ(matriz.value)) {
      showToast("CNPJ da Matriz é inválido!", "error");
      matriz.focus();
      return false;
    }
    // ⬆️ ATÉ AQUI ⬆️

    let filiaisValues = [];
    for(let filial of filiais) {
      if(!filial.value) {
        showToast("Todos os CNPJs das filiais são obrigatórios!", "warning");
        return false;
      }

// ⬇️ ADICIONE VALIDAÇÃO DAS FILIAIS ⬇️
      if (!validarCNPJ(filial.value)) {
        showToast("CNPJ da filial '" + filial.value + "' é inválido!", "error");
        filial.focus();
        return false;
      }
      // ⬆️ ATÉ AQUI ⬆️

      filiaisValues.push(filial.value);
    }
    
    empresaInfo = 'Matriz: ' + matriz.value + ' | Filiais: ' + filiaisValues.join(", ");
  }
  
  const equipeItems = document.querySelectorAll('.equipe-item');
  const equipe = [];
  equipeItems.forEach(item => {
    const nome = item.querySelector('.equipe-nome').value.trim();
    const email = item.querySelector('.equipe-email').value.trim();
    if(nome || email) {
      equipe.push({nome: nome, email: email});
    }
  });
  
  if(AppState.editandoId) {
    const impIndex = AppState.implantacoes.findIndex(x => x.id === AppState.editandoId);
    if(impIndex !== -1) {
      AppState.implantacoes[impIndex].portal = document.getElementById('numero-portal').value;
      AppState.implantacoes[impIndex].razao = document.getElementById('razao-social').value;
      AppState.implantacoes[impIndex].empresa = tipo;
      AppState.implantacoes[impIndex].cnpjs = empresaInfo;
      AppState.implantacoes[impIndex].modulos = selecionados;
      AppState.implantacoes[impIndex].planoComercial = document.getElementById('plano-comercial').value;
      AppState.implantacoes[impIndex].gerente = document.getElementById('gerente').value;
      AppState.implantacoes[impIndex].timeResponsavel = document.getElementById('time-responsavel').value;
      AppState.implantacoes[impIndex].usuarioAdmin = document.getElementById('usuario-admin').value; 
      AppState.implantacoes[impIndex].usuarioGerente = document.getElementById('usuario-gerente').value;
      AppState.implantacoes[impIndex].usuarioCaixa = document.getElementById('usuario-caixa').value;
      AppState.implantacoes[impIndex].usuarioEstoque = document.getElementById('usuario-estoque').value;
      AppState.implantacoes[impIndex].usuarioFinanceiro = document.getElementById('usuario-financeiro').value;
      AppState.implantacoes[impIndex].ambiente = document.getElementById('ambiente').value;
      AppState.implantacoes[impIndex].serieNFe = document.getElementById('serie-nfe').value;
      AppState.implantacoes[impIndex].serieNFCe = document.getElementById('serie-nfce').value;
      AppState.implantacoes[impIndex].contatoNome = document.getElementById('contato-nome').value;
      AppState.implantacoes[impIndex].contatoTelefone = document.getElementById('contato-telefone').value;
      AppState.implantacoes[impIndex].equipe = equipe;
      
      if(AppState.logoAtual) {
        AppState.implantacoes[impIndex].logo = AppState.logoAtual;
      }
      
      const checklistCompleto = obterChecklistCompleto(AppState.editandoId);
      if(!AppState.checklistStatus[AppState.editandoId]) {
        AppState.checklistStatus[AppState.editandoId] = {};
      }
      checklistCompleto.forEach((item, idx) => {
        if(AppState.checklistStatus[AppState.editandoId][idx] === undefined) {
          AppState.checklistStatus[AppState.editandoId][idx] = false;
        }
      });
    }
    
    showToast("Implantação atualizada com sucesso! Portal: " + AppState.implantacoes[impIndex].portal, "success");
    AppState.editandoId = null;
  } else {
    const imp = {
      id: Date.now(),
      portal: document.getElementById('numero-portal').value,
      razao: document.getElementById('razao-social').value,
      empresa: tipo,
      cnpjs: empresaInfo,
      modulos: selecionados,
      planoComercial: document.getElementById('plano-comercial').value,
      gerente: document.getElementById('gerente').value,
      timeResponsavel: document.getElementById('time-responsavel').value,
      dataCriacao: new Date().toLocaleDateString('pt-BR'),
      status: 'Em Andamento',
      logo: AppState.logoAtual,
      usuarioAdmin: document.getElementById('usuario-admin').value,
      usuarioGerente: document.getElementById('usuario-gerente').value,
      usuarioCaixa: document.getElementById('usuario-caixa').value,
      usuarioEstoque: document.getElementById('usuario-estoque').value,
      usuarioFinanceiro: document.getElementById('usuario-financeiro').value,
      ambiente: document.getElementById('ambiente').value,
      serieNFe: document.getElementById('serie-nfe').value,
      serieNFCe: document.getElementById('serie-nfce').value,
      contatoNome: document.getElementById('contato-nome').value,
      contatoTelefone: document.getElementById('contato-telefone').value,
      equipe: equipe
    };
    
    AppState.implantacoes.push(imp);
    
    const checklistCompleto = obterChecklistCompleto(imp.id);
    AppState.checklistStatus[imp.id] = {};
    checklistCompleto.forEach((item, idx) => {
      AppState.checklistStatus[imp.id][idx] = false;
    });
    
    AppState.treinamentos[imp.id] = [];
    
    showToast("Implantação salva com sucesso! Portal: " + imp.portal, "success");
  }
  
  if (!salvarNoStorage()) {
    showToast("Erro ao salvar a implantação!", "error");
    return false;
  }
  
  document.getElementById("nova-implantacao-form").reset();
  document.getElementById("empresa-detalhes").innerHTML = "";
  const logoPreview = document.getElementById('logo-preview');
  if(logoPreview) logoPreview.style.display = 'none';
  const logoPreviewContainer = document.getElementById('logo-preview-container');
  if(logoPreviewContainer) {
    logoPreviewContainer.innerHTML = '';
    logoPreviewContainer.style.display = 'none';
  }
  AppState.logoAtual = null;
  
  const equipeContainer = document.getElementById('equipe-container');
  equipeContainer.innerHTML = `
    <div class="equipe-item">
      <label>Analista</label>
      <input type="text" class="equipe-nome" placeholder="Nome do Analista">
      <label>E-mail</label>
      <input type="email" class="equipe-email" placeholder="email@linx.com.br">
      <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">Remover</button>
    </div>
  `;
  
  return false;
}

// ===== LISTAR IMPLANTAÇÕES =====
function forceReloadImplantacoes() {
  carregarDoStorage();
  carregarListaImplantacoes();
}

function carregarListaImplantacoes(){
  const container = document.getElementById("lista-implantacoes");
  
  if (!container) return;
  
  carregarDoStorage();
  
  if(!AppState.implantacoes || AppState.implantacoes.length === 0){
    container.innerHTML = `
      <div class="implantacao-card" style="text-align: center; color: #9ca3af;">
        <h3>Nenhuma implantação encontrada</h3>
        <p>Crie sua primeira implantação na aba "Nova Implantação"</p>
        <button class="btn btn-primary" onclick="navigateTo('nova-implantacao')">Criar Nova Implantação</button>
      </div>
    `;
    return;
  }
  
  try {
    const htmlContent = AppState.implantacoes.map((imp) => {
      const progressoGeral = calcularProgressoGeral(imp.id);
      const progressoChecklist = calcularProgressoImplantacao(imp.id);
      const progressoTreinamento = calcularProgressoTreinamento(imp.id);
      const treinamentosImp = AppState.treinamentos[imp.id] || [];
      const isOptico = temPlanoOptico(imp);
      
      const logoHTML = imp.logo ? `<img src="${imp.logo}" class="implantacao-logo">` : '';
      
      return `
        <div class="implantacao-card">
          <div class="implantacao-header">
            ${logoHTML}
            <span>Portal: ${imp.portal || 'N/A'} - ${imp.razao || 'N/A'}</span>
          </div>
          <div class="implantacao-info"><strong>Data de Criação:</strong> ${imp.dataCriacao || "N/A"}</div>
          <div class="implantacao-info"><strong>Tipo:</strong> ${imp.empresa === 'unica' ? 'Única' : 'Matriz/Filiais'}</div>
          <div class="implantacao-info"><strong>CNPJs:</strong> ${imp.cnpjs || 'N/A'}</div>
          <div class="implantacao-info"><strong>Módulos:</strong> ${imp.modulos && imp.modulos.length > 0 ? 
            imp.modulos.slice(0, 3).join(", ") + (imp.modulos.length > 3 ? `... (+${imp.modulos.length - 3} mais)` : "") 
            : "Nenhum módulo selecionado"}</div>
          <div class="implantacao-info"><strong>Plano Comercial:</strong> ${imp.planoComercial || "Não informado"}
            ${isOptico ? '<span class="optico-badge">Inclui Óptico</span>' : ''}
          </div>
          <div class="implantacao-info"><strong>Gerente:</strong> ${imp.gerente || "Não informado"}</div>
          <div class="implantacao-info"><strong>Status:</strong> 
            <span style="color: ${imp.status === 'Concluída' ? '#10b981' : '#f59e0b'};">${imp.status || "Em Andamento"}</span>
          </div>
          
          <div class="implantacao-info"><strong>Progresso Geral do Projeto:</strong></div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${progressoGeral}%">${progressoGeral}%</div>
          </div>
          
          <button class="toggle-details" onclick="toggleProgressDetails('lista-${imp.id}', event)">
            <span class="icon">▼</span>
            <span>Ver Detalhes do Progresso</span>
          </button>
          <div class="progress-details" id="lista-${imp.id}">
            <div class="implantacao-info"><strong>Progresso do Checklist:</strong></div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progressoChecklist}%; background: linear-gradient(90deg, #7c3aed, #6d28d9);">${progressoChecklist}%</div>
            </div>
            
            <div class="implantacao-info"><strong>Progresso dos Treinamentos (${treinamentosImp.length} cadastrados):</strong></div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progressoTreinamento}%; background: linear-gradient(90deg, #f59e0b, #d97706);">${progressoTreinamento}%</div>
            </div>
          </div>
          
          <div class="actions-row">
            <button class="btn btn-warning" onclick="editarImplantacao(${imp.id})">Editar</button>
            <button class="btn btn-danger" onclick="excluirImplantacao(${imp.id})">Excluir</button>
            <button class="btn btn-primary" onclick="acompanharImplantacao(${imp.id})">Acompanhar</button>
          </div>
        </div>
      `;
    }).join("");
    
    container.innerHTML = htmlContent;
    
  } catch (error) {
    container.innerHTML = `
      <div class="implantacao-card" style="color: #ef4444;">
        <h3>Erro ao carregar implantações</h3>
        <p>Erro: ${error.message}</p>
        <button class="btn btn-primary" onclick="carregarListaImplantacoes()">Tentar Novamente</button>
      </div>
    `;
  }
}

function toggleProgressDetails(id, event) {
  const button = event ? event.currentTarget : document.querySelector(`[onclick*="${id}"]`);
  const detailsDiv = document.getElementById(id);
  
  if(detailsDiv) {
    const isExpanded = detailsDiv.classList.contains('show');
    detailsDiv.classList.toggle('show');
    
    if(button) {
      button.classList.toggle('expanded');
      const textSpan = button.querySelector('span:not(.icon)');
      if(textSpan) {
        textSpan.textContent = isExpanded ? 'Ver Detalhes do Progresso' : 'Ocultar Detalhes';
      }
    }
  }
}

// ===== EDITAR IMPLANTAÇÃO =====
function editarImplantacao(id){
  const imp = AppState.implantacoes.find(x => x.id === id);
  if(!imp) return;
  
  console.log('✏️ Editando implantação:', id);
  
  AppState.editandoId = id;
  
  // Forçar navegação para nova-implantacao
  navigateTo("nova-implantacao");
  
  // Aguardar um pouco antes de preencher os campos
  setTimeout(() => {
    if(imp.logo) {
      AppState.logoAtual = imp.logo;
      const preview = document.getElementById('logo-preview');
      if(preview) {
        preview.src = imp.logo;
        preview.style.display = 'block';
      }
      const previewContainer = document.getElementById('logo-preview-container');
      if(previewContainer) {
        previewContainer.innerHTML = `
          <div class="preview-item">
            <img src="${imp.logo}" alt="Logo preview">
            <button class="preview-remove" onclick="removeLogoPreview()">×</button>
          </div>
        `;
        previewContainer.style.display = 'flex';
      }
    }
    
    document.getElementById('numero-portal').value = imp.portal;
    document.getElementById('razao-social').value = imp.razao;
    document.getElementById('empresa').value = imp.empresa;
    
    ajustarEmpresa();
    
    if(imp.empresa === "unica"){
      setTimeout(() => {
        const cnpjField = document.getElementById('cnpj-unica');
        if(cnpjField) {
          cnpjField.value = imp.cnpjs.replace("CNPJ: ", "");
        }
      }, 100);
    } else if(imp.empresa === "matriz") {
      setTimeout(() => {
        const parts = imp.cnpjs.split(" | ");
        const matriz = parts[0] ? parts[0].replace("Matriz: ", "") : "";
        const filiaisStr = parts[1] ? parts[1].replace("Filiais: ", "") : "";
        const filiais = filiaisStr ? filiaisStr.split(", ") : [];
        
        const qtdField = document.getElementById('qtd-empresas');
        if(qtdField) {
          qtdField.value = filiais.length + 1;
          gerarCamposEmpresas();
          
          setTimeout(() => {
            const matrizField = document.getElementById('cnpj-matriz');
            if(matrizField) matrizField.value = matriz;
            
            const filiaisFields = document.querySelectorAll('.cnpj-filial');
            filiais.forEach((cnpj, idx) => {
              if(filiaisFields[idx]) {
                filiaisFields[idx].value = cnpj;
              }
            });
          }, 50);
        }
      }, 100);
    }
    
    document.getElementById('plano-comercial').value = imp.planoComercial || "";
    document.getElementById('gerente').value = imp.gerente || "";
    document.getElementById('time-responsavel').value = imp.timeResponsavel || "";
    document.getElementById('usuario-admin').value = imp.usuarioAdmin || "";
    document.getElementById('usuario-gerente').value = imp.usuarioGerente || "";
    document.getElementById('usuario-caixa').value = imp.usuarioCaixa || "";
    document.getElementById('usuario-estoque').value = imp.usuarioEstoque || "";
    document.getElementById('usuario-financeiro').value = imp.usuarioFinanceiro || "";
    document.getElementById('ambiente').value = imp.ambiente || "";
    document.getElementById('serie-nfe').value = imp.serieNFe || "";
    document.getElementById('serie-nfce').value = imp.serieNFCe || "";
    document.getElementById('contato-nome').value = imp.contatoNome || "";
    document.getElementById('contato-telefone').value = imp.contatoTelefone || "";
    
    const equipeContainer = document.getElementById('equipe-container');
    equipeContainer.innerHTML = '';
    if(imp.equipe && imp.equipe.length > 0) {
      imp.equipe.forEach(membro => {
        adicionarMembroEquipe(membro.nome, membro.email);
      });
    } else {
      adicionarMembroEquipe();
    }
    
    document.querySelectorAll('.modulos-box input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = imp.modulos.includes(checkbox.value);
    });
  }, 100);
}

// ===== EXCLUIR E ACOMPANHAR =====
function excluirImplantacao(id){
  if(confirm("Tem certeza que deseja excluir esta implantação? Esta ação não pode ser desfeita.")) {
    AppState.implantacoes = AppState.implantacoes.filter(x => x.id !== id);
    delete AppState.checklistStatus[id];
    delete AppState.treinamentos[id];
    salvarNoStorage();
    carregarListaImplantacoes();
    atualizarDashboard();
    showToast("Implantação excluída com sucesso!", "success");
  }
}

function acompanharImplantacao(id){
  console.log('🎯 Acompanhando implantação:', id);
  
  AppState.implantacaoAtualId = id;
  AppState.checklistFilter = 'none';
  
  // Forçar navegação para checklist
  navigateTo("checklist");
}

// ===== CHECKLIST =====
function carregarChecklist(){
  const container = document.getElementById('checklist-container');
  if(!container) {
    console.error('Container do checklist não encontrado!');
    return;
  }
  
  const imp = AppState.implantacoes.find(x => x.id === AppState.implantacaoAtualId);
  if(!imp) {
    container.innerHTML = '<p>Implantação não encontrada.</p>';
    return;
  }
  
  const checklistCompleto = obterChecklistCompleto(AppState.implantacaoAtualId);
  const isOptico = temPlanoOptico(imp);
  
  if(!AppState.checklistStatus[AppState.implantacaoAtualId]) {
    AppState.checklistStatus[AppState.implantacaoAtualId] = {};
  }
  
  checklistCompleto.forEach((item, idx) => {
    if(AppState.checklistStatus[AppState.implantacaoAtualId][idx] === undefined) {
      AppState.checklistStatus[AppState.implantacaoAtualId][idx] = false;
    }
  });
  
  Object.keys(AppState.checklistStatus[AppState.implantacaoAtualId]).forEach(key => {
    const idx = parseInt(key);
    if(idx >= checklistCompleto.length) {
      delete AppState.checklistStatus[AppState.implantacaoAtualId][idx];
    }
  });
  
  const status = AppState.checklistStatus[AppState.implantacaoAtualId];
  const progressoGeral = calcularProgressoGeral(AppState.implantacaoAtualId);
  const progressoChecklist = calcularProgressoImplantacao(AppState.implantacaoAtualId);
  
  const logoHTML = imp.logo ? `<img src="${imp.logo}" class="implantacao-logo">` : '';
  
  const totalFaltantes = checklistCompleto.filter((_, idx) => !status[idx]).length;
  const totalConcluidos = checklistCompleto.filter((_, idx) => status[idx]).length;
  
  // Gerar HTML dos itens filtrados
  let listHTML = '';
  
  if(AppState.checklistFilter !== 'none') {
    const itensFiltrados = checklistCompleto
      .map((item, idx) => ({ item, idx, completed: status[idx] }))
      .filter(({completed}) => {
        if (AppState.checklistFilter === 'pending') return !completed;
        if (AppState.checklistFilter === 'completed') return completed;
        return true;
      });
    
    if(itensFiltrados.length === 0) {
      listHTML = `
        <div style="text-align:center;padding:80px 20px;background:linear-gradient(145deg,rgba(16,185,129,0.05),rgba(5,150,105,0.1));border-radius:24px;border:2px dashed rgba(16,185,129,0.3);margin-top:30px;animation:fadeIn 0.5s;">
          <div style="width:100px;height:100px;margin:0 auto 30px;background:linear-gradient(135deg,#10b981,#059669);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 20px 60px rgba(16,185,129,0.3);animation:bounce 2s infinite;">
            <svg style="width:50px;height:50px;color:white;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M9 12l2 2 4-4"></path>
              <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h3 style="color:#10b981;font-size:32px;margin:0 0 15px 0;font-weight:800;">Parabéns! 🎉</h3>
          <p style="color:#6ee7b7;font-size:18px;line-height:1.6;">Todos os itens foram concluídos com sucesso!<br>O projeto está pronto para a próxima fase.</p>
        </div>
      `;
    } else {
      const tituloConfig = {
        pending: { icon: '⚠️', texto: 'Itens Pendentes', cor: '#ef4444', gradient: 'linear-gradient(135deg,#ef4444,#dc2626)' },
        completed: { icon: '✅', texto: 'Itens Concluídos', cor: '#10b981', gradient: 'linear-gradient(135deg,#10b981,#059669)' },
        all: { icon: '📋', texto: 'Todos os Itens', cor: '#7c3aed', gradient: 'linear-gradient(135deg,#7c3aed,#6d28d9)' }
      };
      
      const config = tituloConfig[AppState.checklistFilter];
      
      listHTML += `
        <div style="margin-top:40px;animation:slideUp 0.5s;">
          <div style="background:${config.gradient};border-radius:20px;padding:30px;box-shadow:0 20px 60px ${config.cor}33;margin-bottom:30px;position:relative;overflow:hidden;">
            <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 80 80%22><path fill=%22%23ffffff%22 fill-opacity=%220.05%22 d=%22M0 0h80v80H0z%22/><circle fill=%22%23ffffff%22 fill-opacity=%220.05%22 cx=%2240%22 cy=%2240%22 r=%2220%22/></svg>');opacity:0.3;"></div>
            
            <div style="position:relative;z-index:1;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:20px;">
              <div style="flex:1;min-width:250px;">
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:10px;">
                  <div style="width:60px;height:60px;background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 8px 32px rgba(0,0,0,0.1);">
                    ${config.icon}
                  </div>
                  <div>
                    <h3 style="color:white;font-size:28px;margin:0;font-weight:800;text-shadow:0 2px 20px rgba(0,0,0,0.2);">${config.texto}</h3>
                    <p style="color:rgba(255,255,255,0.9);margin:5px 0 0 0;font-size:16px;">${itensFiltrados.length} ${itensFiltrados.length === 1 ? 'item' : 'itens'}</p>
                  </div>
                </div>
              </div>
              
              ${AppState.checklistFilter === 'pending' && itensFiltrados.length > 0 ? `
                <button onclick="copiarTodosItensPendentes()" style="all:unset;cursor:pointer;background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);color:white;padding:16px 32px;border-radius:12px;font-weight:700;font-size:15px;display:flex;align-items:center;justify-content:center;gap:12px;transition:all 0.3s;border:2px solid rgba(255,255,255,0.3);box-shadow:0 8px 32px rgba(0,0,0,0.1);" onmouseover="this.style.background='rgba(255,255,255,0.3)';this.style.transform='translateY(-2px) scale(1.05)';this.style.boxShadow='0 12px 40px rgba(0,0,0,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.2)';this.style.transform='translateY(0) scale(1)';this.style.boxShadow='0 8px 32px rgba(0,0,0,0.1)'">
                  <svg style="width:20px;height:20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                  <span>Copiar Todos</span>
                  <div style="width:24px;height:24px;background:rgba(255,255,255,0.3);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;">${itensFiltrados.length}</div>
                </button>
              ` : ''}
            </div>
          </div>
          
          <!-- Lista de Itens -->
          <div style="display:flex;flex-direction:column;gap:12px;">
      `;
      
      itensFiltrados.forEach(({item, idx, completed}, arrayIdx) => {
        const itemNumber = idx + 1;
        const isOpticoItem = isOptico && idx >= AppState.checklistPadrao.length;
        const delay = arrayIdx * 50;
        
        listHTML += `
          <div style="background:linear-gradient(145deg,rgba(31,41,55,0.95),rgba(17,24,39,0.98));border:2px solid ${completed ? 'rgba(16,185,129,0.3)' : 'rgba(124,58,237,0.25)'};border-radius:16px;padding:20px 24px;display:flex;align-items:center;gap:20px;transition:all 0.3s;position:relative;overflow:hidden;animation:slideUp 0.4s ease-out ${delay}ms backwards;" 
               onmouseover="this.style.transform='translateX(8px)';this.style.borderColor='${completed ? 'rgba(16,185,129,0.6)' : 'rgba(124,58,237,0.5)'}';this.style.boxShadow='0 12px 40px ${completed ? 'rgba(16,185,129,0.2)' : 'rgba(124,58,237,0.2)'}'" 
               onmouseout="this.style.transform='translateX(0)';this.style.borderColor='${completed ? 'rgba(16,185,129,0.3)' : 'rgba(124,58,237,0.25)'}';this.style.boxShadow='none'">
            
<div style="position:absolute;left:0;top:0;bottom:0;width:4px;background:${completed ? 'linear-gradient(180deg,#10b981,#059669)' : 'linear-gradient(180deg,#7c3aed,#6d28d9)'};"></div>
            
            <!-- Número do item -->
            <div style="width:48px;height:48px;flex-shrink:0;border-radius:12px;background:${completed ? 'linear-gradient(135deg,#10b981,#059669)' : 'linear-gradient(135deg,#7c3aed,#6d28d9)'};display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:18px;box-shadow:0 8px 24px ${completed ? 'rgba(16,185,129,0.3)' : 'rgba(124,58,237,0.3)'};position:relative;">
              ${itemNumber}
              ${completed ? '<div style="position:absolute;top:-4px;right:-4px;width:20px;height:20px;background:#10b981;border:3px solid rgba(17,24,39,0.98);border-radius:50%;display:flex;align-items:center;justify-content:center;"><svg style="width:10px;height:10px;color:white;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><polyline points="20 6 9 17 4 12"></polyline></svg></div>' : ''}
            </div>
            
            <!-- Conteúdo -->
            <div style="flex:1;min-width:0;">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;flex-wrap:wrap;">
                ${isOpticoItem ? `
                  <span style="background:rgba(16,185,129,0.15);color:#10b981;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;border:1px solid rgba(16,185,129,0.3);display:inline-flex;align-items:center;gap:6px;">
                    <svg style="width:12px;height:12px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="3"></circle>
                      <path d="M12 1v6m0 6v6"></path>
                    </svg>
                    ÓPTICO
                  </span>
                ` : ''}
                ${completed ? '<span style="background:rgba(16,185,129,0.15);color:#10b981;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;border:1px solid rgba(16,185,129,0.3);display:inline-flex;align-items:center;gap:6px;"><svg style="width:12px;height:12px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>CONCLUÍDO</span>' : ''}
              </div>
              <p style="color:${completed ? '#9ca3af' : '#e5e7eb'};font-size:15px;line-height:1.6;margin:0;${completed ? 'text-decoration:line-through;' : ''}">${item}</p>
            </div>
            
            <!-- Ações -->
            <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
              ${!completed ? `
                <button onclick="event.stopPropagation();copiarItemChecklist(\`${item.replace(/`/g, '\\`').replace(/\n/g, ' ')}\`, ${idx})" title="Copiar item" style="all:unset;cursor:pointer;width:40px;height:40px;border-radius:10px;background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.25);display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.background='rgba(124,58,237,0.2)';this.style.borderColor='rgba(124,58,237,0.5)';this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(124,58,237,0.1)';this.style.borderColor='rgba(124,58,237,0.25)';this.style.transform='scale(1)'">
                  <svg style="width:18px;height:18px;color:#7c3aed;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                </button>
              ` : ''}
              
              <button onclick="event.stopPropagation();toggleChecklist(${idx},${!completed})" title="${completed ? 'Marcar como pendente' : 'Marcar como concluído'}" style="all:unset;cursor:pointer;width:40px;height:40px;border-radius:10px;background:${completed ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)'};border:1px solid ${completed ? 'rgba(239,68,68,0.25)' : 'rgba(16,185,129,0.25)'};display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.background='${completed ? 'rgba(239,68,68,0.2)' : 'rgba(16,185,129,0.2)'}';this.style.borderColor='${completed ? 'rgba(239,68,68,0.5)' : 'rgba(16,185,129,0.5)'}';this.style.transform='scale(1.1)'" onmouseout="this.style.background='${completed ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)'}';this.style.borderColor='${completed ? 'rgba(239,68,68,0.25)' : 'rgba(16,185,129,0.25)'}';this.style.transform='scale(1)'">
                ${completed ? `
                  <svg style="width:18px;height:18px;color:#ef4444;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"></path>
                  </svg>
                ` : `
                  <svg style="width:18px;height:18px;color:#10b981;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                `}
              </button>
            </div>
          </div>
        `;
      });
      
      listHTML += '</div></div>';
    }
  }
  
  container.innerHTML = `
    <div class="implantacao-card" style="margin-bottom: 30px;">
      <div class="implantacao-header">
        ${logoHTML}
        <span>Implantação: ${imp.portal} - ${imp.razao}</span>
      </div>
      <div class="implantacao-info"><strong>Plano Comercial:</strong> ${imp.planoComercial || "Não informado"}
        ${isOptico ? '<span class="optico-badge">Inclui Checklist Óptico</span>' : ''}
      </div>

      <div class="golive-section" style="position:relative;">
        <h4 style="color:#10b981;margin-bottom:15px;">Controle Final do Projeto</h4>
        
        <div style="display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;">
            <strong style="color:#d1d5db;">Status GO LIVE:</strong>
            <div id="golive-status-${imp.id}" style="margin-top:10px;margin-bottom:15px;">
              ${imp.goLiveRealizado ? 
  '<span class="golive-badge"><span class="status-icon completed">✓</span>GO LIVE Realizado</span>' : 
  imp.dataAgendadaGoLive ? 
    `<span class="golive-badge" style="background:rgba(245,158,11,0.2);border-color:#f59e0b;color:#f59e0b;"><span class="status-icon pending">📅</span>Agendado para ${formatarDataLocal(imp.dataAgendadaGoLive)}</span>` :
    '<span class="golive-badge"><span class="status-icon pending">⏳</span>Aguardando GO LIVE</span>'
}
            </div>
            <button class="golive-btn" onclick="confirmarGoLive(${imp.id})">${imp.goLiveRealizado ? '✓ GO LIVE Concluído' : imp.dataAgendadaGoLive ? '📅 GERENCIAR GO LIVE' : '🚀 AGENDAR GO LIVE'}</button>
          </div>
          
          <div style="flex:1;min-width:200px;">
            <strong style="color:#d1d5db;">Termo de Encerramento:</strong>
            <div id="termo-status-${imp.id}" style="margin-top:10px;margin-bottom:15px;">
              ${imp.termoEnviado ? 
                '<span class="golive-badge"><span class="status-icon completed">✓</span>Termo Enviado</span>' : 
                '<span class="golive-badge"><span class="status-icon pending">⏳</span>Aguardando Envio</span>'
              }
            </div>
            ${!imp.termoEnviado ? 
              `<button class="btn btn-primary" onclick="confirmarEnvioTermo(${imp.id})" style="padding:10px 20px;font-size:14px;font-weight:700;text-transform:uppercase;">CONFIRMAR ENVIO DO TERMO</button>` : 
              `<button class="btn btn-primary" disabled style="opacity:0.6;padding:10px 20px;font-size:14px;font-weight:700;text-transform:uppercase;">✓ Termo Já Enviado</button>`
            }
          </div>
        </div>
      </div>

      <!-- Cards de Estatísticas - CLICÁVEIS -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;">
        
        <!-- CARD FALTANTES -->
        <button onclick="setChecklistFilter('pending')" style="all:unset;cursor:pointer;transition:all 0.3s;">
          <div style="background:linear-gradient(145deg,rgba(239,68,68,0.15),rgba(220,38,38,0.25));border:2px solid ${AppState.checklistFilter === 'pending' ? 'rgba(239,68,68,0.8)' : 'rgba(239,68,68,0.4)'};border-radius:15px;padding:20px;text-align:center;box-shadow:0 8px 25px rgba(239,68,68,0.3);${AppState.checklistFilter === 'pending' ? 'box-shadow:0 0 0 4px rgba(239,68,68,0.2);' : ''}position:relative;overflow:hidden;">
            ${AppState.checklistFilter === 'pending' ? '<div style="position:absolute;top:10px;right:10px;width:10px;height:10px;border-radius:50%;background:#ef4444;box-shadow:0 0 20px #ef4444;animation:pulse 2s infinite;"></div>' : ''}
            <div style="margin-bottom:10px;">
              <svg style="width:36px;height:36px;color:#ef4444;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 8v4m0 4h.01"/>
              </svg>
            </div>
            <div style="font-size:40px;font-weight:800;color:#ef4444;text-shadow:0 0 20px rgba(239,68,68,0.5);margin:10px 0;">${totalFaltantes}</div>
            <div style="font-size:13px;color:#fca5a5;text-transform:uppercase;letter-spacing:1px;font-weight:600;">Itens Faltantes</div>
          </div>
        </button>
        
        <!-- CARD CONCLUÍDOS -->
        <button onclick="setChecklistFilter('completed')" style="all:unset;cursor:pointer;transition:all 0.3s;">
          <div style="background:linear-gradient(145deg,rgba(16,185,129,0.15),rgba(5,150,105,0.25));border:2px solid ${AppState.checklistFilter === 'completed' ? 'rgba(16,185,129,0.8)' : 'rgba(16,185,129,0.4)'};border-radius:15px;padding:20px;text-align:center;box-shadow:0 8px 25px rgba(16,185,129,0.3);${AppState.checklistFilter === 'completed' ? 'box-shadow:0 0 0 4px rgba(16,185,129,0.2);' : ''}position:relative;overflow:hidden;">
            ${AppState.checklistFilter === 'completed' ? '<div style="position:absolute;top:10px;right:10px;width:10px;height:10px;border-radius:50%;background:#10b981;box-shadow:0 0 20px #10b981;animation:pulse 2s infinite;"></div>' : ''}
            <div style="margin-bottom:10px;">
              <svg style="width:36px;height:36px;color:#10b981;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9 12l2 2 4-4"/>
              </svg>
            </div>
            <div style="font-size:40px;font-weight:800;color:#10b981;text-shadow:0 0 20px rgba(16,185,129,0.5);margin:10px 0;">${totalConcluidos}</div>
            <div style="font-size:13px;color:#6ee7b7;text-transform:uppercase;letter-spacing:1px;font-weight:600;">Itens Concluídos</div>
          </div>
        </button>
        
        <!-- CARD PROGRESSO -->
        <button onclick="setChecklistFilter('all')" style="all:unset;cursor:pointer;transition:all 0.3s;">
          <div style="background:linear-gradient(145deg,rgba(124,58,237,0.15),rgba(109,40,217,0.25));border:2px solid ${AppState.checklistFilter === 'all' ? 'rgba(124,58,237,0.8)' : 'rgba(124,58,237,0.4)'};border-radius:15px;padding:20px;text-align:center;box-shadow:0 8px 25px rgba(124,58,237,0.3);${AppState.checklistFilter === 'all' ? 'box-shadow:0 0 0 4px rgba(124,58,237,0.2);' : ''}position:relative;overflow:hidden;">
            ${AppState.checklistFilter === 'all' ? '<div style="position:absolute;top:10px;right:10px;width:10px;height:10px;border-radius:50%;background:#7c3aed;box-shadow:0 0 20px #7c3aed;animation:pulse 2s infinite;"></div>' : ''}
            <div style="margin-bottom:10px;">
              <svg style="width:36px;height:36px;color:#7c3aed;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
              </svg>
            </div>
            <div style="font-size:40px;font-weight:800;color:#7c3aed;text-shadow:0 0 20px rgba(124,58,237,0.5);margin:10px 0;">${progressoChecklist}%</div>
            <div style="font-size:13px;color:#c4b5fd;text-transform:uppercase;letter-spacing:1px;font-weight:600;">Progresso</div>
          </div>
        </button>
      </div>

      <div class="implantacao-info"><strong>Progresso Geral do Projeto:</strong></div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${progressoGeral}%">${progressoGeral}%</div>
      </div>
      
      <div class="implantacao-info"><strong>Progresso do Checklist:</strong></div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-checklist" style="width: ${progressoChecklist}%">${progressoChecklist}%</div>
      </div>
      
      <div class="implantacao-info"><strong>Total de Itens:</strong> ${checklistCompleto.length}
        ${isOptico ? ` (${AppState.checklistPadrao.length} padrão + ${AppState.checklistOptico.length} óptico)` : ''}
      </div>
    </div>
    
    ${listHTML}
  `;
  
  salvarNoStorage();
}

function copiarItemChecklist(texto, idx) {
  navigator.clipboard.writeText(texto).then(() => {
    showToast('Item copiado com sucesso!', 'success', '✓ Copiado');
  }).catch(() => {
    showToast('Erro ao copiar. Tente novamente.', 'error');
  });
}

function copiarTodosItensPendentes() {
  const checklistCompleto = obterChecklistCompleto(AppState.implantacaoAtualId);
  const status = AppState.checklistStatus[AppState.implantacaoAtualId] || {};
  
  const itensPendentes = checklistCompleto
    .map((item, idx) => ({ item, idx }))
    .filter(({idx}) => !status[idx])
    .map(({item, idx}) => `${idx + 1}. ${item}`);
  
  if(itensPendentes.length === 0) {
    showToast('Não há itens pendentes para copiar!', 'info');
    return;
  }
  
  const textoCopiar = `ITENS PENDENTES DO CHECKLIST:\n\n${itensPendentes.join('\n\n')}`;
  
  navigator.clipboard.writeText(textoCopiar).then(() => {
    criarConfete();
    showToast(`${itensPendentes.length} itens copiados com sucesso! 🎉`, 'success', 'Todos os Itens Copiados');
  }).catch(() => {
    showToast('Erro ao copiar. Tente novamente.', 'error');
  });
}

// ===== FILTRO DE CHECKLIST =====
function setChecklistFilter(filter) {
  if(AppState.checklistFilter === filter) {
    AppState.checklistFilter = 'none';
  } else {
    AppState.checklistFilter = filter;
  }
  salvarNoStorage();
  carregarChecklist();
}

// ===== TOGGLE CHECKLIST (VERSÃO CORRIGIDA - SEM DUPLICAÇÃO) =====
function toggleChecklist(idx, checked){
  if(!AppState.checklistStatus[AppState.implantacaoAtualId]) {
    AppState.checklistStatus[AppState.implantacaoAtualId] = {};
  }
  
  AppState.checklistStatus[AppState.implantacaoAtualId][idx] = checked;
  salvarNoStorage();
  
  carregarChecklist();
  
  const progressoChecklist = calcularProgressoImplantacao(AppState.implantacaoAtualId);
  const progressoTreinamento = calcularProgressoTreinamento(AppState.implantacaoAtualId);
  
  const imp = AppState.implantacoes.find(x => x.id === AppState.implantacaoAtualId);
  if(imp) {
    if(progressoChecklist === 100 && progressoTreinamento === 100) {
      if(imp.status !== 'Concluída') {
        imp.status = 'Concluída';
        salvarNoStorage();
        criarConfete();
        showToast('🎉 Parabéns! Implantação concluída com sucesso!', 'success');
      }
    } else {
      if(imp.status === 'Concluída') {
        imp.status = 'Em Andamento';
        salvarNoStorage();
      }
    }
  }
  
  if(checked) {
    showToast('✓ Item marcado como concluído!', 'success');
  } else {
    showToast('↻ Item marcado como pendente!', 'warning');
  }
  
  atualizarDashboard();
}

// ===== TREINAMENTOS =====
function carregarListaTreinamentos() {
  const container = document.getElementById('lista-treinamentos');
  if(!container) return;
  
  carregarDoStorage();
  
  if(AppState.implantacoes.length === 0) {
    container.innerHTML = '<p style="color:#9ca3af;text-align:center;padding:40px;">Nenhuma implantação cadastrada.</p>';
    return;
  }
  
  container.innerHTML = AppState.implantacoes.map(imp => {
    const treinamentosImp = AppState.treinamentos[imp.id] || [];
    const progressoTreinamento = calcularProgressoTreinamento(imp.id);
    const logoHTML = imp.logo ? `<img src="${imp.logo}" class="implantacao-logo">` : '';
    
    return `
      <div class="implantacao-card">
        <div class="implantacao-header">
          ${logoHTML}
          <span>Portal: ${imp.portal} - ${imp.razao}</span>
        </div>
        <div class="implantacao-info"><strong>Plano:</strong> ${imp.planoComercial || "Não informado"}</div>
        <div class="implantacao-info"><strong>Progresso dos Treinamentos:</strong></div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progressoTreinamento}%; background: linear-gradient(90deg, #f59e0b, #d97706);">${progressoTreinamento}%</div>
        </div>
        
        <div style="margin-top:20px;">
            <h4 style="color:#f59e0b;margin-bottom:10px;">Adicionar Novo Treinamento</h4>
            <input type="text" id="titulo-${imp.id}" placeholder="Título do treinamento" style="margin-bottom:10px;">
            <input type="date" id="data-${imp.id}" style="margin-bottom:10px;">
            <input type="text" id="participantes-${imp.id}" placeholder="Participantes" style="margin-bottom:10px;">
            <input type="url" id="link-${imp.id}" placeholder="Link do treinamento (opcional)" style="margin-bottom:10px;">
            <button class="btn btn-success" onclick="adicionarTreinamento(${imp.id})">Adicionar Treinamento</button>
          </div>
        
        <div style="margin-top:20px;">
          <h4 style="color:#f59e0b;margin-bottom:10px;">Treinamentos Cadastrados (${treinamentosImp.length})</h4>
          ${treinamentosImp.length === 0 ? 
            '<p style="color:#9ca3af;font-style:italic;">Nenhum treinamento cadastrado ainda.</p>' :
            treinamentosImp.map((t, idx) => `
              <div class="treinamento-item">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:5px;">
                  <input type="checkbox" ${t.concluido ? 'checked' : ''} onchange="toggleTreinamento(${imp.id}, ${idx})">
                  <strong style="${t.concluido ? 'color:#10b981;text-decoration:line-through;' : 'color:#e5e7eb;'}">${t.titulo}</strong>
                </div>
                <div style="color:#9ca3af;font-size:13px;margin-left:30px;">
                  <div>Data: ${t.data || 'Não definida'}</div>
                  <div>Participantes: ${t.participantes || 'Não informado'}</div>
                  ${t.link ? `<div>Link: <a href="${t.link}" target="_blank" style="color:#7c3aed;text-decoration:underline;" title="Abrir link">${t.link.length > 50 ? t.link.substring(0, 50) + '...' : t.link}</a></div>` : ''}
                </div>
                <div style="display:flex;gap:10px;margin-top:10px;margin-left:30px;">
                  ${t.link ? `<button class="btn btn-primary btn-sm" onclick="window.open('${t.link}', '_blank')" style="display:flex;align-items:center;gap:5px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                      <polyline points="15 3 21 3 21 9"></polyline>
                      <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Abrir Link
                  </button>` : ''}
                  <button class="btn btn-danger btn-sm" onclick="removerTreinamento(${imp.id}, ${idx})">Remover</button>
                </div>
              </div>
            `).join('')
          }
        </div>
      </div>
    `;
  }).join('');
}

function adicionarTreinamento(implantacaoId) {
  const titulo = document.getElementById('titulo-' + implantacaoId).value.trim();
  const data = document.getElementById('data-' + implantacaoId).value;
  const participantes = document.getElementById('participantes-' + implantacaoId).value.trim();
  const link = document.getElementById('link-' + implantacaoId).value.trim();
  
  if(!titulo) {
    showToast('Digite o título do treinamento!', 'warning');
    return;
  }
  
  if(!AppState.treinamentos[implantacaoId]) {
    AppState.treinamentos[implantacaoId] = [];
  }
  
  AppState.treinamentos[implantacaoId].push({
    titulo: titulo,
    data: data,
    participantes: participantes,
    link: link,
    concluido: false
  });
  
  const imp = AppState.implantacoes.find(x => x.id === implantacaoId);
  if(imp) {
    const progressoChecklist = calcularProgressoImplantacao(implantacaoId);
    const progressoTreinamento = calcularProgressoTreinamento(implantacaoId);
    
    if(progressoChecklist === 100 && progressoTreinamento === 100) {
      if(imp.status !== 'Concluída') {
        imp.status = 'Concluída';
      }
    } else {
      if(imp.status === 'Concluída') {
        imp.status = 'Em Andamento';
      }
    }
  }
  
  document.getElementById('titulo-' + implantacaoId).value = '';
  document.getElementById('data-' + implantacaoId).value = '';
  document.getElementById('participantes-' + implantacaoId).value = '';
  document.getElementById('link-' + implantacaoId).value = ''; // ADICIONE ESTA LINHA

  
  salvarNoStorage();
  carregarListaTreinamentos();
  atualizarDashboard();
  showToast('Treinamento adicionado com sucesso!', 'success');
}

function toggleTreinamento(implantacaoId, treinamentoIdx) {
  if(!AppState.treinamentos[implantacaoId] || !AppState.treinamentos[implantacaoId][treinamentoIdx]) return;
  
  AppState.treinamentos[implantacaoId][treinamentoIdx].concluido = !AppState.treinamentos[implantacaoId][treinamentoIdx].concluido;
  
  const imp = AppState.implantacoes.find(x => x.id === implantacaoId);
  if(imp) {
    const progressoChecklist = calcularProgressoImplantacao(implantacaoId);
    const progressoTreinamento = calcularProgressoTreinamento(implantacaoId);
    
    if(progressoChecklist === 100 && progressoTreinamento === 100) {
      if(imp.status !== 'Concluída') {
        imp.status = 'Concluída';
        showToast('Parabéns! Implantação concluída com sucesso!', 'success');
      }
    } else {
      if(imp.status === 'Concluída') {
        imp.status = 'Em Andamento';
      }
    }
  }
  
  salvarNoStorage();
  carregarListaTreinamentos();
  atualizarDashboard();
}

function removerTreinamento(implantacaoId, treinamentoIdx) {
  if(confirm('Tem certeza que deseja remover este treinamento?')) {
    AppState.treinamentos[implantacaoId].splice(treinamentoIdx, 1);
    
    const imp = AppState.implantacoes.find(x => x.id === implantacaoId);
    if(imp) {
      const progressoChecklist = calcularProgressoImplantacao(implantacaoId);
      const progressoTreinamento = calcularProgressoTreinamento(implantacaoId);
      
      if(progressoChecklist === 100 && progressoTreinamento === 100) {
        if(imp.status !== 'Concluída') {
          imp.status = 'Concluída';
        }
      } else {
        if(imp.status === 'Concluída') {
          imp.status = 'Em Andamento';
        }
      }
    }
    
    salvarNoStorage();
    carregarListaTreinamentos();
    atualizarDashboard();
    showToast('Treinamento removido com sucesso!', 'success');
  }
}

// ===== TERMO DE ENCERRAMENTO =====
function carregarListaProjetosTermo() {
  const container = document.getElementById('lista-projetos-termo');
  if(!container) return;
  
  carregarDoStorage();
  
  if(AppState.implantacoes.length === 0) {
    container.innerHTML = '<p style="color:#9ca3af;text-align:center;padding:40px;">Nenhuma implantação cadastrada.</p>';
    return;
  }
  
  container.innerHTML = AppState.implantacoes.map(imp => {
  const logoHTML = imp.logo ? `<img src="${imp.logo}" class="implantacao-logo">` : '';
  return `
    <div class="projeto-termo-card">
      <div class="implantacao-header">
        ${logoHTML}
        <span>Portal: ${imp.portal} - ${imp.razao}</span>
      </div>
      <div class="implantacao-info">
        <strong>Status:</strong> <span style="color: ${imp.status === 'Concluída' ? '#10b981' : '#f59e0b'};">${imp.status || "Em Andamento"}</span>
      </div>
      <div class="implantacao-info"><strong>Gerente:</strong> ${imp.gerente || "Não informado"}</div>
      
      <button class="btn btn-primary" onclick="gerarTermo(${imp.id})" style="margin-top:15px;width:100%;display:flex;align-items:center;justify-content:center;gap:10px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
        </svg>
        Gerar Termo de Encerramento
      </button>
    </div>
  `;
}).join("");
}

function gerarTermo(id) {
  console.log('🎯 Gerando termo para ID:', id);
  
  const imp = AppState.implantacoes.find(x => x.id === id);
  if(!imp) {
    console.error('❌ Implantação não encontrada:', id);
    showToast('Implantação não encontrada!', 'error');
    return;
  }
  
  console.log('✅ Implantação encontrada:', imp);
  
  const dataHoje = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
  
  // 1. Gerar equipe HTML
  let equipeHTML = '';
  if(imp.equipe && imp.equipe.length > 0) {
    imp.equipe.forEach(membro => {
      equipeHTML += `
        <tr>
          <td style="padding:8px;border:1px solid #d1d1d1;font-weight:bold;width:200px;background:#f3f2f1;">Analista:</td>
          <td style="padding:8px;border:1px solid #d1d1d1;">${membro.nome || 'Não informado'}</td>
        </tr>
        <tr>
          <td style="padding:8px;border:1px solid #d1d1d1;font-weight:bold;background:#f3f2f1;">E-mail:</td>
          <td style="padding:8px;border:1px solid #d1d1d1;">${membro.email || 'Não informado'}</td>
        </tr>
      `;
    });
  } else {
    equipeHTML = `
      <tr>
        <td style="padding:8px;border:1px solid #d1d1d1;font-weight:bold;width:200px;background:#f3f2f1;">Analista:</td>
        <td style="padding:8px;border:1px solid #d1d1d1;">Não informado</td>
      </tr>
    `;
  }
  
  // 2. Gerar HTML dos treinamentos
  let treinamentosHTML = '';
  const treinamentosImp = AppState.treinamentos[imp.id] || [];
  
  if(treinamentosImp.length > 0) {
    treinamentosHTML = '<table style="border-collapse:collapse;width:100%;margin:15px 0;">';
    treinamentosHTML += '<tr><td colspan="2" style="padding:10px;border:1px solid #d1d1d1;background:#0078d4;color:white;font-weight:600;text-align:center;">TREINAMENTOS REALIZADOS</td></tr>';
    
    treinamentosImp.forEach((t, idx) => {
      treinamentosHTML += `
        <tr>
          <td style="padding:8px;border:1px solid #d1d1d1;background:#f3f2f1;font-weight:600;width:200px;">Treinamento ${idx + 1}:</td>
          <td style="padding:8px;border:1px solid #d1d1d1;">${t.titulo}</td>
        </tr>
      `;
      
      if(t.data) {
        const dataFormatada = formatarDataLocal(t.data);
        treinamentosHTML += `
          <tr>
            <td style="padding:8px;border:1px solid #d1d1d1;background:#f3f2f1;font-weight:600;">Data:</td>
            <td style="padding:8px;border:1px solid #d1d1d1;">${dataFormatada}</td>
          </tr>
        `;
      }
      
      if(t.participantes) {
        treinamentosHTML += `
          <tr>
            <td style="padding:8px;border:1px solid #d1d1d1;background:#f3f2f1;font-weight:600;">Participantes:</td>
            <td style="padding:8px;border:1px solid #d1d1d1;">${t.participantes}</td>
          </tr>
        `;
      }
      
      if(t.link) {
        treinamentosHTML += `
          <tr>
            <td style="padding:8px;border:1px solid #d1d1d1;background:#f3f2f1;font-weight:600;">Link:</td>
            <td style="padding:8px;border:1px solid #d1d1d1;"><a href="${t.link}" target="_blank" style="color:#0078d4;text-decoration:underline;">${t.link}</a></td>
          </tr>
        `;
      }
      
      if(idx < treinamentosImp.length - 1) {
        treinamentosHTML += '<tr><td colspan="2" style="padding:5px;border:none;"></td></tr>';
      }
    });
    
    treinamentosHTML += '</table>';
  } else {
    treinamentosHTML = '<p style="color:#999;font-style:italic;margin:10px 0;">Nenhum treinamento cadastrado</p>';
  }
  
  // 3. Carregar template
  let template = AppState.templateTermo || obterTemplateOriginal();
  
  // 4. Substituir todas as tags
  template = template.replace(/{{LOJA}}/g, imp.razao || '');
  template = template.replace(/{{CNPJ}}/g, imp.cnpjs || '');
  template = template.replace(/{{PORTAL}}/g, imp.portal || '');
  template = template.replace(/{{CONTATO}}/g, imp.contatoNome || '');
  template = template.replace(/{{TELEFONE}}/g, imp.contatoTelefone || '');
  template = template.replace(/{{AMBIENTE}}/g, imp.ambiente || '');
  template = template.replace(/{{SERIE_NFE}}/g, imp.serieNFe || '');
  template = template.replace(/{{SERIE_NFCE}}/g, imp.serieNFCe || '');
  template = template.replace(/{{PLANO}}/g, imp.planoComercial || '');
  template = template.replace(/{{TREINAMENTOS}}/g, treinamentosHTML);
  
  // Gerar tabela de usuários
  let usuariosHTML = '<table style="border-collapse:collapse;width:100%;">';
  let temUsuarios = false;
  
  if(imp.usuarioAdmin) {
    usuariosHTML += `<tr><td style="padding:8px;border:1px solid #d1d1d1;width:200px;background:#f3f2f1;font-weight:600;">Usuário Admin:</td><td style="padding:8px;border:1px solid #d1d1d1;">${imp.usuarioAdmin}</td></tr>`;
    temUsuarios = true;
  }
  if(imp.usuarioGerente) {
    usuariosHTML += `<tr><td style="padding:8px;border:1px solid #d1d1d1;background:#f3f2f1;font-weight:600;">Usuário Gerente:</td><td style="padding:8px;border:1px solid #d1d1d1;">${imp.usuarioGerente}</td></tr>`;
    temUsuarios = true;
  }
  if(imp.usuarioCaixa) {
    usuariosHTML += `<tr><td style="padding:8px;border:1px solid #d1d1d1;background:#f3f2f1;font-weight:600;">Usuário Caixa:</td><td style="padding:8px;border:1px solid #d1d1d1;">${imp.usuarioCaixa}</td></tr>`;
    temUsuarios = true;
  }
  if(imp.usuarioEstoque) {
    usuariosHTML += `<tr><td style="padding:8px;border:1px solid #d1d1d1;background:#f3f2f1;font-weight:600;">Usuário Estoque:</td><td style="padding:8px;border:1px solid #d1d1d1;">${imp.usuarioEstoque}</td></tr>`;
    temUsuarios = true;
  }
  if(imp.usuarioFinanceiro) {
    usuariosHTML += `<tr><td style="padding:8px;border:1px solid #d1d1d1;background:#f3f2f1;font-weight:600;">Usuário Financeiro:</td><td style="padding:8px;border:1px solid #d1d1d1;">${imp.usuarioFinanceiro}</td></tr>`;
    temUsuarios = true;
  }
  
  if(!temUsuarios) {
    usuariosHTML += '<tr><td colspan="2" style="padding:8px;border:1px solid #d1d1d1;text-align:center;color:#999;font-style:italic;">Nenhum usuário cadastrado</td></tr>';
  }
  
  usuariosHTML += '</table>';
  template = template.replace(/{{USUARIOS}}/g, usuariosHTML);
  
  // Substituir tags de usuários individuais
  template = template.replace(/{{USUARIO_1}}/g, imp.usuarioAdmin || '');
  template = template.replace(/{{USUARIO_2}}/g, imp.usuarioGerente || '');
  template = template.replace(/{{USUARIO_3}}/g, imp.usuarioCaixa || '');
  template = template.replace(/{{USUARIO_4}}/g, imp.usuarioEstoque || '');
  template = template.replace(/{{USUARIO_5}}/g, imp.usuarioFinanceiro || '');
  template = template.replace(/{{USUARIO_6}}/g, '');
  
  // Gerar lista de módulos
  let modulosHTML = '';
  if(imp.modulos && imp.modulos.length > 0) {
    modulosHTML = '<ul style="margin:10px 0;padding-left:25px;line-height:1.8;">';
    imp.modulos.forEach(modulo => {
      modulosHTML += `<li style="color:#323130;">${modulo}</li>`;
    });
    modulosHTML += '</ul>';
  } else {
    modulosHTML = '<p style="color:#999;font-style:italic;margin:10px 0;">Nenhum módulo contratado</p>';
  }
  template = template.replace(/{{MODULOS}}/g, modulosHTML);
  
  // Substituir módulos individuais
  for(let i = 1; i <= 8; i++) {
    const modulo = imp.modulos && imp.modulos[i-1] ? imp.modulos[i-1] : '';
    template = template.replace(new RegExp(`{{MODULO_${i}}}`, 'g'), modulo);
  }
  
  template = template.replace(/{{EQUIPE}}/g, equipeHTML);
  template = template.replace(/{{DATA_CRIACAO}}/g, imp.dataCriacao || '');
  template = template.replace(/{{GERENTE}}/g, imp.gerente || '');
  template = template.replace(/{{DATA_HOJE}}/g, dataHoje);
  
  // 5. Renderizar o termo
  const termoHTML = `
    <div style="max-width:900px;margin:0 auto;">
      <div class="termo-email" id="termo-content" style="max-height:none;height:auto;overflow:visible;margin-bottom:20px;max-width:100%;min-height:600px;padding:30px;">
        ${template}
      </div>
      
      <div class="termo-actions" style="position:sticky;bottom:20px;background:rgba(31,41,55,0.98);backdrop-filter:blur(10px);padding:20px;border-radius:12px;box-shadow:0 -8px 32px rgba(0,0,0,0.4);border:1px solid rgba(124,58,237,0.3);z-index:1000;margin-top:30px;">
        <button class="btn btn-primary" onclick="copiarTermo()">Copiar para Área de Transferência</button>
        <button class="btn btn-success" onclick="editarTermo()">Editar Termo</button>
        <button class="btn btn-warning" onclick="voltarListaTermo()">Voltar</button>
      </div>
    </div>
  `;
  
  document.getElementById('termo-container').innerHTML = termoHTML;
  showToast('Termo gerado com sucesso!', 'success');
}

function voltarListaTermo() {
  const container = document.getElementById('termo-container');
  if(!container) return;
  
  container.innerHTML = `
    <p style="color:#9ca3af;">Selecione uma implantação para gerar o termo de encerramento:</p>
    <div id="lista-projetos-termo"></div>
  `;
  
  carregarListaProjetosTermo();
}

function copiarTermo() {
  const termoContent = document.getElementById('termo-content');
  if(!termoContent) return;
  
  const range = document.createRange();
  range.selectNode(termoContent);
  window.getSelection().removeAllRanges();
  window.getSelection().addRange(range);
  
  try {
    document.execCommand('copy');
    showToast('Termo copiado! Cole diretamente no Outlook usando Ctrl+V', 'success');
  } catch (err) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = termoContent.innerHTML;
    tempDiv.style.position = 'absolute';
    tempDiv.style.left = '-9999px';
    document.body.appendChild(tempDiv);
    
    const selection = window.getSelection();
    const range2 = document.createRange();
    range2.selectNodeContents(tempDiv);
    selection.removeAllRanges();
    selection.addRange(range2);
    
    document.execCommand('copy');
    document.body.removeChild(tempDiv);
    showToast('Termo copiado! Cole diretamente no Outlook usando Ctrl+V', 'success');
  }
  
  window.getSelection().removeAllRanges();
}

function editarTermo() {
  const termoContent = document.getElementById('termo-content');
  if(!termoContent) return;
  
  termoContent.contentEditable = 'true';
  termoContent.style.border = '2px dashed #7c3aed';
  termoContent.style.outline = 'none';
  
  const actionsDiv = document.querySelector('.termo-actions');
  actionsDiv.innerHTML = `
    <button class="btn btn-success" onclick="salvarEdicaoTermo()">Salvar Edição</button>
    <button class="btn btn-primary" onclick="copiarTermo()">Copiar Editado</button>
    <button class="btn btn-danger" onclick="cancelarEdicaoTermo()">Cancelar</button>
  `;
  
  showToast('Modo de edição ativado! Edite o texto diretamente no documento.', 'info');
}

function salvarEdicaoTermo() {
  const termoContent = document.getElementById('termo-content');
  if(!termoContent) return;
  
  termoContent.contentEditable = 'false';
  termoContent.style.border = 'none';
  
  const actionsDiv = document.querySelector('.termo-actions');
  actionsDiv.innerHTML = `
    <button class="btn btn-primary" onclick="copiarTermo()">Copiar para Área de Transferência</button>
    <button class="btn btn-success" onclick="editarTermo()">Editar Termo</button>
    <button class="btn btn-warning" onclick="voltarListaTermo()">Voltar</button>
  `;
  
  showToast('Edições salvas! Você pode copiar o termo editado.', 'success');
}

function cancelarEdicaoTermo() {
  voltarListaTermo();
}

function carregarTemplateTermo() {
  const editor = document.getElementById('template-termo-visual');
  if(editor) {
    if(AppState.templateTermo) {
      editor.innerHTML = AppState.templateTermo;
    } else {
      editor.innerHTML = obterTemplateOriginal();
    }
  }
}

function salvarTemplateTermoVisual() {
  const editor = document.getElementById('template-termo-visual');
  if(editor) {
    AppState.templateTermo = editor.innerHTML;
    localStorage.setItem('templateTermo', editor.innerHTML);
    showToast('Template salvo com sucesso!', 'success');
  }
}

function copiarTag(tag) {
  navigator.clipboard.writeText(tag).then(() => {
    showToast('Tag copiada: ' + tag, 'success');
  });
}

function restaurarTemplateOriginal() {
  if(confirm('Deseja restaurar o template original? Todas as personalizações serão perdidas.')) {
    AppState.templateTermo = obterTemplateOriginal();
    localStorage.setItem('templateTermo', AppState.templateTermo);
    carregarTemplateTermo();
    showToast('Template original restaurado!', 'success');
  }
}

// ===== CONFIGURAÇÕES DE CHECKLIST =====
function carregarEditorChecklistPadrao() {
  const editor = document.getElementById('editor-checklist-padrao');
  if(!editor) return;
  
  editor.innerHTML = AppState.checklistPadrao.map((item, idx) => 
    `<div class="checklist-editor" draggable="true" data-index="${idx}" data-tipo="padrao">
      <span class="drag-handle">☰</span>
      <span class="item-order">${idx + 1}</span>
      <input type="text" value="${item}" onchange="atualizarItemChecklistPadrao(${idx}, this.value)">
      <button class="btn btn-danger" onclick="removerItemChecklistPadrao(${idx})">Excluir</button>
    </div>`
  ).join("");
  
  inicializarDragAndDrop('padrao');
}

function carregarEditorChecklistOptico() {
  const editor = document.getElementById('editor-checklist-optico');
  if(!editor) return;
  
  editor.innerHTML = AppState.checklistOptico.map((item, idx) => 
    `<div class="checklist-editor" draggable="true" data-index="${idx}" data-tipo="optico">
      <span class="drag-handle">☰</span>
      <span class="item-order">${idx + 1}</span>
      <input type="text" value="${item}" onchange="atualizarItemChecklistOptico(${idx}, this.value)" style="background: rgba(16,185,129,0.1); border-color: rgba(16,185,129,0.3);">
      <button class="btn btn-danger" onclick="removerItemChecklistOptico(${idx})">Excluir</button>
    </div>`
  ).join("");
  
  inicializarDragAndDrop('optico');
}

function atualizarItemChecklistPadrao(idx, novoValor) {
  AppState.checklistPadrao[idx] = novoValor.trim();
}

function atualizarItemChecklistOptico(idx, novoValor) {
  AppState.checklistOptico[idx] = novoValor.trim();
}

function adicionarItemChecklist() {
  const novoItem = document.getElementById('novo-item-checklist').value.trim();
  if(!novoItem) {
    showToast('Digite um item para adicionar!', 'warning');
    return;
  }
  
  AppState.checklistPadrao.push(novoItem);
  document.getElementById('novo-item-checklist').value = '';
  carregarEditorChecklistPadrao();
}

function adicionarItemChecklistOptico() {
  const novoItem = document.getElementById('novo-item-checklist-optico').value.trim();
  if(!novoItem) {
    showToast('Digite um item para adicionar!', 'warning');
    return;
  }
  
  AppState.checklistOptico.push(novoItem);
  document.getElementById('novo-item-checklist-optico').value = '';
  carregarEditorChecklistOptico();
}

function removerItemChecklistPadrao(idx) {
  if(confirm('Tem certeza que deseja remover este item?')) {
    AppState.checklistPadrao.splice(idx, 1);
    carregarEditorChecklistPadrao();
  }
}

function removerItemChecklistOptico(idx) {
  if(confirm('Tem certeza que deseja remover este item?')) {
    AppState.checklistOptico.splice(idx, 1);
    carregarEditorChecklistOptico();
  }
}

function salvarChecklistPadrao() {
  salvarNoStorage();
  
  AppState.implantacoes.forEach(imp => {
    if(!AppState.checklistStatus[imp.id]) {
      AppState.checklistStatus[imp.id] = {};
    }
    
    const checklistCompleto = obterChecklistCompleto(imp.id);
    checklistCompleto.forEach((item, idx) => {
      if(AppState.checklistStatus[imp.id][idx] === undefined) {
        AppState.checklistStatus[imp.id][idx] = false;
      }
    });
    
    Object.keys(AppState.checklistStatus[imp.id]).forEach(key => {
      const idx = parseInt(key);
      if(idx >= checklistCompleto.length) {
        delete AppState.checklistStatus[imp.id][idx];
      }
    });
  });
  
  salvarNoStorage();
  
  if(AppState.implantacaoAtualId) {
    carregarChecklist();
  }
  
  showToast('Checklist padrão salvo com sucesso! Todas as implantações foram atualizadas.', 'success');
}

function salvarChecklistOptico() {
  salvarNoStorage();
  
  AppState.implantacoes.forEach(imp => {
    if(temPlanoOptico(imp)) {
      if(!AppState.checklistStatus[imp.id]) {
        AppState.checklistStatus[imp.id] = {};
      }
      
      const checklistCompleto = obterChecklistCompleto(imp.id);
      checklistCompleto.forEach((item, idx) => {
        if(AppState.checklistStatus[imp.id][idx] === undefined) {
          AppState.checklistStatus[imp.id][idx] = false;
        }
      });
      
      Object.keys(AppState.checklistStatus[imp.id]).forEach(key => {
        const idx = parseInt(key);
        if(idx >= checklistCompleto.length) {
          delete AppState.checklistStatus[imp.id][idx];
        }
      });
    }
  });
  
  salvarNoStorage();
  
  if(AppState.implantacaoAtualId) {
    carregarChecklist();
  }
  
  showToast('Checklist óptico salvo com sucesso! Todas as implantações ópticas foram atualizadas.', 'success');
}

// ===== DRAG AND DROP PARA REORDENAR CHECKLIST =====
let draggedElement = null;
let draggedIndex = null;
let draggedTipo = null;

function inicializarDragAndDrop(tipo) {
  const editorId = tipo === 'padrao' ? 'editor-checklist-padrao' : 'editor-checklist-optico';
  const editor = document.getElementById(editorId);
  if(!editor) return;
  
  const items = editor.querySelectorAll('.checklist-editor');
  
  items.forEach(item => {
    // Drag start
    item.addEventListener('dragstart', function(e) {
      draggedElement = this;
      draggedIndex = parseInt(this.getAttribute('data-index'));
      draggedTipo = this.getAttribute('data-tipo');
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    });
    
    // Drag end
    item.addEventListener('dragend', function(e) {
      this.classList.remove('dragging');
      items.forEach(i => i.classList.remove('drag-over'));
    });
    
    // Drag over
    item.addEventListener('dragover', function(e) {
      if(e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      
      if(this !== draggedElement) {
        this.classList.add('drag-over');
      }
      return false;
    });
    
    // Drag enter
    item.addEventListener('dragenter', function(e) {
      if(this !== draggedElement) {
        this.classList.add('drag-over');
      }
    });
    
    // Drag leave
    item.addEventListener('dragleave', function(e) {
      this.classList.remove('drag-over');
    });
    
    // Drop
    item.addEventListener('drop', function(e) {
      if(e.stopPropagation) {
        e.stopPropagation();
      }
      
      if(draggedElement !== this && draggedTipo === tipo) {
        const dropIndex = parseInt(this.getAttribute('data-index'));
        reordenarChecklist(tipo, draggedIndex, dropIndex);
      }
      
      this.classList.remove('drag-over');
      return false;
    });
  });
}

function reordenarChecklist(tipo, fromIndex, toIndex) {
  let checklist = tipo === 'padrao' ? AppState.checklistPadrao : AppState.checklistOptico;
  
  // Remover item da posição original
  const item = checklist.splice(fromIndex, 1)[0];
  
  // Inserir na nova posição
  checklist.splice(toIndex, 0, item);
  
  // Atualizar array global
  if(tipo === 'padrao') {
    AppState.checklistPadrao = checklist;
  } else {
    AppState.checklistOptico = checklist;
  }
  
  // Recarregar editor
  if(tipo === 'padrao') {
    carregarEditorChecklistPadrao();
  } else {
    carregarEditorChecklistOptico();
  }
  
  showToast('Ordem atualizada! Não esqueça de salvar.', 'info');
}

// ===== DASHBOARD =====
function atualizarDashboard() {
  carregarDoStorage();
  
  const totalImplantacoes = document.getElementById('total-implantacoes');
  const implantacoesAndamento = document.getElementById('implantacoes-andamento');
  const implantacoesConcluidas = document.getElementById('implantacoes-concluidas');
  const progressoMedio = document.getElementById('progresso-medio');
  
  if(totalImplantacoes) totalImplantacoes.textContent = AppState.implantacoes.length;
  
  const andamento = AppState.implantacoes.filter(i => (i.status || 'Em Andamento') === 'Em Andamento').length;
  const concluidas = AppState.implantacoes.filter(i => i.status === 'Concluída').length;
  
  if(implantacoesAndamento) implantacoesAndamento.textContent = andamento;
  if(implantacoesConcluidas) implantacoesConcluidas.textContent = concluidas;
  
  if(AppState.implantacoes.length > 0) {
    const progressoTotal = AppState.implantacoes.reduce((acc, imp) => {
      return acc + calcularProgressoGeral(imp.id);
    }, 0);
    const progMedio = Math.round(progressoTotal / AppState.implantacoes.length);
    if(progressoMedio) progressoMedio.textContent = progMedio + '%';
  } else {
    if(progressoMedio) progressoMedio.textContent = '0%';
  }
  
  const div = document.getElementById("todas-implantacoes");
  if(!div) return;
  
  if(AppState.implantacoes.length === 0) {
    div.innerHTML = "<p style='text-align:center; color:#9ca3af; font-style:italic; padding:40px;'>Nenhuma implantação cadastrada ainda.</p>";
    return;
  }
  
  div.innerHTML = AppState.implantacoes.map(i => {
    const progressoGeral = calcularProgressoGeral(i.id);
    const progressoChecklist = calcularProgressoImplantacao(i.id);
    const progressoTreinamento = calcularProgressoTreinamento(i.id);
    const isOptico = temPlanoOptico(i);
    const logoHTML = i.logo ? `<img src="${i.logo}" class="implantacao-logo">` : '';
    
    return `
      <div class="implantacao-card">
        <div class="implantacao-header">
          ${logoHTML}
          <span>Portal: ${i.portal} - ${i.razao}</span>
        </div>
        <div class="implantacao-info"><strong>Data:</strong> ${i.dataCriacao || "N/A"}</div>
        <div class="implantacao-info"><strong>Plano:</strong> ${i.planoComercial || "Não informado"}
          ${isOptico ? '<span class="optico-badge">Inclui Óptico</span>' : ''}
        </div>
        <div class="implantacao-info"><strong>Gerente:</strong> ${i.gerente || "Não informado"}</div>
        <div class="implantacao-info"><strong>Status:</strong> 
          <span style="color: ${i.status === 'Concluída' ? '#10b981' : '#f59e0b'};">${i.status || "Em Andamento"}</span>
        </div>
        <div class="implantacao-info"><strong>Progresso Geral do Projeto:</strong></div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progressoGeral}%">${progressoGeral}%</div>
        </div>
        <button class="toggle-details" onclick="toggleProgressDetails('dash-${i.id}', event)">
          <span class="icon">▼</span>
          <span>Ver Detalhes do Progresso</span>
        </button>
        <div class="progress-details" id="dash-${i.id}">
          <div class="implantacao-info"><strong>Progresso Checklist:</strong></div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${progressoChecklist}%; background: linear-gradient(90deg, #7c3aed, #6d28d9);">${progressoChecklist}%</div>
          </div>
          <div class="implantacao-info"><strong>Progresso Treinamentos:</strong></div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${progressoTreinamento}%; background: linear-gradient(90deg, #f59e0b, #d97706);">${progressoTreinamento}%</div>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

// ═══════════════════════════════════════════════════════
// 🏢 VISÃO POR TIMES
// ═══════════════════════════════════════════════════════

let timeAtualSelecionado = 'TODOS';
let timesChartInstance = null;

function atualizarVisaoTimes(timeFiltro = 'TODOS') {
  carregarDoStorage();
  timeAtualSelecionado = timeFiltro;
  
  let projetosFiltrados = AppState.implantacoes;
  
  if (timeFiltro !== 'TODOS') {
    projetosFiltrados = AppState.implantacoes.filter(imp => 
      imp.timeResponsavel === timeFiltro
    );
  }
  
  const total = projetosFiltrados.length;
  const emAndamento = projetosFiltrados.filter(p => 
    (p.status || 'Em Andamento') === 'Em Andamento'
  ).length;
  const finalizados = projetosFiltrados.filter(p => 
    p.status === 'Concluída'
  ).length;
  
  let progressoMedio = 0;
  if (total > 0) {
    const somaProgressos = projetosFiltrados.reduce((acc, imp) => 
      acc + calcularProgressoGeral(imp.id), 0
    );
    progressoMedio = Math.round(somaProgressos / total);
  }
  
  const countPorTime = {
    TODOS: AppState.implantacoes.length,
    SMB: AppState.implantacoes.filter(i => i.timeResponsavel === 'SMB').length,
    BASE: AppState.implantacoes.filter(i => i.timeResponsavel === 'BASE').length,
    KA: AppState.implantacoes.filter(i => i.timeResponsavel === 'KA').length
  };
  
  document.getElementById('count-todos').textContent = countPorTime.TODOS;
  document.getElementById('count-smb').textContent = countPorTime.SMB;
  document.getElementById('count-base').textContent = countPorTime.BASE;
  document.getElementById('count-ka').textContent = countPorTime.KA;
  
  document.getElementById('time-total').textContent = total;
  document.getElementById('time-andamento').textContent = emAndamento;
  document.getElementById('time-finalizados').textContent = finalizados;
  document.getElementById('time-progresso-medio').textContent = progressoMedio + '%';
  
  const titulosTime = {
    'TODOS': '📋 Todos os Projetos',
    'SMB': '🏪 Projetos do Time SMB',
    'BASE': '📊 Projetos do Time BASE',
    'KA': '⭐ Projetos do Time KA'
  };
  document.getElementById('times-titulo-lista').textContent = titulosTime[timeFiltro];
  
  renderizarGraficoTimes(projetosFiltrados);
  renderizarListaProjetos(projetosFiltrados, timeFiltro);
}

function filtrarPorTime(time) {
  document.querySelectorAll('.time-filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`[data-time="${time}"]`).classList.add('active');
  atualizarVisaoTimes(time);
}

function renderizarGraficoTimes(projetos) {
  const canvas = document.getElementById('timesStatusChart');
  if (!canvas) return;
  
  if (timesChartInstance) {
    timesChartInstance.destroy();
  }
  
  const ctx = canvas.getContext('2d');
  
  const emAndamento = projetos.filter(p => 
    (p.status || 'Em Andamento') === 'Em Andamento'
  ).length;
  const concluidos = projetos.filter(p => 
    p.status === 'Concluída'
  ).length;
  
  timesChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Em Andamento', 'Concluídos'],
      datasets: [{
        data: [emAndamento, concluidos],
        backgroundColor: [
          'rgba(245, 158, 11, 0.8)',
          'rgba(16, 185, 129, 0.8)'
        ],
        borderColor: [
          'rgba(245, 158, 11, 1)',
          'rgba(16, 185, 129, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: '#e5e7eb',
            font: { size: 13, weight: '600' },
            padding: 15
          }
        }
      }
    }
  });
}

function renderizarListaProjetos(projetos, timeFiltro) {
  const listaDiv = document.getElementById('times-projetos-lista');
  
  if (projetos.length === 0) {
    const nomeTime = timeFiltro === 'TODOS' ? 'nenhum time' : `time ${timeFiltro}`;
    listaDiv.innerHTML = `
      <div class="time-projeto-vazio">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
        </svg>
        <p>Nenhum projeto encontrado para ${nomeTime}</p>
      </div>
    `;
    return;
  }
  
  listaDiv.innerHTML = projetos.map(projeto => {
    const progresso = calcularProgressoGeral(projeto.id);
    const status = projeto.status || 'Em Andamento';
    const statusClass = status === 'Concluída' ? 'status-concluida' : 'status-andamento';
    
    const timeBadgeClasses = {
      'SMB': 'badge-smb',
      'BASE': 'badge-base',
      'KA': 'badge-ka'
    };
    const timeBadgeClass = timeBadgeClasses[projeto.timeResponsavel] || 'badge-smb';
    
    let analistasHTML = '';
    if (projeto.equipe && projeto.equipe.length > 0) {
      analistasHTML = `
        <div class="time-projeto-analistas">
          ${projeto.equipe.map(membro => {
            const inicial = membro.nome.charAt(0).toUpperCase();
            return `
              <div class="analista-chip">
                <div class="analista-avatar">${inicial}</div>
                <span>${membro.nome}</span>
              </div>
            `;
          }).join('')}
        </div>
      `;
    } else {
      analistasHTML = `
        <span style="color: #9ca3af; font-style: italic; font-size: 13px;">
          Nenhum analista atribuído
        </span>
      `;
    }
    
    return `
      <div class="time-projeto-card">
        <div class="time-projeto-header">
          <div class="time-projeto-titulo">
            <h5>Portal ${projeto.portal} - ${projeto.razao}</h5>
            <div class="time-projeto-subtitulo">
              Criado em ${projeto.dataCriacao || 'N/A'}
            </div>
          </div>
          <div class="time-projeto-badge ${timeBadgeClass}">
            ${projeto.timeResponsavel || 'N/A'}
          </div>
        </div>
        
        <div class="time-projeto-body">
          <div class="time-projeto-info">
            <strong>Gerente:</strong>
            <span>${projeto.gerente || 'Não informado'}</span>
          </div>
          
          <div class="time-projeto-info">
            <strong>Plano:</strong>
            <span>${projeto.planoComercial || 'Não informado'}</span>
          </div>
          
          <div class="time-projeto-info">
            <strong>Analista(s):</strong>
            ${analistasHTML}
          </div>
          
          <div class="time-projeto-info">
            <strong>Status:</strong>
            <span class="time-projeto-status ${statusClass}">
              ${status}
            </span>
          </div>
          
          <div class="time-projeto-progresso">
            <div class="progresso-label">
              <span style="color: #9ca3af; font-weight: 600;">Progresso Geral</span>
              <span style="color: #3b82f6; font-weight: 700;">${progresso}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progresso}%"></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// Migração automática
function migrarImplantacoesParaTimes() {
  carregarDoStorage();
  let houveAlteracao = false;
  
  AppState.implantacoes.forEach(imp => {
    if (!imp.timeResponsavel) {
      imp.timeResponsavel = 'SMB';
      houveAlteracao = true;
    }
  });
  
  if (houveAlteracao) {
    salvarNoStorage();
    console.log('✅ Implantações migradas com time padrão SMB');
  }
}

function initCharts() {
  const canvas = document.getElementById('progressChart');
  if(!canvas) {
    console.log('Canvas do gráfico não encontrado');
    return;
  }
  
  // ✅ GARANTIR destruição
  try {
    if(chartInstance) {
      chartInstance.destroy();
    }
  } catch(e) {
    console.warn('Erro ao destruir gráfico:', e);
  } finally {
    chartInstance = null;
  }
  
  const ctx = canvas.getContext('2d');
  // ... resto do código
}
  
  const ctx = canvas.getContext('2d');
  
  const labels = AppState.implantacoes.map(imp => imp.razao);
  const progressos = AppState.implantacoes.map(imp => calcularProgressoGeral(imp.id));

  const backgroundColors = progressos.map(value => {
    if (value >= 100) {
      return 'rgba(16, 185, 129, 0.6)';
    } else if (value >= 75) {
      return 'rgba(59, 130, 246, 0.6)';
    } else if (value >= 50) {
      return 'rgba(245, 158, 11, 0.6)';
    } else {
      return 'rgba(239, 68, 68, 0.6)';
    }
  });

  const borderColors = progressos.map(value => {
    if (value >= 100) {
      return 'rgba(16, 185, 129, 1)';
    } else if (value >= 75) {
      return 'rgba(59, 130, 246, 1)';
    } else if (value >= 50) {
      return 'rgba(245, 158, 11, 1)';
    } else {
      return 'rgba(239, 68, 68, 1)';
    }
  });

  // ⭐ ARMAZENAR INSTÂNCIA DO GRÁFICO
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Progresso (%)',
        data: progressos,
        backgroundColor: backgroundColors,
        borderColor: borderColors,
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            color: '#9ca3af'
          },
          grid: {
            color: 'rgba(75, 85, 99, 0.3)'
          }
        },
        x: {
          ticks: {
            color: '#9ca3af'
          },
          grid: {
            color: 'rgba(75, 85, 99, 0.3)'
          }
        }
      }
    }
  });

  addChartLegend();

function addChartLegend() {
  const chartContainer = document.querySelector('.chart-container');
  
  if (chartContainer.querySelector('.chart-legend')) return;
  
  const legend = document.createElement('div');
  legend.className = 'chart-legend';
  legend.innerHTML = `
    <span class="legend-item"><span class="legend-color" style="background: rgba(239, 68, 68, 0.8);"></span> 0-49% Atrasado</span>
    <span class="legend-item"><span class="legend-color" style="background: rgba(245, 158, 11, 0.8);"></span> 50-74% Em andamento</span>
    <span class="legend-item"><span class="legend-color" style="background: rgba(59, 130, 246, 0.8);"></span> 75-99% Quase pronto</span>
    <span class="legend-item"><span class="legend-color" style="background: rgba(16, 185, 129, 0.8);"></span> 100% Concluído</span>
  `;
  
  chartContainer.appendChild(legend);
}

// ===== ANALYTICS =====
function calcularAnalytics() {
  if(AppState.implantacoes.length === 0) return;
  
  const implantacoesConcluidas = AppState.implantacoes.filter(i => i.status === 'Concluída');
  
  const tempoMedioEl = document.getElementById('tempo-medio');
  if(tempoMedioEl && implantacoesConcluidas.length > 0) {
    let totalDias = 0;
    implantacoesConcluidas.forEach(imp => {
      const dataCriacao = new Date(imp.dataCriacao.split('/').reverse().join('-'));
      const dataConclusao = imp.dataConclusao ? new Date(imp.dataConclusao.split('/').reverse().join('-')) : new Date();
      const dias = Math.floor((dataConclusao - dataCriacao) / (1000 * 60 * 60 * 24));
      totalDias += dias;
    });
    const mediaDias = Math.round(totalDias / implantacoesConcluidas.length);
    tempoMedioEl.textContent = `${mediaDias} dias`;
  }
  
  const taxaSucessoEl = document.getElementById('taxa-sucesso');
  if(taxaSucessoEl) {
    const taxaSucesso = Math.round((implantacoesConcluidas.length / AppState.implantacoes.length) * 100);
    taxaSucessoEl.textContent = `${taxaSucesso}%`;
  }
  
  const projetosMesEl = document.getElementById('projetos-mes');
  if(projetosMesEl) {
    const mesAtual = new Date().getMonth();
    const anoAtual = new Date().getFullYear();
    const projetosMes = AppState.implantacoes.filter(imp => {
      const data = new Date(imp.dataCriacao.split('/').reverse().join('-'));
      return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
    }).length;
    projetosMesEl.textContent = projetosMes;
  }
}

// ===== GO LIVE E TERMO =====
function confirmarGoLive(id) {
  const imp = AppState.implantacoes.find(x => x.id === id);
  if(!imp) return;
  
  const dataAgendadaAtual = imp.dataAgendadaGoLive || '';
  const hoje = new Date().toISOString().split('T')[0];
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <div class="modal-icon">🚀</div>
        <div class="modal-title">Gerenciar GO LIVE</div>
      </div>
      <div class="modal-body">
        ${imp.goLiveRealizado ? `
          <div style="background:rgba(16,185,129,0.1);border:2px solid rgba(16,185,129,0.3);border-radius:12px;padding:20px;margin-bottom:20px;">
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
              <div style="width:50px;height:50px;background:linear-gradient(135deg,#10b981,#059669);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;">✓</div>
              <div>
                <h3 style="color:#10b981;margin:0;font-size:18px;">GO LIVE Realizado</h3>
                <p style="color:#6ee7b7;margin:5px 0 0 0;font-size:14px;">Data: ${imp.dataGoLive || 'Não informada'}</p>
              </div>
            </div>
            <p style="color:#d1d5db;font-size:14px;margin:0;">O sistema está oficialmente em produção no cliente desde esta data.</p>
          </div>
          <div style="display:flex;gap:10px;justify-content:center;">
            <button class="btn btn-warning" onclick="reagendarGoLive(${id})">📅 Reagendar GO LIVE</button>
            <button class="btn btn-danger" onclick="cancelarGoLive(${id})">✕ Cancelar GO LIVE</button>
            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Fechar</button>
          </div>
        ` : `
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:10px;color:#e5e7eb;font-weight:600;font-size:15px;">
              📅 Escolha uma opção:
            </label>
            
            <div style="display:flex;flex-direction:column;gap:15px;">
              <!-- Opção 1: Realizar Agora -->
              <div onclick="document.getElementById('opcao-agora').checked=true;atualizarOpcaoGoLive('agora')" style="cursor:pointer;background:rgba(16,185,129,0.08);border:2px solid rgba(16,185,129,0.15);border-radius:12px;padding:20px;transition:all 0.3s;" onmouseover="this.style.background='rgba(16,185,129,0.12)';this.style.borderColor='rgba(16,185,129,0.3)'" onmouseout="this.style.background='rgba(16,185,129,0.08)';this.style.borderColor='rgba(16,185,129,0.15)'">
                <div style="display:flex;align-items:center;gap:15px;">
                  <input type="radio" id="opcao-agora" name="opcao-golive" value="agora" style="width:20px;height:20px;cursor:pointer;" checked>
                  <div style="flex:1;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:5px;">
                      <span style="font-size:24px;">⚡</span>
                      <strong style="color:#10b981;font-size:16px;">Realizar GO LIVE Agora</strong>
                    </div>
                    <p style="color:#9ca3af;font-size:13px;margin:0;">O sistema entrará em produção imediatamente</p>
                  </div>
                </div>
              </div>
              
              <!-- Opção 2: Agendar -->
              <div onclick="document.getElementById('opcao-agendar').checked=true;atualizarOpcaoGoLive('agendar')" style="cursor:pointer;background:rgba(124,58,237,0.08);border:2px solid rgba(124,58,237,0.15);border-radius:12px;padding:20px;transition:all 0.3s;" onmouseover="this.style.background='rgba(124,58,237,0.12)';this.style.borderColor='rgba(124,58,237,0.3)'" onmouseout="this.style.background='rgba(124,58,237,0.08)';this.style.borderColor='rgba(124,58,237,0.15)'">
                <div style="display:flex;align-items:center;gap:15px;">
                  <input type="radio" id="opcao-agendar" name="opcao-golive" value="agendar" style="width:20px;height:20px;cursor:pointer;" ${dataAgendadaAtual ? 'checked' : ''}>
                  <div style="flex:1;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:5px;">
                      <span style="font-size:24px;">📅</span>
                      <strong style="color:#7c3aed;font-size:16px;">Agendar GO LIVE</strong>
                    </div>
                    <p style="color:#9ca3af;font-size:13px;margin:0;">Escolha uma data futura para o GO LIVE</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Campo de Data -->
          <div id="campo-data-golive" style="display:${dataAgendadaAtual ? 'block' : 'none'};margin-top:20px;background:rgba(124,58,237,0.05);border:2px solid rgba(124,58,237,0.2);border-radius:12px;padding:20px;">
            <label style="display:block;margin-bottom:10px;color:#7c3aed;font-weight:600;font-size:14px;">
              📆 Data do GO LIVE:
            </label>
            <input type="date" id="data-golive" min="${hoje}" value="${dataAgendadaAtual}" style="width:100%;padding:12px;border:2px solid rgba(124,58,237,0.3);border-radius:8px;font-size:14px;background:rgba(31,41,55,0.8);color:#e5e7eb;font-weight:600;">
            
            <div style="margin-top:15px;background:rgba(59,130,246,0.1);border-left:3px solid #3b82f6;padding:12px;border-radius:6px;">
              <p style="color:#93c5fd;font-size:12px;margin:0;display:flex;align-items:center;gap:8px;">
                <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 8v4l2 2"></path>
                </svg>
                <span>Você receberá notificações no dia agendado!</span>
              </p>
            </div>
          </div>
          
          ${dataAgendadaAtual ? `
            <div style="margin-top:20px;background:rgba(245,158,11,0.1);border:2px solid rgba(245,158,11,0.3);border-radius:12px;padding:15px;">
              <div style="display:flex;align-items:center;gap:10px;">
                <span style="font-size:20px;">⏰</span>
                <div>
                  <strong style="color:#f59e0b;font-size:14px;">GO LIVE já está agendado</strong>
<p style="color:#fbbf24;font-size:13px;margin:5px 0 0 0;">Data atual: ${formatarDataLocal(dataAgendadaAtual)}</p>
                </div>
              </div>
            </div>
          ` : ''}
          
          <div style="display:flex;gap:10px;justify-content:center;margin-top:30px;">
            <button class="btn btn-success" onclick="salvarGoLive(${id})">✓ Confirmar</button>
            <button class="btn btn-danger" onclick="this.closest('.modal-overlay').remove()">✗ Cancelar</button>
          </div>
        `}
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  const dataInput = document.getElementById('data-golive');
  if(dataInput && dataAgendadaAtual) {
    document.getElementById('opcao-agendar').checked = true;
    document.getElementById('campo-data-golive').style.display = 'block';
  }
}

function atualizarOpcaoGoLive(opcao) {
  const campoData = document.getElementById('campo-data-golive');
  if(opcao === 'agendar') {
    campoData.style.display = 'block';
  } else {
    campoData.style.display = 'none';
  }
}

function salvarGoLive(id) {
  const opcao = document.querySelector('input[name="opcao-golive"]:checked');
  if(!opcao) {
    showToast('Selecione uma opção!', 'warning');
    return;
  }
  
  const imp = AppState.implantacoes.find(x => x.id === id);
  if(!imp) return;
  
  if(opcao.value === 'agora') {
    imp.goLiveRealizado = true;
    imp.dataGoLive = new Date().toLocaleDateString('pt-BR');
    imp.dataAgendadaGoLive = null;
    
    document.querySelector('.modal-overlay').remove();
    criarConfete();
    verificarConclusaoTotal(id);
    salvarNoStorage();
    
    if(AppState.implantacaoAtualId === id) {
      carregarChecklist();
    }
    
    setTimeout(() => {
      showToast('🚀 GO LIVE confirmado com sucesso! O sistema está oficialmente em produção.', 'success', 'GO LIVE Realizado');
    }, 500);
    
  } else if(opcao.value === 'agendar') {
    const dataInput = document.getElementById('data-golive');
    if(!dataInput || !dataInput.value) {
      showToast('⚠️ Selecione uma data para o GO LIVE!', 'warning');
      return;
    }
    
    const dataEscolhida = new Date(dataInput.value + 'T00:00:00');
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
    if(dataEscolhida < hoje) {
      showToast('⚠️ A data do GO LIVE não pode ser no passado!', 'error');
      return;
    }
    
    imp.dataAgendadaGoLive = dataInput.value;
    imp.goLiveRealizado = false;
    
    document.querySelector('.modal-overlay').remove();
    salvarNoStorage();
    
    if(AppState.implantacaoAtualId === id) {
      carregarChecklist();
    }
    
const dataFormatada = formatarDataLocal(dataInput.value);
    showToast(`📅 GO LIVE agendado para ${dataFormatada}!\nVocê receberá notificações no dia.`, 'success', 'GO LIVE Agendado');
  }
  
  atualizarDashboard();
}

function reagendarGoLive(id) {
  const imp = AppState.implantacoes.find(x => x.id === id);
  if(!imp) return;
  
  imp.goLiveRealizado = false;
  imp.dataGoLive = null;
  
  document.querySelector('.modal-overlay').remove();
  salvarNoStorage();
  
  setTimeout(() => {
    confirmarGoLive(id);
  }, 300);
}

function cancelarGoLive(id) {
  if(!confirm('Tem certeza que deseja cancelar o GO LIVE realizado?')) return;
  
  const imp = AppState.implantacoes.find(x => x.id === id);
  if(!imp) return;
  
  imp.goLiveRealizado = false;
  imp.dataGoLive = null;
  imp.dataAgendadaGoLive = null;
  
  document.querySelector('.modal-overlay').remove();
  salvarNoStorage();
  
  if(AppState.implantacaoAtualId === id) {
    carregarChecklist();
  }
  
  showToast('GO LIVE cancelado com sucesso!', 'success');
  atualizarDashboard();
}

function verificarGoLivesAgendados() {
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  
  AppState.implantacoes.forEach(imp => {
    if(imp.dataAgendadaGoLive && !imp.goLiveRealizado) {
      const dataAgendada = new Date(imp.dataAgendadaGoLive + 'T00:00:00');
      const diffDias = Math.floor((dataAgendada - hoje) / (1000 * 60 * 60 * 24));
      
      // GO LIVE é HOJE
      if(diffDias === 0) {
        mostrarNotificacaoGoLive(imp, 'hoje');
      }
      // GO LIVE é AMANHÃ
      else if(diffDias === 1) {
        mostrarNotificacaoGoLive(imp, 'amanha');
      }
      // GO LIVE em 3 dias
      else if(diffDias === 3) {
        mostrarNotificacaoGoLive(imp, '3dias');
      }
      // GO LIVE em 7 dias
      else if(diffDias === 7) {
        mostrarNotificacaoGoLive(imp, '7dias');
      }
      // GO LIVE ATRASADO
      else if(diffDias < 0) {
        mostrarNotificacaoGoLive(imp, 'atrasado');
      }
    }
  });
}

function mostrarNotificacaoGoLive(imp, tipo) {
  const dataFormatada = new Date(imp.dataAgendadaGoLive).toLocaleDateString('pt-BR');
  
  const mensagens = {
    'hoje': {
      titulo: '🚀 GO LIVE HOJE!',
      mensagem: `${imp.razao} - GO LIVE agendado para HOJE (${dataFormatada})`,
      tipo: 'error',
      som: true
    },
    'amanha': {
      titulo: '⏰ GO LIVE Amanhã',
      mensagem: `${imp.razao} - GO LIVE agendado para AMANHÃ (${dataFormatada})`,
      tipo: 'warning',
      som: false
    },
    '3dias': {
      titulo: '📅 GO LIVE em 3 dias',
      mensagem: `${imp.razao} - GO LIVE agendado para ${dataFormatada}`,
      tipo: 'info',
      som: false
    },
    '7dias': {
      titulo: '📌 GO LIVE em 1 semana',
      mensagem: `${imp.razao} - GO LIVE agendado para ${dataFormatada}`,
      tipo: 'info',
      som: false
    },
    'atrasado': {
      titulo: '⚠️ GO LIVE ATRASADO!',
      mensagem: `${imp.razao} - GO LIVE estava agendado para ${dataFormatada}`,
      tipo: 'error',
      som: true
    }
  };
  
  const config = mensagens[tipo];
  showToast(config.mensagem, config.tipo, config.titulo);
  
  if(config.som) {
    tocarSomAlerta();
  }
}

// ===== SISTEMA DE SOM CORRIGIDO =====

// Variável global para AudioContext
let audioContextGlobal = null;
let audioHabilitado = false;

// Inicializar AudioContext após primeira interação do usuário
function inicializarAudioContext() {
  if (!audioContextGlobal && !audioHabilitado) {
    try {
      audioContextGlobal = new (window.AudioContext || window.webkitAudioContext)();
      audioHabilitado = true;
      console.log('✓ Áudio habilitado após interação do usuário');
    } catch(e) {
      console.log('⚠️ Áudio não suportado neste navegador');
    }
  }
}

// Detectar primeira interação para habilitar áudio
document.addEventListener('click', inicializarAudioContext, { once: true });
document.addEventListener('keydown', inicializarAudioContext, { once: true });

// ===== SUBSTITUIR A FUNÇÃO tocarSomAlerta =====
function tocarSomAlerta() {
  // Se áudio não foi habilitado, não tenta tocar
  if (!audioHabilitado || !audioContextGlobal) {
    console.log('ℹ️ Som desabilitado - aguardando interação do usuário');
    return;
  }
  
  try {
    // Verificar se contexto está suspenso
    if (audioContextGlobal.state === 'suspended') {
      audioContextGlobal.resume();
    }
    
    const oscillator1 = audioContextGlobal.createOscillator();
    const gainNode1 = audioContextGlobal.createGain();
    
    oscillator1.connect(gainNode1);
    gainNode1.connect(audioContextGlobal.destination);
    
    oscillator1.frequency.value = 800;
    oscillator1.type = 'sine';
    
    gainNode1.gain.setValueAtTime(0.3, audioContextGlobal.currentTime);
    gainNode1.gain.exponentialRampToValueAtTime(0.01, audioContextGlobal.currentTime + 0.3);
    
    oscillator1.start(audioContextGlobal.currentTime);
    oscillator1.stop(audioContextGlobal.currentTime + 0.3);
    
    // Segunda nota
    const oscillator2 = audioContextGlobal.createOscillator();
    const gainNode2 = audioContextGlobal.createGain();
    
    oscillator2.connect(gainNode2);
    gainNode2.connect(audioContextGlobal.destination);
    
    oscillator2.frequency.value = 1000;
    oscillator2.type = 'sine';
    
    gainNode2.gain.setValueAtTime(0.3, audioContextGlobal.currentTime + 0.1);
    gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContextGlobal.currentTime + 0.4);
    
    oscillator2.start(audioContextGlobal.currentTime + 0.1);
    oscillator2.stop(audioContextGlobal.currentTime + 0.4);
    
  } catch (e) {
    console.log('⚠️ Erro ao tocar som:', e.message);
  }
}

// ===== SUBSTITUIR A FUNÇÃO tocarSomNotificacao (do módulo Agenda) =====
function tocarSomNotificacao() {
  if (!audioHabilitado || !audioContextGlobal) {
    console.log('ℹ️ Som de notificação desabilitado');
    return;
  }
  
  try {
    if (audioContextGlobal.state === 'suspended') {
      audioContextGlobal.resume();
    }
    
    const oscillator1 = audioContextGlobal.createOscillator();
    const gainNode1 = audioContextGlobal.createGain();
    oscillator1.connect(gainNode1);
    gainNode1.connect(audioContextGlobal.destination);
    oscillator1.frequency.value = 800;
    oscillator1.type = 'sine';
    gainNode1.gain.setValueAtTime(0.3, audioContextGlobal.currentTime);
    gainNode1.gain.exponentialRampToValueAtTime(0.01, audioContextGlobal.currentTime + 0.3);
    oscillator1.start(audioContextGlobal.currentTime);
    oscillator1.stop(audioContextGlobal.currentTime + 0.3);
    
    const oscillator2 = audioContextGlobal.createOscillator();
    const gainNode2 = audioContextGlobal.createGain();
    oscillator2.connect(gainNode2);
    gainNode2.connect(audioContextGlobal.destination);
    oscillator2.frequency.value = 1000;
    oscillator2.type = 'sine';
    gainNode2.gain.setValueAtTime(0.3, audioContextGlobal.currentTime + 0.1);
    gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContextGlobal.currentTime + 0.4);
    oscillator2.start(audioContextGlobal.currentTime + 0.1);
    oscillator2.stop(audioContextGlobal.currentTime + 0.4);
  } catch (e) {
    console.log('⚠️ Erro ao tocar som de notificação:', e.message);
  }
}

function confirmarEnvioTermo(id) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon" style="background:linear-gradient(135deg, #6366f1, #4f46e5);">📧</div>
        <div class="modal-title" style="color:#6366f1;">Confirmar Envio do Termo</div>
      </div>
      <div class="modal-body">
        <p>Você está confirmando o <strong>envio do Termo de Encerramento</strong> ao cliente.</p>
        <p style="margin-top:15px;color:#60a5fa;">📋 Certifique-se de que o termo foi revisado e enviado corretamente.</p>
        <p style="margin-top:10px;">Deseja continuar?</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="executarEnvioTermo(${id})">✓ Sim, Termo Enviado</button>
        <button class="btn btn-danger" onclick="this.closest('.modal-overlay').remove()">✗ Cancelar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function executarEnvioTermo(id) {
  const imp = AppState.implantacoes.find(x => x.id === id);
  if(!imp) return;
  
  imp.termoEnviado = true;
  imp.dataEnvioTermo = new Date().toLocaleDateString('pt-BR');
  
  document.querySelector('.modal-overlay').remove();
  criarConfete();
  verificarConclusaoTotal(id);
  salvarNoStorage();
  
  if(AppState.implantacaoAtualId === id) {
    carregarChecklist();
  }
  
  setTimeout(() => {
    showToast('Envio do Termo confirmado! O cliente recebeu o Termo de Encerramento.', 'success', 'Termo Enviado');
  }, 500);
}

function verificarConclusaoTotal(id) {
  const imp = AppState.implantacoes.find(x => x.id === id);
  if(!imp) return;
  
  const progressoChecklist = calcularProgressoImplantacao(id);
  const progressoTreinamento = calcularProgressoTreinamento(id);
  
  if(progressoChecklist === 100 && 
     progressoTreinamento === 100 && 
     imp.goLiveRealizado && 
     imp.termoEnviado) {
    
    if(imp.status !== 'Concluída') {
      imp.status = 'Concluída';
      imp.dataConclusao = new Date().toLocaleDateString('pt-BR');
      
      setTimeout(() => {
        criarConfete();
        showToast('PARABÉNS! Projeto 100% CONCLUÍDO!\n\n✓ Checklist completo\n✓ Treinamentos finalizados\n✓ GO LIVE realizado\n✓ Termo enviado', 'success', 'Projeto Concluído');
      }, 300);
    }
  }
}

function criarConfete() {
  const colors = ['#10b981', '#6366f1', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
  
  for(let i = 0; i < 50; i++) {
    setTimeout(() => {
      const confete = document.createElement('div');
      confete.className = 'confetti';
      confete.style.left = Math.random() * 100 + '%';
      confete.style.background = colors[Math.floor(Math.random() * colors.length)];
      confete.style.animationDelay = Math.random() * 0.5 + 's';
      document.body.appendChild(confete);
      
      setTimeout(() => confete.remove(), 3000);
    }, i * 30);
  }
}

// ===== TOAST NOTIFICATIONS =====
function showToast(message, type = 'info', title = '') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icons = {
    success: '✓',
    error: '✕',
    warning: '⚠',
    info: 'ℹ'
  };
  
  const titles = {
    success: title || 'Sucesso',
    error: title || 'Erro',
    warning: title || 'Atenção',
    info: title || 'Informação'
  };
  
  toast.innerHTML = `
    <div class="toast-icon">${icons[type]}</div>
    <div class="toast-content">
      <div class="toast-title">${titles[type]}</div>
      <div class="toast-message">${message}</div>
    </div>
    <button class="toast-close" onclick="this.parentElement.remove()">×</button>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('removing');
    setTimeout(() => toast.remove(), 300);
  }, 5000);
}

// ===== NOTIFICAÇÕES =====
function toggleNotifications(event) {
  if(event) event.stopPropagation();
  
  const dropdown = document.getElementById('notifications-dropdown');
  if(dropdown) {
    dropdown.classList.toggle('active');
    
    if(dropdown.classList.contains('active')) {
      carregarNotificacoes();
    }
  }
}

function carregarNotificacoes() {
  const notificationsList = document.getElementById('notifications-list');
  const notifCount = document.getElementById('notif-count');
  
  if(!notificationsList) return;
  
  // Gerar notificações baseadas no estado atual
  const novasNotificacoes = gerarNotificacoesAtualizadas();
  
  // Mesclar com notificações armazenadas
  NotificationSystem.notificacoes = mesclarNotificacoes(NotificationSystem.notificacoes, novasNotificacoes);
  NotificationSystem.salvarNotificacoes();
  
  // Ordenar: não lidas primeiro, depois por timestamp
  const notificacoesOrdenadas = [...NotificationSystem.notificacoes].sort((a, b) => {
    if (a.lida !== b.lida) return a.lida ? 1 : -1;
    return new Date(b.timestamp) - new Date(a.timestamp);
  });
  
  // Atualizar contador
  const naoLidas = NotificationSystem.obterNaoLidas();
  if(notifCount) {
    if(naoLidas > 0) {
      notifCount.style.display = 'flex';
      notifCount.textContent = naoLidas;
    } else {
      notifCount.style.display = 'none';
    }
  }
  
  // Renderizar notificações
  if(notificacoesOrdenadas.length === 0) {
    notificationsList.innerHTML = `
      <div class="notifications-empty">
        <div class="notifications-empty-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5">
            <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 01-3.46 0"></path>
          </svg>
        </div>
        <div>Nenhuma notificação</div>
      </div>
    `;
  } else {
    notificationsList.innerHTML = notificacoesOrdenadas.map(notif => `
      <div class="notification-item ${notif.lida ? '' : 'unread'}" 
           data-notif-id="${notif.id}"
           style="position: relative;">
        <div class="notification-icon ${notif.tipo}">
          ${obterIconeNotificacao(notif.tipo)}
        </div>
        <div class="notification-content" style="flex: 1;" onclick="marcarNotificacaoComoLida(${notif.id}, ${notif.implantacaoId || null})">
          <div class="notification-text">${notif.texto}</div>
          <div class="notification-time">${notif.tempo}</div>
        </div>
        <button class="notification-delete-btn" 
                onclick="excluirNotificacao(event, ${notif.id})"
                title="Excluir notificação"
                style="all: unset; cursor: pointer; color: #9ca3af; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s; flex-shrink: 0; margin-left: 8px;"
                onmouseover="this.style.background='rgba(239,68,68,0.2)'; this.style.color='#ef4444'"
                onmouseout="this.style.background='transparent'; this.style.color='#9ca3af'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </button>
      </div>
    `).join('');
  }
}

function gerarNotificacoesAtualizadas() {
  const hoje = new Date();
  const notificacoes = [];
  
  AppState.implantacoes.forEach(imp => {
    const progressoChecklist = calcularProgressoImplantacao(imp.id);
    const progressoTreinamento = calcularProgressoTreinamento(imp.id);
    
    // Checklist quase completo (80-99%)
    if(progressoChecklist >= 80 && progressoChecklist < 100) {
      notificacoes.push({
        tipo: 'warning',
        texto: `${imp.razao} - Checklist ${progressoChecklist}% completo. Faltam apenas ${100 - progressoChecklist}%!`,
        tempo: 'Agora',
        implantacaoId: imp.id,
        prioridade: 2
      });
    }
    
    // Projeto atrasado
    if(imp.dataCriacao) {
      const dataCriacao = new Date(imp.dataCriacao.split('/').reverse().join('-'));
      const diasDecorridos = Math.floor((hoje - dataCriacao) / (1000 * 60 * 60 * 24));
      
      if(diasDecorridos > 30 && imp.status !== 'Concluída') {
        notificacoes.push({
          tipo: 'error',
          texto: `${imp.razao} - Projeto em andamento há ${diasDecorridos} dias`,
          tempo: 'Hoje',
          implantacaoId: imp.id,
          prioridade: 3
        });
      }
    }
    
    // GO LIVE pendente
    if(progressoChecklist === 100 && !imp.goLiveRealizado) {
      notificacoes.push({
        tipo: 'info',
        texto: `${imp.razao} - Checklist completo. Agende o GO LIVE!`,
        tempo: 'Hoje',
        implantacaoId: imp.id,
        prioridade: 2
      });
    }
    
    // Termo pendente
    if(imp.goLiveRealizado && !imp.termoEnviado) {
      notificacoes.push({
        tipo: 'info',
        texto: `${imp.razao} - GO LIVE realizado. Envie o termo de encerramento!`,
        tempo: 'Hoje',
        implantacaoId: imp.id,
        prioridade: 2
      });
    }
    
    // Projeto concluído recentemente
    if(progressoChecklist === 100 && progressoTreinamento === 100 && imp.status === 'Concluída') {
      notificacoes.push({
        tipo: 'success',
        texto: `${imp.razao} - Projeto concluído com sucesso!`,
        tempo: 'Recente',
        implantacaoId: imp.id,
        prioridade: 1
      });
    }
  });
  
  return notificacoes;
}

function mesclarNotificacoes(antigas, novas) {
  const mapaAntigas = new Map();
  
  // Mapear notificações antigas
  antigas.forEach(notif => {
    const chave = notif.chaveUnica || NotificationSystem.gerarChaveUnica(notif);
    mapaAntigas.set(chave, notif);
  });
  
  // Processar novas notificações
  novas.forEach(notif => {
    const chave = NotificationSystem.gerarChaveUnica(notif);
    
    // PULAR se foi descartada
    if (NotificationSystem.foiDescartada(notif)) {
      return;
    }
    
    const existente = mapaAntigas.get(chave);
    
    if (existente) {
      // Manter status de lida e timestamp original
      notif.id = existente.id;
      notif.lida = existente.lida;
      notif.timestamp = existente.timestamp;
      notif.chaveUnica = chave;
    } else {
      // Nova notificação
      notif.id = Date.now() + Math.random();
      notif.lida = false;
      notif.timestamp = new Date().toISOString();
      notif.chaveUnica = chave;
    }
    
    mapaAntigas.set(chave, notif);
  });
  
  return Array.from(mapaAntigas.values());
}

function obterIconeNotificacao(tipo) {
  const icones = {
    warning: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
    error: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
    info: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
    success: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>'
  };
  return icones[tipo] || icones.info;
}

function marcarNotificacaoComoLida(id, implantacaoId) {
  NotificationSystem.marcarComoLida(id);
  carregarNotificacoes();
  
  if (implantacaoId) {
    const dropdown = document.getElementById('notifications-dropdown');
    if (dropdown) dropdown.classList.remove('active');
    
    setTimeout(() => {
      acompanharImplantacao(implantacaoId);
    }, 300);
  }
}

function excluirNotificacao(event, id) {
  event.stopPropagation();
  
  const item = document.querySelector(`[data-notif-id="${id}"]`);
  if (item) {
    item.style.animation = 'slideOutRight 0.3s forwards';
    
    setTimeout(() => {
      NotificationSystem.excluirNotificacao(id);
      carregarNotificacoes();
      showToast('Notificação excluída', 'info');
    }, 300);
  }
}

function atualizarContadorNotificacoes() {
  const naoLidas = NotificationSystem.obterNaoLidas();
  const notifCount = document.getElementById('notif-count');
  
  if(notifCount) {
    if(naoLidas > 0) {
      notifCount.style.display = 'flex';
      notifCount.textContent = naoLidas;
    } else {
      notifCount.style.display = 'none';
    }
  }
}

function marcarComoLida(element) {
  element.classList.remove('unread');
  atualizarContadorNotificacoes();
}
  
  const notifCount = document.getElementById('notif-count');
  if(notifCount) {
    notifCount.style.display = 'none';
  }

function atualizarContadorNotificacoes() {
  const unreadItems = document.querySelectorAll('.notification-item.unread').length;
  const notifCount = document.getElementById('notif-count');
  
  if(notifCount) {
    if(unreadItems > 0) {
      notifCount.style.display = 'flex';
      notifCount.textContent = unreadItems;
    } else {
      notifCount.style.display = 'none';
    }
  }
}

document.addEventListener('click', (e) => {
  const notificationsBtn = document.getElementById('notifications-btn');
  const notificationsDropdown = document.getElementById('notifications-dropdown');
  
  if (notificationsDropdown && notificationsBtn && 
      !notificationsBtn.contains(e.target) && 
      !notificationsDropdown.contains(e.target)) {
    notificationsDropdown.classList.remove('active');
  }
});

setInterval(() => {
  const dropdown = document.getElementById('notifications-dropdown');
  if(dropdown && dropdown.classList.contains('active')) {
    carregarNotificacoes();
  } else {
    // Atualizar silenciosamente em background
    const novasNotificacoes = gerarNotificacoesAtualizadas();
    NotificationSystem.notificacoes = mesclarNotificacoes(NotificationSystem.notificacoes, novasNotificacoes);
    NotificationSystem.salvarNotificacoes();
    atualizarContadorNotificacoes();
  }
}, 30000);

// ===== LEMBRETES =====
function verificarLembretes() {
  const hoje = new Date();
  const lembretes = [];
  
  AppState.implantacoes.forEach(imp => {
    const progressoChecklist = calcularProgressoImplantacao(imp.id);
    
    if(progressoChecklist >= 80 && progressoChecklist < 100) {
      lembretes.push({
        tipo: 'warning',
        titulo: 'Checklist Quase Completo',
        mensagem: `${imp.razao} - Faltam apenas ${100 - progressoChecklist}% do checklist!`
      });
    }
    
    const dataCriacao = new Date(imp.dataCriacao.split('/').reverse().join('-'));
    const diasDecorridos = Math.floor((hoje - dataCriacao) / (1000 * 60 * 60 * 24));
    
    if(diasDecorridos > 30 && imp.status !== 'Concluída') {
      lembretes.push({
        tipo: 'error',
        titulo: 'Projeto Atrasado',
        mensagem: `${imp.razao} - Projeto em andamento há ${diasDecorridos} dias`
      });
    }
    
    if(progressoChecklist === 100 && !imp.goLiveRealizado) {
      lembretes.push({
        tipo: 'info',
        titulo: 'GO LIVE Pendente',
        mensagem: `${imp.razao} - Checklist completo. Agende o GO LIVE!`
      });
    }
  });
  
  return lembretes;
}

function mostrarLembretes() {
  const lembretes = verificarLembretes();
  
  if(lembretes.length > 0) {
    lembretes.forEach((lembrete, index) => {
      setTimeout(() => {
        showToast(lembrete.mensagem, lembrete.tipo, lembrete.titulo);
      }, index * 500);
    });
  }
}

// ===== THEME TOGGLE =====
function toggleTheme() {
  const body = document.body;
  const themeIconSvg = document.getElementById('theme-icon-svg');
  
  body.classList.toggle('light-mode');
  
  if(body.classList.contains('light-mode')) {
    if(themeIconSvg) {
      themeIconSvg.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
    }
    localStorage.setItem('theme', 'light');
  } else {
    if(themeIconSvg) {
      themeIconSvg.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>';
    }
    localStorage.setItem('theme', 'dark');
  }
}

function loadTheme() {
  const savedTheme = localStorage.getItem('theme');
  const body = document.body;
  const themeIconSvg = document.getElementById('theme-icon-svg');
  
  if(savedTheme === 'light') {
    body.classList.add('light-mode');
    if(themeIconSvg) {
      themeIconSvg.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
    }
  }
}

// ===== UPLOAD ZONE =====
function initUploadZone() {
  const uploadZone = document.getElementById('logo-upload-zone');
  const fileInput = document.getElementById('logo-input');
  
  if(!uploadZone || !fileInput) return;
  
  uploadZone.addEventListener('click', () => {
    fileInput.click();
  });
  
  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
  });
  
  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
  });
  
  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if(files.length > 0) {
      handleFileUpload(files[0]);
    }
  });
  
  fileInput.addEventListener('change', (e) => {
    if(e.target.files.length > 0) {
      handleFileUpload(e.target.files[0]);
    }
  });
}

function handleFileUpload(file) {
  if(file.size > 2 * 1024 * 1024) {
    showToast('Arquivo muito grande! Máximo 2MB', 'error');
    return;
  }
  
  if(!file.type.startsWith('image/')) {
    showToast('Por favor, selecione uma imagem válida', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    AppState.logoAtual = e.target.result;
    
    const previewContainer = document.getElementById('logo-preview-container');
    if(previewContainer) {
      previewContainer.style.display = 'flex';
      previewContainer.innerHTML = `
        <div class="preview-item">
          <img src="${e.target.result}" alt="Logo preview">
          <button class="preview-remove" onclick="removeLogoPreview()">×</button>
        </div>
      `;
    }
    
    showToast('Logo carregada com sucesso!', 'success');
  };
  reader.readAsDataURL(file);
}

function removeLogoPreview() {
  AppState.logoAtual = null;
  const previewContainer = document.getElementById('logo-preview-container');
  if(previewContainer) {
    previewContainer.innerHTML = '';
    previewContainer.style.display = 'none';
  }
  document.getElementById('logo-input').value = '';
}

// ===== VALIDATIONS =====
function initValidations() {
  const cnpjInputs = document.querySelectorAll('[id*="cnpj"]');
  cnpjInputs.forEach(input => {
    input.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      value = value.replace(/^(\d{2})(\d)/, '$1.$2');
      value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
      value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
      value = value.replace(/(\d{4})(\d)/, '$1-$2');
      e.target.value = value;
      
      if(value.length === 18) {
        e.target.classList.add('valid');
        e.target.classList.remove('invalid');
      } else if(value.length > 0) {
        e.target.classList.add('invalid');
        e.target.classList.remove('valid');
      }
    });
  });
  
  const telefoneInput = document.getElementById('contato-telefone');
  if(telefoneInput) {
    telefoneInput.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      value = value.replace(/^(\d{2})(\d)/, '($1) $2');
      value = value.replace(/(\d{5})(\d)/, '$1-$2');
      e.target.value = value;
    });
  }
  
  const emailInputs = document.querySelectorAll('input[type="email"]');
  emailInputs.forEach(input => {
    input.addEventListener('blur', (e) => {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if(emailRegex.test(e.target.value)) {
        e.target.classList.add('valid');
        e.target.classList.remove('invalid');
      } else if(e.target.value.length > 0) {
        e.target.classList.add('invalid');
        e.target.classList.remove('valid');
      }
    });
  });
}

// ===== EXPORT FUNCTIONS =====
function toggleExportMenu() {
  const menu = document.querySelector('.export-menu');
  if(menu) menu.classList.toggle('active');
}

document.addEventListener('click', (e) => {
  const menu = document.querySelector('.export-menu');
  if(menu && !menu.contains(e.target)) {
    menu.classList.remove('active');
  }
});

function exportarPDF() {
  showToast('Funcionalidade em desenvolvimento. Use a exportação para Excel ou JSON.', 'info');
  toggleExportMenu();
}

function exportarRelatorioPersonalizado() {
  // Modal para escolher campos
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <button class="profile-close" onclick="this.closest('.modal-overlay').remove()">×</button>
      
      <div class="modal-header">
        <div class="modal-icon" style="background: linear-gradient(135deg, #7c3aed, #6d28d9);">📋</div>
        <h3 class="modal-title" style="color: #7c3aed;">Relatório Personalizado</h3>
      </div>
      
      <div class="modal-body">
        <p style="color: #9ca3af; margin-bottom: 20px;">
          Selecione os campos que deseja incluir no relatório:
        </p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 400px; overflow-y: auto;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="portal" checked> Portal
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="razao" checked> Razão Social
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="cnpj" checked> CNPJ
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="status" checked> Status
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="progresso" checked> Progresso
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="time"> Time Responsável
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="gerente"> Gerente
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="dataCriacao"> Data Criação
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="modulos"> Módulos
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="contato"> Contato
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="golive"> Go Live
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" value="checklist"> Checklist
          </label>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
          Cancelar
        </button>
        <button class="btn btn-success" onclick="gerarRelatorioPersonalizado(this)">
          📊 Gerar Relatório
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function gerarRelatorioPersonalizado(btn) {
  const modal = btn.closest('.modal-overlay');
  const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
  const camposSelecionados = Array.from(checkboxes).map(cb => cb.value);
  
  if (camposSelecionados.length === 0) {
    showToast('Selecione pelo menos um campo!', 'warning');
    return;
  }
  
  const mapeamento = {
    portal: imp => imp.portal,
    razao: imp => imp.razao,
    cnpj: imp => imp.cnpjs,
    status: imp => imp.status,
    progresso: imp => calcularProgresso(imp.id) + '%',
    time: imp => imp.timeResponsavel,
    gerente: imp => imp.gerente,
    dataCriacao: imp => imp.dataCriacao,
    modulos: imp => imp.modulos?.join('; '),
    contato: imp => `${imp.contatoNome} - ${imp.contatoTelefone}`,
    golive: imp => imp.goLiveData || 'Pendente',
    checklist: imp => {
      const total = obterChecklistCompleto(imp.id).length;
      const concluido = obterChecklistCompleto(imp.id).filter((_, idx) => 
        AppState.checklistStatus[imp.id]?.[idx]
      ).length;
      return `${concluido}/${total}`;
    }
  };
  
  const dados = AppState.implantacoes.map(imp => {
    const obj = {};
    camposSelecionados.forEach(campo => {
      const label = campo.charAt(0).toUpperCase() + campo.slice(1);
      obj[label] = mapeamento[campo](imp) || '';
    });
    return obj;
  });
  
  const headers = Object.keys(dados[0]);
  const csv = [
    headers.join(','),
    ...dados.map(row => 
      headers.map(h => `"${String(row[h]).replace(/"/g, '""')}"`).join(',')
    )
  ].join('\n');
  
  const BOM = '\uFEFF';
  const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `SGI_Relatorio_Personalizado_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  
  modal.remove();
  showToast('📊 Relatório personalizado gerado!', 'success');
}

function exportarExcel() {
  // Gerar dados detalhados
  const dados = AppState.implantacoes.map(imp => {
    const progresso = calcularProgresso(imp.id);
    const checklist = obterChecklistCompleto(imp.id);
    const checklistConcluidos = checklist.filter((_, idx) => 
      AppState.checklistStatus[imp.id]?.[idx]
    ).length;
    
    return {
      'Portal': imp.portal || '',
      'Razão Social': imp.razao || '',
      'CNPJ': imp.cnpjs || '',
      'Empresa': imp.empresa || '',
      'Status': imp.status || 'Em Andamento',
      'Progresso (%)': progresso,
      'Data Criação': imp.dataCriacao || '',
      'Time Responsável': imp.timeResponsavel || '',
      'Gerente': imp.gerente || '',
      'Plano Comercial': imp.planoComercial || '',
      'Módulos': imp.modulos?.join('; ') || '',
      'Checklist Total': checklist.length,
      'Checklist Concluído': checklistConcluidos,
      'Ambiente': imp.ambiente || '',
      'Série NF-e': imp.serieNFe || '',
      'Série NFC-e': imp.serieNFCe || '',
      'Contato Nome': imp.contatoNome || '',
      'Contato Telefone': imp.contatoTelefone || '',
      'Go Live': imp.goLiveData || 'Pendente',
      'Termo Enviado': imp.termoEnviado ? 'Sim' : 'Não'
    };
  });
  
  if (dados.length === 0) {
    showToast('Nenhuma implantação para exportar!', 'warning');
    return;
  }
  
  // Converter para CSV
  const headers = Object.keys(dados[0]);
  const csv = [
    headers.join(','),
    ...dados.map(row => 
      headers.map(h => `"${String(row[h]).replace(/"/g, '""')}"`).join(',')
    )
  ].join('\n');
  
  // Adicionar BOM para UTF-8
  const BOM = '\uFEFF';
  const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  const dataAtual = new Date().toISOString().split('T')[0];
  link.setAttribute('href', url);
  link.setAttribute('download', `SGI_Relatorio_Completo_${dataAtual}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showToast('📊 Relatório exportado com sucesso!', 'success');
  
  registrarAlteracao('relatorio', 'Relatório Excel exportado');
}

function exportarJSON() {
  const data = {
    implantacoes: AppState.implantacoes,
    checklistStatus: AppState.checklistStatus,
    treinamentos: AppState.treinamentos,
    exportDate: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `backup_sgi_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  
  showToast('Backup JSON criado com sucesso!', 'success');
  toggleExportMenu();
}

// ===== PERFIL =====
function abrirPerfil() {
  const usuarioLogado = localStorage.getItem("usuarioLogado") || "admin";
  const avatar = usuarioLogado.charAt(0).toUpperCase();
  
  const profileAvatarLarge = document.getElementById('profile-avatar-large');
  const profileName = document.getElementById('profile-name');
  const profileUsername = document.getElementById('profile-username');
  
  // Carregar foto de perfil se existir
  const fotoPerfil = localStorage.getItem('fotoPerfil_' + usuarioLogado);
  if(fotoPerfil) {
    if(profileAvatarLarge) {
      profileAvatarLarge.innerHTML = `<img src="${fotoPerfil}" alt="Foto de perfil">`;
    }
    const removeBtn = document.getElementById('profile-photo-remove-btn');
    if(removeBtn) removeBtn.style.display = 'flex';
  } else {
    if(profileAvatarLarge) profileAvatarLarge.textContent = avatar;
  }
  
  if(profileName) profileName.textContent = usuarioLogado;
  if(profileUsername) profileUsername.textContent = usuarioLogado;
  
  const profileTotalProjects = document.getElementById('profile-total-projects');
  const profileCompleted = document.getElementById('profile-completed');
  const profileInProgress = document.getElementById('profile-in-progress');
  
  if(profileTotalProjects) profileTotalProjects.textContent = AppState.implantacoes.length;
  if(profileCompleted) profileCompleted.textContent = AppState.implantacoes.filter(i => i.status === 'Concluída').length;
  if(profileInProgress) profileInProgress.textContent = AppState.implantacoes.filter(i => i.status !== 'Concluída').length;
  
  const profileLastAccess = document.getElementById('profile-last-access');
  if(profileLastAccess) {
    profileLastAccess.textContent = new Date().toLocaleString('pt-BR', {
      day: '2-digit',
      month: 'long',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  // Calcular "Membro desde" dinamicamente
  const profileMemberSince = document.getElementById('profile-member-since');
  if(profileMemberSince) {
    const usuario = AppState.usuarios.find(u => u.user === usuarioLogado);
    if(usuario && usuario.dataCriacao) {
      const dataCriacao = new Date(usuario.dataCriacao);
      profileMemberSince.textContent = dataCriacao.toLocaleDateString('pt-BR', {
        month: 'long',
        year: 'numeric'
      });
    } else {
      profileMemberSince.textContent = 'Recentemente';
    }
  }
  
  const profileModal = document.getElementById('profile-modal');
  if(profileModal) profileModal.classList.add('active');
  
  const userMenu = document.getElementById('user-menu');
  if(userMenu) userMenu.classList.remove('active');
}

function fecharPerfil() {
  const profileModal = document.getElementById('profile-modal');
  if(profileModal) profileModal.classList.remove('active');
}

document.addEventListener('click', (e) => {
  const userMenu = document.getElementById('user-menu');
  if (userMenu && !userMenu.contains(e.target)) {
    userMenu.classList.remove('active');
  }
});

// ===== UPLOAD DE FOTO DE PERFIL =====
function handleProfilePhotoUpload(event) {
  const file = event.target.files[0];
  if(!file) return;
  
  if(file.size > 5 * 1024 * 1024) {
    showToast('Arquivo muito grande! Máximo 5MB', 'error');
    return;
  }
  
  if(!file.type.startsWith('image/')) {
    showToast('Por favor, selecione uma imagem válida', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const usuarioLogado = localStorage.getItem("usuarioLogado") || "admin";
    const fotoBase64 = e.target.result;
    
    // Salvar foto no localStorage
    localStorage.setItem('fotoPerfil_' + usuarioLogado, fotoBase64);
    
    // Atualizar avatar no modal
    const profileAvatarLarge = document.getElementById('profile-avatar-large');
    if(profileAvatarLarge) {
      profileAvatarLarge.innerHTML = `<img src="${fotoBase64}" alt="Foto de perfil">`;
    }
    
    // Atualizar avatar no header
    const userAvatar = document.getElementById('user-avatar');
    if(userAvatar) {
      userAvatar.style.backgroundImage = `url(${fotoBase64})`;
      userAvatar.style.backgroundSize = 'cover';
      userAvatar.style.backgroundPosition = 'center';
      userAvatar.textContent = '';
    }
    
    // Mostrar botão de remover
    const removeBtn = document.getElementById('profile-photo-remove-btn');
    if(removeBtn) removeBtn.style.display = 'flex';
    
    showToast('Foto de perfil atualizada com sucesso!', 'success');
  };
  
  reader.readAsDataURL(file);
  
  // Limpar input
  event.target.value = '';
}

function removerFotoPerfil() {
  if(!confirm('Deseja remover sua foto de perfil?')) return;
  
  const usuarioLogado = localStorage.getItem("usuarioLogado") || "admin";
  
  // Remover do localStorage
  localStorage.removeItem('fotoPerfil_' + usuarioLogado);
  
  const avatar = usuarioLogado.charAt(0).toUpperCase();
  
  // Restaurar avatar no modal
  const profileAvatarLarge = document.getElementById('profile-avatar-large');
  if(profileAvatarLarge) {
    profileAvatarLarge.innerHTML = avatar;
  }
  
  // Restaurar avatar no header
  const userAvatar = document.getElementById('user-avatar');
  if(userAvatar) {
    userAvatar.style.backgroundImage = 'none';
    userAvatar.textContent = avatar;
  }
  
  // Ocultar botão de remover
  const removeBtn = document.getElementById('profile-photo-remove-btn');
  if(removeBtn) removeBtn.style.display = 'none';
  
  showToast('Foto de perfil removida!', 'success');
}

function carregarFotoPerfilHeader() {
  const usuarioLogado = localStorage.getItem("usuarioLogado");
  if(!usuarioLogado) return;
  
  const fotoPerfil = localStorage.getItem('fotoPerfil_' + usuarioLogado);
  const userAvatar = document.getElementById('user-avatar');
  
  if(fotoPerfil && userAvatar) {
    userAvatar.style.backgroundImage = `url(${fotoPerfil})`;
    userAvatar.style.backgroundSize = 'cover';
    userAvatar.style.backgroundPosition = 'center';
    userAvatar.textContent = '';
  }
}

// ===== INICIALIZAÇÃO =====
window.addEventListener('load', function() {
  inicializarVariaveis();
  loadTheme();
  setTimeout(() => {
  NotificationSystem.init();
  atualizarContadorNotificacoes();
}, 1000);
  
  const usuarioLogado = localStorage.getItem("usuarioLogado");

  if(usuarioLogado) {
    document.body.classList.add('new-layout');
    
    const avatar = usuarioLogado.charAt(0).toUpperCase();
    const userAvatar = document.getElementById('user-avatar');
    const userNameDisplay = document.getElementById('user-name-display');
    
    if(userAvatar) userAvatar.textContent = avatar;
    if(userNameDisplay) userNameDisplay.textContent = usuarioLogado;
    
    carregarFotoPerfilHeader();
    
    verificarGoLivesAgendados();
    setInterval(verificarGoLivesAgendados, 3600000); // A cada 1 hora
    
    document.getElementById("login-wrapper").style.display = "none";
    document.getElementById("app").style.display = "block";
    carregarDoStorage();
    atualizarDashboard();
    carregarEditorChecklistPadrao();
    carregarEditorChecklistOptico();
    
    initUploadZone();
    initValidations();
    
    setTimeout(() => {
      initCharts();
      calcularAnalytics();
      mostrarLembretes();
    }, 500);
    
    setTimeout(() => {
      navigateTo('dashboard');
    }, 100);
  }
});

// Auto-save a cada 30 segundos
setInterval(() => {
  if (document.getElementById("app").style.display === "block") {
    salvarNoStorage();
  }
}, 30000);

// ===== SERVICE WORKER (PWA) =====
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('✅ PWA instalado com sucesso!', registration);
        showToast('App instalado! Pode usar offline agora 📱', 'success');
      })
      .catch(error => {
        console.log('❌ Erro ao instalar PWA:', error);
      });
  });
}

// Detectar quando o app fica offline/online
window.addEventListener('online', () => {
  showToast('🟢 Você está online novamente!', 'success');
});

window.addEventListener('offline', () => {
  showToast('🔴 Você está offline. Os dados serão salvos localmente.', 'warning');
});

</script>

<!-- FOOTER -->

<!-- ====================================== -->
<!-- MÓDULO DE AGENDA INTEGRADA - INÍCIO -->
<!-- ====================================== -->

<style>
/* ===== MÓDULO DE AGENDA - ESTILOS ===== */
.agenda-container {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.95), rgba(17, 24, 39, 0.98));
  border: 2px solid rgba(124, 58, 237, 0.3);
  border-radius: 20px;
  padding: 30px;
  margin: 20px 0;
  position: relative;
  overflow: hidden;
  animation: slideUp 0.5s ease-out;
}

.agenda-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 15px;
}

.agenda-title {
  display: flex;
  align-items: center;
  gap: 15px;
}

.agenda-icon {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #7c3aed, #6d28d9);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
  animation: pulse 2s infinite;
}

.agenda-title h3 {
  color: #7c3aed;
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.agenda-subtitle {
  color: #9ca3af;
  font-size: 13px;
  margin-top: 5px;
}

.agenda-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.sync-button {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.sync-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
}

.sync-button.syncing {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  pointer-events: none;
}

.sync-button.syncing svg {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.agenda-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 30px;
}

.agenda-stat-card {
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
  border: 2px solid rgba(124, 58, 237, 0.2);
  border-radius: 15px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.agenda-stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(124, 58, 237, 0.2), transparent);
  transition: left 0.5s;
}

.agenda-stat-card:hover::before {
  left: 100%;
}

.agenda-stat-card:hover {
  transform: translateY(-5px);
  border-color: rgba(124, 58, 237, 0.6);
  box-shadow: 0 12px 30px rgba(124, 58, 237, 0.3);
}

.agenda-stat-icon {
  font-size: 32px;
  margin-bottom: 10px;
}

.agenda-stat-value {
  font-size: 36px;
  font-weight: 800;
  color: #7c3aed;
  margin: 10px 0;
  text-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
}

.agenda-stat-label {
  font-size: 12px;
  color: #9ca3af;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.agenda-timeline {
  position: relative;
  padding-left: 40px;
  margin: 30px 0;
}

.timeline-line {
  position: absolute;
  left: 20px;
  top: 0;
  bottom: 0;
  width: 3px;
  background: linear-gradient(180deg, #7c3aed, #10b981);
  border-radius: 10px;
}

.timeline-item {
  position: relative;
  margin-bottom: 30px;
  background: linear-gradient(145deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
  border: 2px solid rgba(124, 58, 237, 0.2);
  border-radius: 15px;
  padding: 20px;
  transition: all 0.3s;
  animation: slideInRight 0.5s ease-out;
}

.timeline-item:hover {
  transform: translateX(10px);
  border-color: rgba(124, 58, 237, 0.6);
  box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
}

.timeline-marker {
  position: absolute;
  left: -29px;
  top: 25px;
  width: 18px;
  height: 18px;
  background: linear-gradient(135deg, #7c3aed, #6d28d9);
  border: 3px solid rgba(17, 24, 39, 0.98);
  border-radius: 50%;
  box-shadow: 0 0 20px rgba(124, 58, 237, 0.6);
  z-index: 10;
}

.timeline-marker.active {
  animation: pulse 2s infinite;
  background: linear-gradient(135deg, #10b981, #059669);
  box-shadow: 0 0 30px rgba(16, 185, 129, 0.8);
}

.timeline-marker.completed {
  background: linear-gradient(135deg, #10b981, #059669);
}

.timeline-marker.pending {
  background: linear-gradient(135deg, #6b7280, #4b5563);
}

.timeline-time {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.timeline-time-badge {
  background: rgba(124, 58, 237, 0.2);
  color: #7c3aed;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 6px;
}

.timeline-status {
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.timeline-status.em-andamento {
  background: rgba(59, 130, 246, 0.2);
  color: #3b82f6;
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.timeline-status.concluido {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.timeline-status.pendente {
  background: rgba(156, 163, 175, 0.2);
  color: #9ca3af;
  border: 1px solid rgba(156, 163, 175, 0.3);
}

.timeline-content h4 {
  color: #e5e7eb;
  margin: 0 0 10px 0;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.timeline-content p {
  color: #9ca3af;
  margin: 5px 0;
  font-size: 14px;
  line-height: 1.6;
}

.timeline-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.timeline-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.timeline-btn-primary {
  background: linear-gradient(135deg, #7c3aed, #6d28d9);
  color: white;
}

.timeline-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
}

.timeline-btn-success {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}

.timeline-btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.proximas-atividades {
  background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.2));
  border: 2px solid rgba(59, 130, 246, 0.3);
  border-radius: 15px;
  padding: 25px;
  margin: 20px 0;
}

.proximas-atividades h4 {
  color: #3b82f6;
  margin: 0 0 20px 0;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.atividade-card {
  background: rgba(31, 41, 55, 0.8);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 15px;
  transition: all 0.3s;
  cursor: pointer;
}

.atividade-card:hover {
  transform: translateX(5px);
  border-color: rgba(59, 130, 246, 0.5);
  background: rgba(31, 41, 55, 0.95);
}

.atividade-time {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  padding: 10px 15px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 14px;
  text-align: center;
  min-width: 80px;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.atividade-content {
  flex: 1;
}

.atividade-title {
  color: #e5e7eb;
  margin: 0 0 5px 0;
  font-size: 15px;
  font-weight: 600;
}

.atividade-description {
  color: #9ca3af;
  margin: 0;
  font-size: 13px;
}

.alerta-flutuante {
  position: fixed;
  top: 80px;
  right: 20px;
  background: linear-gradient(145deg, rgba(239, 68, 68, 0.98), rgba(220, 38, 38, 0.98));
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 15px;
  padding: 20px 25px;
  box-shadow: 0 15px 50px rgba(239, 68, 68, 0.5);
  z-index: 10000;
  min-width: 350px;
  max-width: 450px;
  animation: alertSlideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  backdrop-filter: blur(10px);
}

@keyframes alertSlideIn {
  from {
    transform: translateX(500px) rotate(10deg);
    opacity: 0;
  }
  to {
    transform: translateX(0) rotate(0);
    opacity: 1;
  }
}

.alerta-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}

.alerta-icon {
  width: 50px;
  height: 50px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  animation: bounce 2s infinite;
}

.alerta-title {
  flex: 1;
}

.alerta-title h4 {
  color: white;
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.alerta-subtitle {
  color: rgba(255, 255, 255, 0.9);
  font-size: 12px;
  margin: 3px 0 0 0;
}

.alerta-close {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 30px;
  height: 30px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.alerta-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.alerta-body {
  color: white;
  font-size: 14px;
  line-height: 1.6;
  margin-bottom: 15px;
}

.alerta-actions {
  display: flex;
  gap: 10px;
}

.alerta-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
}

.alerta-btn-primary {
  background: white;
  color: #ef4444;
}

.alerta-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(255, 255, 255, 0.3);
}

.alerta-btn-secondary {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.alerta-btn-secondary:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

@media (max-width: 768px) {
  .agenda-stats {
    grid-template-columns: 1fr;
  }
  
  .alerta-flutuante {
    right: 10px;
    left: 10px;
    min-width: auto;
  }
  
  .timeline-item {
    padding: 15px;
  }
  
  .atividade-card {
    flex-direction: column;
    text-align: center;
  }
}

/* ═══════════════════════════════════════════════════════ */
/* VISÃO POR TIMES */
/* ═══════════════════════════════════════════════════════ */

.times-filter-container {
  background: rgba(31, 41, 55, 0.6);
  border: 1px solid rgba(124, 58, 237, 0.3);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 30px;
}

.times-filter-label {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #9ca3af;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 15px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.times-filter-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}

.time-filter-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 20px;
  background: rgba(17, 24, 39, 0.8);
  border: 2px solid rgba(75, 85, 99, 0.3);
  border-radius: 10px;
  color: #e5e7eb;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.time-filter-btn:hover {
  border-color: rgba(124, 58, 237, 0.6);
  background: rgba(17, 24, 39, 0.95);
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(124, 58, 237, 0.2);
}

.time-filter-btn.active {
  background: linear-gradient(135deg, #7c3aed, #6d28d9);
  border-color: #7c3aed;
  box-shadow: 0 8px 20px rgba(124, 58, 237, 0.4);
}

.filter-icon {
  font-size: 20px;
}

.filter-count {
  margin-left: auto;
  background: rgba(255, 255, 255, 0.2);
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
}

.times-dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.time-metric-card {
  background: rgba(31, 41, 55, 0.9);
  border: 1px solid rgba(75, 85, 99, 0.3);
  border-radius: 12px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  transition: all 0.3s ease;
}

.time-metric-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
}

.metric-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
}

.metric-info {
  flex: 1;
}

.metric-value {
  font-size: 32px;
  font-weight: 700;
  color: #e5e7eb;
  margin-bottom: 6px;
}

.metric-label {
  font-size: 13px;
  color: #9ca3af;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.times-chart-container {
  background: rgba(31, 41, 55, 0.9);
  border: 1px solid rgba(75, 85, 99, 0.3);
  border-radius: 12px;
  padding: 25px;
  margin-bottom: 30px;
}

.times-projetos-section {
  background: rgba(31, 41, 55, 0.6);
  border: 1px solid rgba(75, 85, 99, 0.3);
  border-radius: 12px;
  padding: 25px;
}

#times-projetos-lista {
  display: grid;
  gap: 16px;
}

.time-projeto-card {
  background: rgba(17, 24, 39, 0.9);
  border: 1px solid rgba(75, 85, 99, 0.3);
  border-radius: 10px;
  padding: 20px;
  transition: all 0.3s ease;
}

.time-projeto-card:hover {
  border-color: rgba(124, 58, 237, 0.5);
  transform: translateX(4px);
}

.time-projeto-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(75, 85, 99, 0.3);
}

.time-projeto-titulo h5 {
  color: #e5e7eb;
  font-size: 16px;
  margin: 0 0 6px 0;
}

.time-projeto-subtitulo {
  color: #9ca3af;
  font-size: 13px;
}

.time-projeto-badge {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
}

.badge-smb {
  background: rgba(59, 130, 246, 0.2);
  color: #3b82f6;
  border: 1px solid rgba(59, 130, 246, 0.4);
}

.badge-base {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
  border: 1px solid rgba(16, 185, 129, 0.4);
}

.badge-ka {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
  border: 1px solid rgba(245, 158, 11, 0.4);
}

.time-projeto-body {
  display: grid;
  gap: 12px;
}

.time-projeto-info {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #d1d5db;
  font-size: 14px;
}

.time-projeto-info strong {
  color: #9ca3af;
  font-weight: 600;
  min-width: 100px;
}

.time-projeto-analistas {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 4px;
}

.analista-chip {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, #7c3aed, #6d28d9);
  color: white;
  padding: 6px 12px;
  border-radius: 16px;
  font-size: 12px;
  font-weight: 600;
}

.analista-avatar {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
}

.time-projeto-status {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.status-andamento {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
}

.status-concluida {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
}

.time-projeto-progresso {
  margin-top: 12px;
}

.progresso-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 13px;
}

.time-projeto-vazio {
  text-align: center;
  padding: 60px 20px;
  color: #9ca3af;
}

</style>

<script>

// ===== VALIDAÇÃO DE EMAIL =====
function validarEmail(email) {
  const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return regex.test(email);
}

function validarEmailCampo(input) {
  const email = input.value.trim();
  
  if (email.length === 0) {
    input.style.borderColor = '#374151';
    return true;
  }
  
  if (!validarEmail(email)) {
    input.style.borderColor = '#ef4444';
    showToast('❌ Email inválido!', 'error');
    return false;
  }
  
  input.style.borderColor = '#10b981';
  return true;
}

// ===== VALIDAÇÃO DE CNPJ =====
function validarCNPJ(cnpj) {
  // Remove caracteres não numéricos
  cnpj = cnpj.replace(/[^\d]+/g, '');
  
  // Valida tamanho
  if (cnpj.length !== 14) return false;
  
  // Verifica se todos os dígitos são iguais
  if (/^(\d)\1+$/.test(cnpj)) return false;
  
  // Validação dos dígitos verificadores
  let tamanho = cnpj.length - 2;
  let numeros = cnpj.substring(0, tamanho);
  let digitos = cnpj.substring(tamanho);
  let soma = 0;
  let pos = tamanho - 7;
  
  for (let i = tamanho; i >= 1; i--) {
    soma += numeros.charAt(tamanho - i) * pos--;
    if (pos < 2) pos = 9;
  }
  
  let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
  if (resultado != digitos.charAt(0)) return false;
  
  tamanho = tamanho + 1;
  numeros = cnpj.substring(0, tamanho);
  soma = 0;
  pos = tamanho - 7;
  
  for (let i = tamanho; i >= 1; i--) {
    soma += numeros.charAt(tamanho - i) * pos--;
    if (pos < 2) pos = 9;
  }
  
  resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
  return resultado == digitos.charAt(1);
}

function validarCNPJCampoGenerico(input) {
  const cnpj = input.value.replace(/\D/g, '');
  
  // Encontra o span de erro mais próximo
  let errorSpan = input.nextElementSibling;
  while (errorSpan && !errorSpan.classList.contains('input-error')) {
    errorSpan = errorSpan.nextElementSibling;
  }
  
  if (!errorSpan) {
    errorSpan = document.createElement('span');
    errorSpan.className = 'input-error';
    input.parentNode.insertBefore(errorSpan, input.nextSibling);
  }
  
  if (cnpj.length === 0) {
    errorSpan.textContent = '';
    input.style.borderColor = '#374151';
    return true;
  }
  
  if (!validarCNPJ(cnpj)) {
    errorSpan.textContent = '❌ CNPJ inválido';
    errorSpan.style.color = '#ef4444';
    input.style.borderColor = '#ef4444';
    input.classList.add('invalid');
    input.classList.remove('valid');
    return false;
  }
  
  errorSpan.textContent = '✅ CNPJ válido';
  errorSpan.style.color = '#10b981';
  input.style.borderColor = '#10b981';
  input.classList.add('valid');
  input.classList.remove('invalid');
  return true;
}

// Máscara de CNPJ
function mascaraCNPJ(valor) {
  return valor
    .replace(/\D/g, '')
    .replace(/^(\d{2})(\d)/, '$1.$2')
    .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
    .replace(/\.(\d{3})(\d)/, '.$1/$2')
    .replace(/(\d{4})(\d)/, '$1-$2')
    .substring(0, 18);
}

const AgendaModule = {
  atividades: [],
  intervaloAlertas: null,
  ultimaDataVerificada: null,
  historicoAgendas: {}, // Novo: armazena agendas por data
  // ⚡ ADICIONE ESTAS 3 LINHAS AQUI:
  API_URL: 'https://script.google.com/macros/s/AKfycbzr5_M25uDhZ6cgDbq4w1nMWVLFDFmbBVyJp2ahRV7gp7OcjfHvHtSwqzIlmUpcSHyC/exec', // ⚠️ COLE SUA URL AQUI
  intervaloSync: null,
  ultimaSincronizacao: null,
  
  init() {
  console.log('🚀 Iniciando Módulo de Agenda...');
  this.carregarAtividades();
  this.verificarMudancaDia();
  this.iniciarMonitoramento();

},
  
  carregarAtividades() {
  const saved = localStorage.getItem('agendaAtividades');
  const ultimaData = localStorage.getItem('agendaUltimaData');
  const historicoSaved = localStorage.getItem('historicoAgendas');
  
  if (saved) {
    this.atividades = JSON.parse(saved);
  } else {
    this.atividades = this.gerarAtividadesExemplo();
    this.salvarAtividades();
  }
  
  if (historicoSaved) {
    this.historicoAgendas = JSON.parse(historicoSaved);
  }
  
  if (ultimaData) {
    this.ultimaDataVerificada = ultimaData;
  } else {
    this.ultimaDataVerificada = this.obterDataAtual();
    localStorage.setItem('agendaUltimaData', this.ultimaDataVerificada);
  }
},

obterDataAtual() {
  const hoje = new Date();
  return hoje.toISOString().split('T')[0]; // Formato YYYY-MM-DD
},

verificarMudancaDia() {
  const dataAtual = this.obterDataAtual();
  
  console.log('📅 Verificando mudança de dia...');
  console.log('Última data verificada:', this.ultimaDataVerificada);
  console.log('Data atual:', dataAtual);
  
  if (this.ultimaDataVerificada !== dataAtual) {
    console.log('🔄 Detectada mudança de dia! Processando atividades...');
    this.processarMudancaDia();
    this.ultimaDataVerificada = dataAtual;
    localStorage.setItem('agendaUltimaData', dataAtual);
  }
},

processarMudancaDia() {
  // Salvar agenda do dia anterior no histórico antes de limpar
  if (this.atividades.length > 0) {
    this.historicoAgendas[this.ultimaDataVerificada] = JSON.parse(JSON.stringify(this.atividades));
    localStorage.setItem('historicoAgendas', JSON.stringify(this.historicoAgendas));
  }
  
  // Filtrar apenas atividades que NÃO foram concluídas
  const atividadesAbertas = this.atividades.filter(ativ => ativ.status !== 'concluido');
  
  console.log(`📋 Total de atividades anteriores: ${this.atividades.length}`);
  console.log(`⚠️ Atividades em aberto: ${atividadesAbertas.length}`);
  console.log(`✅ Atividades concluídas (arquivadas): ${this.atividades.length - atividadesAbertas.length}`);
  
  // Se houver atividades em aberto, mostrar notificação
  if (atividadesAbertas.length > 0) {
    showToast(
      `Você tem ${atividadesAbertas.length} atividade(s) pendente(s) do dia anterior que foram transferidas para hoje.`,
      'warning',
      '⏰ Atividades Pendentes'
    );
    
    // Resetar flags de alerta para as atividades transferidas
    atividadesAbertas.forEach(ativ => {
      ativ.alertado = false;
      ativ.alertaHoraExata = false;
      ativ.dataOriginal = this.ultimaDataVerificada;
    });
  } else {
    showToast(
      'Nova agenda do dia iniciada! Todas as atividades do dia anterior foram concluídas. 🎉',
      'success',
      '✅ Dia Anterior Completo'
    );
  }
  
  // Substituir array de atividades apenas com as em aberto
  this.atividades = atividadesAbertas;
  this.salvarAtividades();
  
  // Se estiver na aba de agenda, recarregar
  const agendaTab = document.getElementById('agenda');
  if (agendaTab && agendaTab.classList.contains('active-content')) {
    this.renderizar();
  }
},
  
  salvarAtividades() {
    localStorage.setItem('agendaAtividades', JSON.stringify(this.atividades));
  },
  
  gerarAtividadesExemplo() {
  return [
    {
      id: Date.now() + 1,
      titulo: 'Kickoff - Projeto Loja ABC',
      descricao: 'Reunião inicial do projeto com o cliente. Revisar escopo e cronograma.',
      tipo: 'reuniao',
      hora: '09:00',
      horaFim: '10:00',
      implantacaoId: AppState.implantacoes[0]?.id,
      status: 'pendente',
      prioridade: 'alta',
      participantes: ['Cliente ABC', 'Equipe Técnica'],
      alertado: false
    },
    {
      id: Date.now() + 2,
      titulo: 'Treinamento - Sistema POS',
      descricao: 'Treinamento do módulo de Ponto de Venda para operadores.',
      tipo: 'treinamento',
      hora: '10:30',
      horaFim: '12:00',
      implantacaoId: AppState.implantacoes[1]?.id,
      status: 'pendente',
      prioridade: 'media',
      participantes: ['Operadores de Caixa'],
      alertado: false
    },
    {
      id: Date.now() + 3,
      titulo: 'GO LIVE - Loja XYZ',
      descricao: 'Acompanhamento do GO LIVE e suporte aos usuários.',
      tipo: 'golive',
      hora: '14:00',
      horaFim: '16:00',
      implantacaoId: AppState.implantacoes[2]?.id,
      status: 'pendente',
      prioridade: 'urgente',
      participantes: ['Toda Equipe', 'Cliente'],
      alertado: false
    },
    {
      id: Date.now() + 4,
      titulo: 'Validação de Checklist',
      descricao: 'Revisar itens pendentes do checklist com o analista.',
      tipo: 'revisao',
      hora: '16:00',
      horaFim: '17:00',
      implantacaoId: AppState.implantacoes[0]?.id,
      status: 'pendente',
      prioridade: 'media',
      participantes: ['Analista Responsável'],
      alertado: false
    },
    {
      id: Date.now() + 5,
      titulo: 'Follow-up Pós-Implantação',
      descricao: 'Ligar para o cliente verificar satisfação e dúvidas.',
      tipo: 'followup',
      hora: '17:30',
      horaFim: '18:00',
      implantacaoId: AppState.implantacoes[1]?.id,
      status: 'pendente',
      prioridade: 'baixa',
      participantes: ['Cliente'],
      alertado: false
    }
  ];
},
  
  renderizar() {
    const container = document.getElementById('agenda-content');
    if (!container) return;
    
    const stats = this.calcularEstatisticas();
    const atividadesHoje = this.obterAtividadesHoje();
    const proximasAtividades = this.obterProximasAtividades(3);
    
    container.innerHTML = `
      <div class="agenda-container">
        <div class="agenda-header">
          <div class="agenda-title">
            <div class="agenda-icon">📅</div>
            <div>
              <h3>Minha Agenda do Dia</h3>
              <div class="agenda-subtitle">${new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
            </div>
          </div>
          <div class="agenda-actions">
  <button class="btn btn-primary" onclick="AgendaModule.abrirHistorico()" style="display:flex;align-items:center;gap:8px;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <polyline points="12 6 12 12 16 14"></polyline>
    </svg>
    Ver Histórico
  </button>
            <button class="btn btn-primary" onclick="AgendaModule.adicionarAtividade()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
              </svg>
              Nova Atividade
            </button>
          </div>
        </div>
        
        <div class="agenda-stats">
          <div class="agenda-stat-card">
            <div class="agenda-stat-icon">📋</div>
            <div class="agenda-stat-value">${stats.total}</div>
            <div class="agenda-stat-label">Total Hoje</div>
          </div>
          <div class="agenda-stat-card">
            <div class="agenda-stat-icon">⏳</div>
            <div class="agenda-stat-value" style="color:#f59e0b;">${stats.pendentes}</div>
            <div class="agenda-stat-label">Pendentes</div>
          </div>
          <div class="agenda-stat-card">
            <div class="agenda-stat-icon">🔄</div>
            <div class="agenda-stat-value" style="color:#3b82f6;">${stats.emAndamento}</div>
            <div class="agenda-stat-label">Em Andamento</div>
          </div>
          <div class="agenda-stat-card">
            <div class="agenda-stat-icon">✅</div>
            <div class="agenda-stat-value" style="color:#10b981;">${stats.concluidas}</div>
            <div class="agenda-stat-label">Concluídas</div>
          </div>
        </div>
        
        ${this.renderizarProximasAtividades(proximasAtividades)}
        
        <h4 style="color:#7c3aed;margin:30px 0 20px 0;font-size:20px;display:flex;align-items:center;gap:10px;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          Timeline do Dia
        </h4>
        <div class="agenda-timeline">
          <div class="timeline-line"></div>
          ${this.renderizarTimeline(atividadesHoje)}
        </div>
      </div>
    `;
  },
  
  renderizarProximasAtividades(atividades) {
    if (atividades.length === 0) {
      return `
        <div class="proximas-atividades">
          <h4><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Próximas Atividades</h4>
          <p style="color:#9ca3af;text-align:center;padding:20px;">Nenhuma atividade nas próximas horas</p>
        </div>
      `;
    }
    
    return `
      <div class="proximas-atividades">
        <h4><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Próximas Atividades</h4>
        ${atividades.map(ativ => `
          <div class="atividade-card" onclick="AgendaModule.visualizarAtividade(${ativ.id})">
            <div class="atividade-time">${ativ.hora}</div>
            <div class="atividade-content">
              <div class="atividade-title">${this.obterIconeTipo(ativ.tipo)} ${ativ.titulo}</div>
              <div class="atividade-description">${ativ.descricao}</div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  },
  
  renderizarTimeline(atividades) {
    if (atividades.length === 0) {
      return '<p style="color:#9ca3af;text-align:center;padding:40px;">Nenhuma atividade agendada para hoje</p>';
    }
    
    return atividades.map(ativ => {
      const horaAtual = new Date();
      const [hora, minuto] = ativ.hora.split(':');
      const horaAtividade = new Date();
      horaAtividade.setHours(parseInt(hora), parseInt(minuto), 0);
      
      const isAtiva = Math.abs(horaAtual - horaAtividade) < 30 * 60 * 1000;
      const markerClass = ativ.status === 'concluido' ? 'completed' : (isAtiva ? 'active' : 'pending');
      
      // Badge de transferida do dia anterior
const badgeTransferida = ativ.dataOriginal ? `
  <span style="background:rgba(245,158,11,0.2);color:#f59e0b;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;border:1px solid rgba(245,158,11,0.3);display:inline-flex;align-items:center;gap:5px;">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="1 4 1 10 7 10"></polyline>
      <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
    </svg>
    Transferida
  </span>
` : '';

return `
  <div class="timeline-item">
    <div class="timeline-marker ${markerClass}"></div>
    <div class="timeline-time">
      <div class="timeline-time-badge">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
${ativ.hora} - ${ativ.horaFim || this.calcularHoraFim(ativ.hora, 60)}
</div>
      <span class="timeline-status ${ativ.status.replace(' ', '-')}">${this.traduzirStatus(ativ.status)}</span>
      ${this.renderizarBadgePrioridade(ativ.prioridade)}
      ${badgeTransferida}
    </div>
          <div class="timeline-content">
            <h4>${this.obterIconeTipo(ativ.tipo)} ${ativ.titulo}</h4>
<p>${ativ.descricao}</p>
${ativ.dataOriginal ? `<p style="margin-top:8px;color:#f59e0b;font-size:12px;"><strong>⚠️ Nota:</strong> Atividade pendente de ${new Date(ativ.dataOriginal).toLocaleDateString('pt-BR')}</p>` : ''}
${ativ.implantacaoId ? this.renderizarInfoImplantacao(ativ.implantacaoId) : ''}
            ${ativ.participantes && ativ.participantes.length > 0 ? `<p style="margin-top:10px;"><strong style="color:#7c3aed;">👥 Participantes:</strong> ${ativ.participantes.join(', ')}</p>` : ''}
          </div>
          <div class="timeline-actions">
            ${ativ.status === 'pendente' ? `<button class="timeline-btn timeline-btn-primary" onclick="AgendaModule.iniciarAtividade(${ativ.id})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Iniciar</button>` : ''}
            ${ativ.status === 'em-andamento' ? `<button class="timeline-btn timeline-btn-success" onclick="AgendaModule.concluirAtividade(${ativ.id})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Concluir</button>` : ''}
            <button class="timeline-btn timeline-btn-primary" onclick="AgendaModule.editarAtividade(${ativ.id})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> Editar</button>
            ${ativ.implantacaoId ? `<button class="timeline-btn timeline-btn-primary" onclick="acompanharImplantacao(${ativ.implantacaoId})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg> Ver Projeto</button>` : ''}
          </div>
        </div>
      `;
    }).join('');
  },

  abrirHistorico() {
  const datasDisponiveis = Object.keys(this.historicoAgendas).sort().reverse();
  
  if (datasDisponiveis.length === 0) {
    showToast('Nenhum histórico de agendas anteriores disponível.', 'info');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <div class="modal-icon">📚</div>
        <div class="modal-title">Histórico de Agendas</div>
      </div>
      <div class="modal-body">
        <p style="color:#9ca3af;margin-bottom:20px;">Selecione uma data para visualizar a agenda:</p>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;margin-bottom:30px;">
          ${datasDisponiveis.map(data => {
            const dataObj = new Date(data + 'T12:00:00');
            const atividades = this.historicoAgendas[data];
            const concluidas = atividades.filter(a => a.status === 'concluido').length;
            const total = atividades.length;
            const percentual = Math.round((concluidas / total) * 100);
            
            return `
              <button onclick="AgendaModule.visualizarAgendaData('${data}')" style="all:unset;cursor:pointer;background:linear-gradient(145deg,rgba(31,41,55,0.95),rgba(17,24,39,0.98));border:2px solid rgba(124,58,237,0.3);border-radius:15px;padding:20px;text-align:center;transition:all 0.3s;" onmouseover="this.style.transform='translateY(-5px)';this.style.borderColor='rgba(124,58,237,0.8)';this.style.boxShadow='0 12px 30px rgba(124,58,237,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.borderColor='rgba(124,58,237,0.3)';this.style.boxShadow='none'">
                <div style="font-size:32px;margin-bottom:10px;">${dataObj.getDate()}</div>
                <div style="color:#7c3aed;font-size:14px;font-weight:600;margin-bottom:5px;">${dataObj.toLocaleDateString('pt-BR', { month: 'long' })}</div>
                <div style="color:#9ca3af;font-size:12px;margin-bottom:10px;">${dataObj.toLocaleDateString('pt-BR', { weekday: 'long' })}</div>
                <div style="background:rgba(17,24,39,0.6);border-radius:8px;height:8px;overflow:hidden;margin-bottom:8px;">
                  <div style="width:${percentual}%;height:100%;background:linear-gradient(90deg,#7c3aed,#10b981);"></div>
                </div>
                <div style="color:#d1d5db;font-size:11px;">${concluidas}/${total} concluídas</div>
              </button>
            `;
          }).join('')}
        </div>
        
        <div style="display:flex;gap:10px;justify-content:center;">
          <button class="btn btn-danger" onclick="AgendaModule.limparHistorico()">🗑️ Limpar Histórico</button>
          <button class="btn btn-warning" onclick="this.closest('.modal-overlay').remove()">Fechar</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
},

visualizarAgendaData(data) {
  const atividades = this.historicoAgendas[data];
  if (!atividades) return;
  
  const dataObj = new Date(data + 'T12:00:00');
  const dataFormatada = dataObj.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <div class="modal-icon">📅</div>
        <div class="modal-title">Agenda de ${dataFormatada}</div>
      </div>
      <div class="modal-body">
        <div class="agenda-stats" style="margin-bottom:30px;">
          <div class="agenda-stat-card">
            <div class="agenda-stat-icon">📋</div>
            <div class="agenda-stat-value">${atividades.length}</div>
            <div class="agenda-stat-label">Total</div>
          </div>
          <div class="agenda-stat-card">
            <div class="agenda-stat-icon">✅</div>
            <div class="agenda-stat-value" style="color:#10b981;">${atividades.filter(a => a.status === 'concluido').length}</div>
            <div class="agenda-stat-label">Concluídas</div>
          </div>
          <div class="agenda-stat-card">
            <div class="agenda-stat-icon">⏳</div>
            <div class="agenda-stat-value" style="color:#f59e0b;">${atividades.filter(a => a.status !== 'concluido').length}</div>
            <div class="agenda-stat-label">Não Concluídas</div>
          </div>
        </div>
        
        <div class="agenda-timeline">
          <div class="timeline-line"></div>
          ${atividades.sort((a, b) => {
            const [horaA, minA] = a.hora.split(':').map(Number);
            const [horaB, minB] = b.hora.split(':').map(Number);
            return (horaA * 60 + minA) - (horaB * 60 + minB);
          }).map(ativ => `
            <div class="timeline-item">
              <div class="timeline-marker ${ativ.status === 'concluido' ? 'completed' : 'pending'}"></div>
              <div class="timeline-time">
                <div class="timeline-time-badge">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                  ${ativ.hora} - ${ativ.horaFim || this.calcularHoraFim(ativ.hora, ativ.duracao)}
                </div>
                <span class="timeline-status ${ativ.status.replace(' ', '-')}">${this.traduzirStatus(ativ.status)}</span>
                ${this.renderizarBadgePrioridade(ativ.prioridade)}
              </div>
              <div class="timeline-content">
                <h4>${this.obterIconeTipo(ativ.tipo)} ${ativ.titulo}</h4>
                <p>${ativ.descricao}</p>
                ${ativ.participantes && ativ.participantes.length > 0 ? `<p style="margin-top:10px;"><strong style="color:#7c3aed;">👥 Participantes:</strong> ${ativ.participantes.join(', ')}</p>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
        
        <div style="display:flex;gap:10px;justify-content:center;margin-top:30px;">
          <button class="btn btn-primary" onclick="AgendaModule.abrirHistorico()">← Voltar ao Histórico</button>
          <button class="btn btn-warning" onclick="this.closest('.modal-overlay').remove()">Fechar</button>
        </div>
      </div>
    </div>
  `;
  
  document.querySelectorAll('.modal-overlay').forEach(m => m.remove());
  document.body.appendChild(modal);
},

limparHistorico() {
  if (confirm('Tem certeza que deseja APAGAR TODO o histórico de agendas anteriores? Esta ação não pode ser desfeita!')) {
    this.historicoAgendas = {};
    localStorage.removeItem('historicoAgendas');
    document.querySelector('.modal-overlay').remove();
    showToast('Histórico de agendas apagado!', 'success');
  }
},
  
  calcularEstatisticas() {
    const hoje = this.obterAtividadesHoje();
    return {
      total: hoje.length,
      pendentes: hoje.filter(a => a.status === 'pendente').length,
      emAndamento: hoje.filter(a => a.status === 'em-andamento').length,
      concluidas: hoje.filter(a => a.status === 'concluido').length
    };
  },
  
  obterAtividadesHoje() {
    return this.atividades.sort((a, b) => {
      const [horaA, minA] = a.hora.split(':').map(Number);
      const [horaB, minB] = b.hora.split(':').map(Number);
      return (horaA * 60 + minA) - (horaB * 60 + minB);
    });
  },
  
  obterProximasAtividades(n) {
    const agora = new Date();
    const horaAtual = agora.getHours() * 60 + agora.getMinutes();
    
    return this.atividades
      .filter(a => a.status !== 'concluido')
      .map(a => {
        const [hora, min] = a.hora.split(':').map(Number);
        const horaAtiv = hora * 60 + min;
        return { ...a, minutos: horaAtiv };
      })
      .filter(a => a.minutos >= horaAtual)
      .sort((a, b) => a.minutos - b.minutos)
      .slice(0, n);
  },

// ═══════════════════════════════════════════════════════
// ⚡ BLOCO DE FUNÇÕES - VERSÃO CORRIGIDA
// ═══════════════════════════════════════════════════════

iniciarMonitoramento() {
  // Verificar mudança de dia a cada 5 minutos
  setInterval(() => {
    this.verificarMudancaDia();
  }, 5 * 60 * 1000);
  
  // Alertas de atividades
  this.intervaloAlertas = setInterval(() => {
    this.verificarAlertas();
  }, 60000);
  
  this.verificarAlertas();
},

verificarAlertas() {
  const agora = new Date();
  const horaAtual = agora.getHours() * 60 + agora.getMinutes();
  
  this.atividades.forEach(ativ => {
    if (ativ.status !== 'concluido' && !ativ.alertado) {
      const [hora, min] = ativ.hora.split(':').map(Number);
      const horaAtiv = hora * 60 + min;
      const diferenca = horaAtiv - horaAtual;
      
      if (diferenca <= 15 && diferenca > 0) {
        this.mostrarAlerta(ativ, diferenca);
        ativ.alertado = true;
        this.salvarAtividades();
      }
      
      if (diferenca <= 0 && diferenca > -5) {
        if (!ativ.alertaHoraExata) {
          this.mostrarAlerta(ativ, 0);
          ativ.alertaHoraExata = true;
          this.salvarAtividades();
        }
      }
    }
  });
},

mostrarAlerta(atividade, minutosRestantes) {
  const alertId = 'alerta-' + atividade.id + '-' + Date.now();
  const alerta = document.createElement('div');
  alerta.className = 'alerta-flutuante';
  alerta.id = alertId;
  
  const mensagem = minutosRestantes === 0 ? '🔔 Sua atividade está começando AGORA!' : `⏰ Sua atividade começa em ${minutosRestantes} minutos!`;
  
  alerta.innerHTML = `
    <div class="alerta-header">
      <div class="alerta-icon">${this.obterIconeTipo(atividade.tipo)}</div>
      <div class="alerta-title">
        <h4>${mensagem}</h4>
        <div class="alerta-subtitle">${atividade.hora} - ${atividade.titulo}</div>
      </div>
      <button class="alerta-close" onclick="document.getElementById('${alertId}').remove()">×</button>
    </div>
    <div class="alerta-body">
      <strong>${atividade.titulo}</strong><br>
      ${atividade.descricao}
      ${atividade.participantes && atividade.participantes.length > 0 ? `<br><br>👥 <strong>Participantes:</strong> ${atividade.participantes.join(', ')}` : ''}
    </div>
    <div class="alerta-actions">
      <button class="alerta-btn alerta-btn-primary" onclick="AgendaModule.iniciarAtividadeDoAlerta(${atividade.id}, '${alertId}')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        Iniciar Agora
      </button>
      <button class="alerta-btn alerta-btn-secondary" onclick="AgendaModule.adiarAlerta(${atividade.id}, '${alertId}')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        Adiar 5min
      </button>
    </div>
  `;
  
  document.body.appendChild(alerta);
  this.tocarSomNotificacao();
  
  setTimeout(() => {
    const elem = document.getElementById(alertId);
    if (elem) elem.remove();
  }, 30000);
},

tocarSomNotificacao() {
  // Usar o AudioContext global se disponível
  if (!audioHabilitado || !audioContextGlobal) {
    console.log('ℹ️ Som desabilitado - aguardando interação do usuário');
    return;
  }
  
  try {
    if (audioContextGlobal.state === 'suspended') {
      audioContextGlobal.resume();
    }
    
    const oscillator1 = audioContextGlobal.createOscillator();
    const gainNode1 = audioContextGlobal.createGain();
    oscillator1.connect(gainNode1);
    gainNode1.connect(audioContextGlobal.destination);
    oscillator1.frequency.value = 800;
    oscillator1.type = 'sine';
    gainNode1.gain.setValueAtTime(0.3, audioContextGlobal.currentTime);
    gainNode1.gain.exponentialRampToValueAtTime(0.01, audioContextGlobal.currentTime + 0.3);
    oscillator1.start(audioContextGlobal.currentTime);
    oscillator1.stop(audioContextGlobal.currentTime + 0.3);
    
    const oscillator2 = audioContextGlobal.createOscillator();
    const gainNode2 = audioContextGlobal.createGain();
    oscillator2.connect(gainNode2);
    gainNode2.connect(audioContextGlobal.destination);
    oscillator2.frequency.value = 1000;
    oscillator2.type = 'sine';
    gainNode2.gain.setValueAtTime(0.3, audioContextGlobal.currentTime + 0.1);
    gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContextGlobal.currentTime + 0.4);
    oscillator2.start(audioContextGlobal.currentTime + 0.1);
    oscillator2.stop(audioContextGlobal.currentTime + 0.4);
  } catch (e) {
    console.log('⚠️ Erro ao tocar som:', e.message);
  }
},

iniciarAtividadeDoAlerta(id, alertId) {
  this.iniciarAtividade(id);
  const alerta = document.getElementById(alertId);
  if (alerta) alerta.remove();
},

adiarAlerta(id, alertId) {
  const atividade = this.atividades.find(a => a.id === id);
  if (atividade) {
    atividade.alertado = false;
    this.salvarAtividades();
  }
  
  const alerta = document.getElementById(alertId);
  if (alerta) alerta.remove();
  showToast('Alerta adiado por 5 minutos', 'info');
},

iniciarAtividade(id) {
  const atividade = this.atividades.find(a => a.id === id);
  if (atividade) {
    atividade.status = 'em-andamento';
    atividade.horaInicio = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    this.salvarAtividades();
    this.renderizar();
    showToast(`✓ Atividade "${atividade.titulo}" iniciada!`, 'success', 'Atividade Iniciada');
    
    if (atividade.implantacaoId) {
      setTimeout(() => {
        if (confirm('Deseja abrir o checklist da implantação vinculada?')) {
          acompanharImplantacao(atividade.implantacaoId);
        }
      }, 1000);
    }
  }
},

concluirAtividade(id) {
  const atividade = this.atividades.find(a => a.id === id);
  if (atividade) {
    atividade.status = 'concluido';
    atividade.horaConclusao = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    this.salvarAtividades();
    this.renderizar();
    criarConfete();
    showToast(`🎉 Atividade "${atividade.titulo}" concluída com sucesso!`, 'success', 'Parabéns!');
  }
},

adicionarAtividade() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <div class="modal-icon">📝</div>
        <div class="modal-title">Nova Atividade</div>
      </div>
      <div class="modal-body">
        <form id="form-nova-atividade" onsubmit="return AgendaModule.salvarNovaAtividade(event)">
          <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Título *</label>
          <input type="text" id="ativ-titulo" required style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;">
          
          <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Descrição *</label>
          <textarea id="ativ-descricao" required rows="3" style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;"></textarea>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
              <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Tipo *</label>
              <select id="ativ-tipo" required style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;">
                <option value="reuniao">Reunião</option>
                <option value="treinamento">Treinamento</option>
                <option value="golive">GO LIVE</option>
                <option value="revisao">Revisão</option>
                <option value="followup">Follow-up</option>
                <option value="outro">Outro</option>
              </select>
            </div>
            
            <div>
              <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Prioridade *</label>
              <select id="ativ-prioridade" required style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;">
                <option value="baixa">Baixa</option>
                <option value="media" selected>Média</option>
                <option value="alta">Alta</option>
                <option value="urgente">Urgente</option>
              </select>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
              <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Hora Início *</label>
              <input type="time" id="ativ-hora-inicio" required style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;">
            </div>
            
            <div>
              <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Hora Fim *</label>
              <input type="time" id="ativ-hora-fim" required style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;">
            </div>
          </div>
          
          <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Vincular a Implantação</label>
          <select id="ativ-implantacao" style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;">
            <option value="">Nenhuma</option>
            ${AppState.implantacoes.map(imp => `<option value="${imp.id}">${imp.portal} - ${imp.razao}</option>`).join('')}
          </select>
          
          <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Participantes (separados por vírgula)</label>
          <input type="text" id="ativ-participantes" placeholder="Ex: João Silva, Maria Santos" style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;">
          
          <div style="display:flex;gap:10px;margin-top:30px;">
            <button type="submit" class="btn btn-success" style="flex:1;">Salvar Atividade</button>
            <button type="button" class="btn btn-danger" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
},

salvarNovaAtividade(event) {
  event.preventDefault();
  
  const horaInicio = document.getElementById('ativ-hora-inicio').value;
  const horaFim = document.getElementById('ativ-hora-fim').value;
  
  // Validar se hora fim é maior que hora início
  const [hi, mi] = horaInicio.split(':').map(Number);
  const [hf, mf] = horaFim.split(':').map(Number);
  
  if ((hf * 60 + mf) <= (hi * 60 + mi)) {
    showToast('A hora de término deve ser maior que a hora de início!', 'error');
    return false;
  }
  
  const participantesStr = document.getElementById('ativ-participantes').value.trim();
  const participantes = participantesStr ? participantesStr.split(',').map(p => p.trim()) : [];
  
  const novaAtividade = {
    id: Date.now(),
    titulo: document.getElementById('ativ-titulo').value,
    descricao: document.getElementById('ativ-descricao').value,
    tipo: document.getElementById('ativ-tipo').value,
    prioridade: document.getElementById('ativ-prioridade').value,
    hora: horaInicio,
    horaFim: horaFim,
    implantacaoId: document.getElementById('ativ-implantacao').value ? parseInt(document.getElementById('ativ-implantacao').value) : null,
    participantes: participantes,
    status: 'pendente',
    alertado: false
  };
  
  this.atividades.push(novaAtividade);
  this.salvarAtividades();
  this.renderizar();
  
  document.querySelector('.modal-overlay').remove();
  showToast('Atividade criada com sucesso!', 'success');
  
  return false;
},

// ✅ CORREÇÃO: Editar atividade agora usa horaFim
editarAtividade(id) {
  const atividade = this.atividades.find(a => a.id === id);
  if (!atividade) return;
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <div class="modal-icon">✏️</div>
        <div class="modal-title">Editar Atividade</div>
      </div>
      <div class="modal-body">
        <form id="form-editar-atividade" onsubmit="return AgendaModule.salvarEdicaoAtividade(event, ${id})">
          <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Título *</label>
          <input type="text" id="edit-titulo" required value="${atividade.titulo}" style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;">
          
          <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Descrição *</label>
          <textarea id="edit-descricao" required rows="3" style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;">${atividade.descricao}</textarea>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
              <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Hora Início *</label>
              <input type="time" id="edit-hora-inicio" required value="${atividade.hora}" style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;">
            </div>
            
            <div>
              <label style="display:block;margin:15px 0 5px;color:#e5e7eb;font-weight:600;">Hora Fim *</label>
              <input type="time" id="edit-hora-fim" required value="${atividade.horaFim || this.calcularHoraFim(atividade.hora, 60)}" style="width:100%;padding:10px;border:2px solid #374151;border-radius:8px;background:#1f2937;color:#e5e7eb;">
            </div>
          </div>
          
          <div style="display:flex;gap:10px;margin-top:30px;">
            <button type="submit" class="btn btn-success" style="flex:1;">Salvar Alterações</button>
            <button type="button" class="btn btn-danger" onclick="AgendaModule.excluirAtividade(${id})">Excluir</button>
            <button type="button" class="btn btn-warning" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
},

// ✅ CORREÇÃO: Salvar edição agora usa horaFim
salvarEdicaoAtividade(event, id) {
  event.preventDefault();
  
  const horaInicio = document.getElementById('edit-hora-inicio').value;
  const horaFim = document.getElementById('edit-hora-fim').value;
  
  // Validar se hora fim é maior que hora início
  const [hi, mi] = horaInicio.split(':').map(Number);
  const [hf, mf] = horaFim.split(':').map(Number);
  
  if ((hf * 60 + mf) <= (hi * 60 + mi)) {
    showToast('A hora de término deve ser maior que a hora de início!', 'error');
    return false;
  }
  
  const atividade = this.atividades.find(a => a.id === id);
  if (atividade) {
    atividade.titulo = document.getElementById('edit-titulo').value;
    atividade.descricao = document.getElementById('edit-descricao').value;
    atividade.hora = horaInicio;
    atividade.horaFim = horaFim;
    atividade.alertado = false;
    
    this.salvarAtividades();
    this.renderizar();
    
    document.querySelector('.modal-overlay').remove();
    showToast('Atividade atualizada com sucesso!', 'success');
  }
  
  return false;
},

excluirAtividade(id) {
  if (confirm('Tem certeza que deseja excluir esta atividade?')) {
    this.atividades = this.atividades.filter(a => a.id !== id);
    this.salvarAtividades();
    this.renderizar();
    
    document.querySelector('.modal-overlay').remove();
    showToast('Atividade excluída!', 'success');
  }
},

// ✅ CORREÇÃO: Visualizar atividade agora usa horaFim
visualizarAtividade(id) {
  const atividade = this.atividades.find(a => a.id === id);
  if (!atividade) return;
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <div class="modal-icon">${this.obterIconeTipo(atividade.tipo)}</div>
        <div class="modal-title">${atividade.titulo}</div>
      </div>
      <div class="modal-body">
        <div style="background:rgba(124,58,237,0.1);border:2px solid rgba(124,58,237,0.3);border-radius:12px;padding:20px;margin-bottom:20px;">
          <p style="margin:0;color:#e5e7eb;line-height:1.8;">
            <strong style="color:#7c3aed;">⏰ Horário:</strong> ${atividade.hora} - ${atividade.horaFim || this.calcularHoraFim(atividade.hora, 60)}<br>
            <strong style="color:#7c3aed;">📊 Status:</strong> ${this.traduzirStatus(atividade.status)}<br>
            <strong style="color:#7c3aed;">🎯 Prioridade:</strong> ${this.traduzirPrioridade(atividade.prioridade)}
          </p>
        </div>
        
        <div style="margin-bottom:20px;">
          <h4 style="color:#7c3aed;margin:0 0 10px 0;">📝 Descrição</h4>
          <p style="color:#d1d5db;margin:0;line-height:1.6;">${atividade.descricao}</p>
        </div>
        
        ${atividade.participantes && atividade.participantes.length > 0 ? `
          <div style="margin-bottom:20px;">
            <h4 style="color:#7c3aed;margin:0 0 10px 0;">👥 Participantes</h4>
            <div style="display:flex;flex-wrap:wrap;gap:8px;">
              ${atividade.participantes.map(p => `<span style="background:rgba(124,58,237,0.2);color:#c4b5fd;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;">${p}</span>`).join('')}
            </div>
          </div>
        ` : ''}
        
        ${atividade.implantacaoId ? `
          <div style="background:rgba(16,185,129,0.1);border:2px solid rgba(16,185,129,0.3);border-radius:12px;padding:15px;margin-bottom:20px;">
            <h4 style="color:#10b981;margin:0 0 10px 0;">🔗 Implantação Vinculada</h4>
            ${this.renderizarInfoImplantacao(atividade.implantacaoId)}
          </div>
        ` : ''}
        
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          ${atividade.status === 'pendente' ? `<button class="btn btn-success" onclick="AgendaModule.iniciarAtividade(${id}); document.querySelector('.modal-overlay').remove();"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Iniciar Atividade</button>` : ''}
          ${atividade.status === 'em-andamento' ? `<button class="btn btn-success" onclick="AgendaModule.concluirAtividade(${id}); document.querySelector('.modal-overlay').remove();"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Concluir Atividade</button>` : ''}
          <button class="btn btn-primary" onclick="AgendaModule.editarAtividade(${id}); document.querySelector('.modal-overlay').remove();">Editar</button>
          <button class="btn btn-warning" onclick="document.querySelector('.modal-overlay').remove()">Fechar</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
},

filtrarPor(tipo) {
  showToast(`Filtrando atividades: ${tipo}`, 'info');
},

obterIconeTipo(tipo) {
  const icones = {
    reuniao: '👥',
    treinamento: '🎓',
    golive: '🚀',
    revisao: '🔍',
    followup: '📞',
    outro: '📋'
  };
  return icones[tipo] || '📋';
},

traduzirStatus(status) {
  const traducoes = {
    'pendente': 'Pendente',
    'em-andamento': 'Em Andamento',
    'concluido': 'Concluído'
  };
  return traducoes[status] || status;
},

traduzirPrioridade(prioridade) {
  const traducoes = {
    'baixa': 'Baixa',
    'media': 'Média',
    'alta': 'Alta',
    'urgente': 'Urgente'
  };
  return traducoes[prioridade] || prioridade;
},

renderizarBadgePrioridade(prioridade) {
  const configs = {
    urgente: { cor: '#ef4444', label: 'URGENTE' },
    alta: { cor: '#f59e0b', label: 'ALTA' },
    media: { cor: '#3b82f6', label: 'MÉDIA' },
    baixa: { cor: '#6b7280', label: 'BAIXA' }
  };
  
  const config = configs[prioridade] || configs.media;
  
  return `<span style="background:${config.cor}33;color:${config.cor};padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;border:1px solid ${config.cor}66;">${config.label}</span>`;
},

calcularHoraFim(horaInicio, duracao) {
  const [hora, min] = horaInicio.split(':').map(Number);
  const totalMinutos = hora * 60 + min + duracao;
  const horaFim = Math.floor(totalMinutos / 60) % 24;
  const minFim = totalMinutos % 60;
  return `${String(horaFim).padStart(2, '0')}:${String(minFim).padStart(2, '0')}`;
},

renderizarInfoImplantacao(implantacaoId) {
  const imp = AppState.implantacoes.find(i => i.id === implantacaoId);
  if (!imp) return '';

  const progressoGeral = calcularProgressoGeral(imp.id);

  return `
    <div style="display:flex;align-items:center;gap:12px;">
      ${imp.logo ? `<img src="${imp.logo}" style="width:40px;height:40px;border-radius:8px;object-fit:cover;border:2px solid rgba(124,58,237,0.3);">` : ''}
      <div style="flex:1;">
        <strong style="color:#e5e7eb;font-size:14px;">${imp.portal} - ${imp.razao}</strong>
        <div style="margin-top:5px;background:rgba(17,24,39,0.6);border-radius:8px;height:8px;overflow:hidden;">
          <div style="width:${progressoGeral}%;height:100%;background:linear-gradient(90deg,#7c3aed,#10b981);transition:width 0.3s;"></div>
        </div>
        <span style="color:#9ca3af;font-size:12px;">Progresso: ${progressoGeral}%</span>
      </div>
    </div>
  `;
}
}; // FIM DO OBJETO AgendaModule

function adicionarMenuAgenda() {
  const sidebarNav = document.querySelector('.sidebar-nav');
  if (!sidebarNav) return;
  
  // Procurar o item "Dashboard" ao invés do último divider
  const dashboardItem = Array.from(sidebarNav.children).find(item => 
    item.classList.contains('nav-item') && 
    item.textContent.includes('Dashboard')
  );
  
  if (dashboardItem) {
    // Verificar se já não existe
    const jaExiste = Array.from(sidebarNav.children).some(item => 
      item.classList.contains('nav-item') && 
      item.textContent.includes('Agenda do Dia')
    );
    
    if (jaExiste) return; // Já foi adicionado
    
    const agendaMenuItem = document.createElement('div');
    agendaMenuItem.className = 'nav-item';
    agendaMenuItem.setAttribute('onclick', "navigateTo('agenda', this)");
    agendaMenuItem.innerHTML = `
      <span class="nav-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      </span>
      <span>Agenda do Dia</span>
    `;
    
    // Inserir logo após o Dashboard
    dashboardItem.parentNode.insertBefore(agendaMenuItem, dashboardItem.nextSibling);
  }
}

function adicionarConteudoAgenda() {
  const container = document.querySelector('.container');
  if (!container) return;

  const agendaTab = document.createElement('div');
  agendaTab.id = 'agenda';
  agendaTab.className = 'tab-content';
  agendaTab.innerHTML = '<div id="agenda-content"></div>';
  
  container.appendChild(agendaTab);
}

const navigateToOriginal = window.navigateTo;
window.navigateTo = function(tabName, navElement) {
  navigateToOriginal(tabName, navElement);
  
  if (tabName === 'agenda') {
    AgendaModule.renderizar();
    
    const pageTitle = document.getElementById('page-title');
    const breadcrumb = document.getElementById('breadcrumb');

    if (pageTitle) pageTitle.textContent = 'Agenda do Dia';
    if (breadcrumb) breadcrumb.textContent = 'Produtividade / Agenda';
  }
};

document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    adicionarMenuAgenda();
    adicionarConteudoAgenda();
    AgendaModule.init();
  }, 500);
});

window.addEventListener('beforeunload', () => {
  if (AgendaModule.intervaloAlertas) {
    clearInterval(AgendaModule.intervaloAlertas);
  }
});

// ===== INICIALIZAÇÃO DO SISTEMA =====
window.addEventListener('DOMContentLoaded', function() {
  // Carrega dados do localStorage
  const dadosSalvos = localStorage.getItem('sgi_dados');
  if (dadosSalvos) {
    const dados = JSON.parse(dadosSalvos);
    AppState.implantacoes = dados.implantacoes || [];
    AppState.checklistStatus = dados.checklistStatus || {};
    AppState.treinamentos = dados.treinamentos || {};
    AppState.checklistPadrao = dados.checklistPadrao || [];
    AppState.checklistOptico = dados.checklistOptico || [];
  }
  
  // Carrega histórico
  const historico = localStorage.getItem('sgi_historico');
  if (historico) {
    AppState.historicoAlteracoes = JSON.parse(historico);
  }
  
  // ⬇️⬇️⬇️ ATIVA O BACKUP AUTOMÁTICO ⬇️⬇️⬇️
  backupAutomatico();
  console.log('🔄 Sistema de backup automático ativado');
  
  // Verificar alertas após 5 segundos
  setTimeout(verificarAlertasInteligentes, 5000);
});

// ===== ATALHOS DE TECLADO =====
document.addEventListener('keydown', (e) => {
  // Ctrl/Cmd + S = Salvar formulário ativo
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    const form = document.querySelector('form:not([style*="display: none"])');
    if (form) {
      form.requestSubmit();
      showToast('💾 Salvando...', 'info');
    }
  }
  
  // Ctrl/Cmd + K = Busca rápida
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    const buscaInput = document.getElementById('busca-implantacao');
    if (buscaInput) {
      buscaInput.focus();
      buscaInput.select();
      showToast('🔍 Busca ativada', 'info');
    }
  }
  
  // Ctrl/Cmd + N = Nova implantação
  if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
    e.preventDefault();
    navigateTo('nova-implantacao');
    showToast('➕ Nova Implantação', 'info');
  }
  
  // Ctrl/Cmd + D = Dashboard
  if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
    e.preventDefault();
    navigateTo('dashboard');
    showToast('📊 Dashboard', 'info');
  }
  
  // Esc = Fechar modais e dropdowns
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay, .profile-modal').forEach(m => {
      m.classList.remove('active');
      m.style.display = 'none';
    });
    
    document.querySelectorAll('.user-dropdown, .notifications-dropdown, .export-dropdown').forEach(d => {
      d.classList.remove('active');
      d.style.display = 'none';
    });
  }
  
  // Ctrl/Cmd + B = Criar backup manual
  if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
    e.preventDefault();
    criarBackupManual();
  }
  
  // F1 = Ajuda (exibir atalhos)
  if (e.key === 'F1') {
    e.preventDefault();
    exibirAjudaAtalhos();
  }
});

function exibirAjudaAtalhos() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content">
      <button class="profile-close" onclick="this.remove(); this.closest('.modal-overlay').remove()">×</button>
      
      <div class="modal-header">
        <div class="modal-icon" style="background: linear-gradient(135deg, #7c3aed, #6d28d9);">⌨️</div>
        <h3 class="modal-title" style="color: #7c3aed;">Atalhos de Teclado</h3>
      </div>
      
      <div class="modal-body">
        <div style="display: grid; gap: 12px;">
          <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(17, 24, 39, 0.6); border-radius: 6px;">
            <span><kbd>Ctrl</kbd> + <kbd>S</kbd></span>
            <span style="color: #9ca3af;">Salvar formulário</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(17, 24, 39, 0.6); border-radius: 6px;">
            <span><kbd>Ctrl</kbd> + <kbd>K</kbd></span>
            <span style="color: #9ca3af;">Busca rápida</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(17, 24, 39, 0.6); border-radius: 6px;">
            <span><kbd>Ctrl</kbd> + <kbd>N</kbd></span>
            <span style="color: #9ca3af;">Nova implantação</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(17, 24, 39, 0.6); border-radius: 6px;">
            <span><kbd>Ctrl</kbd> + <kbd>D</kbd></span>
            <span style="color: #9ca3af;">Ir para Dashboard</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(17, 24, 39, 0.6); border-radius: 6px;">
            <span><kbd>Ctrl</kbd> + <kbd>B</kbd></span>
            <span style="color: #9ca3af;">Criar backup</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(17, 24, 39, 0.6); border-radius: 6px;">
            <span><kbd>Esc</kbd></span>
            <span style="color: #9ca3af;">Fechar modais</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(17, 24, 39, 0.6); border-radius: 6px;">
            <span><kbd>F1</kbd></span>
            <span style="color: #9ca3af;">Exibir ajuda</span>
          </div>
        </div>
        
        <p style="color: #9ca3af; margin-top: 20px; font-size: 12px; text-align: center;">
          💡 Use <kbd>Cmd</kbd> no lugar de <kbd>Ctrl</kbd> no Mac
        </p>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">
          Entendi!
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Exibir toast com atalhos na primeira vez
if (!localStorage.getItem('sgi_atalhos_visto')) {
  setTimeout(() => {
    showToast('💡 Pressione F1 para ver os atalhos de teclado!', 'info');
    localStorage.setItem('sgi_atalhos_visto', 'true');
  }, 3000);
}

</script>
<!-- ====================================== -->
<!-- MÓDULO DE AGENDA INTEGRADA - FIM -->
<!-- ====================================== -->

</div> <!-- Fim tab Agenda -->

<!-- ═══════════════════════════════════════════════════════ -->
<!-- TAB: VISÃO POR TIMES -->
<!-- ═══════════════════════════════════════════════════════ -->
<div id="visao-times" class="tab-content">
  
  <!-- Header -->
  <div class="section-header">
    <div>
      <h3>🏢 Visão por Times</h3>
      <p style="color: #9ca3af; margin-top: 8px; font-size: 14px;">
        Acompanhe o progresso dos projetos por time de forma consolidada
      </p>
    </div>
  </div>

  <!-- Filtros -->
  <div class="times-filter-container">
    <div class="times-filter-label">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
      </svg>
      <span>Filtrar por Time:</span>
    </div>
    <div class="times-filter-buttons">
      <button class="time-filter-btn active" onclick="filtrarPorTime('TODOS')" data-time="TODOS">
        <span class="filter-icon">🌐</span>
        <span>Todos os Times</span>
        <span class="filter-count" id="count-todos">0</span>
      </button>
      <button class="time-filter-btn" onclick="filtrarPorTime('SMB')" data-time="SMB">
        <span class="filter-icon">🏪</span>
        <span>SMB</span>
        <span class="filter-count" id="count-smb">0</span>
      </button>
      <button class="time-filter-btn" onclick="filtrarPorTime('BASE')" data-time="BASE">
        <span class="filter-icon">📊</span>
        <span>BASE</span>
        <span class="filter-count" id="count-base">0</span>
      </button>
      <button class="time-filter-btn" onclick="filtrarPorTime('KA')" data-time="KA">
        <span class="filter-icon">⭐</span>
        <span>KA</span>
        <span class="filter-count" id="count-ka">0</span>
      </button>
    </div>
  </div>

  <!-- Dashboard Métricas -->
  <div class="times-dashboard">
    <div class="time-metric-card">
      <div class="metric-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
        </svg>
      </div>
      <div class="metric-info">
        <div class="metric-value" id="time-total">0</div>
        <div class="metric-label">Total de Projetos</div>
      </div>
    </div>

    <div class="time-metric-card">
      <div class="metric-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </div>
      <div class="metric-info">
        <div class="metric-value" id="time-andamento">0</div>
        <div class="metric-label">Em Andamento</div>
      </div>
    </div>

    <div class="time-metric-card">
      <div class="metric-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <div class="metric-info">
        <div class="metric-value" id="time-finalizados">0</div>
        <div class="metric-label">Finalizados</div>
      </div>
    </div>

    <div class="time-metric-card">
      <div class="metric-icon" style="background: linear-gradient(135deg, #7c3aed, #6d28d9);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        </svg>
      </div>
      <div class="metric-info">
        <div class="metric-value" id="time-progresso-medio">0%</div>
        <div class="metric-label">Progresso Médio</div>
      </div>
    </div>
  </div>

  <!-- Gráfico -->
  <div class="times-chart-container">
    <h4 style="color: #e5e7eb; margin-bottom: 15px; font-size: 16px;">
      📈 Distribuição por Status
    </h4>
    <canvas id="timesStatusChart" style="max-height: 300px;"></canvas>
  </div>

  <!-- Lista de Projetos -->
  <div class="times-projetos-section">
    <h4 style="color: #e5e7eb; margin-bottom: 15px; font-size: 16px;">
      <span id="times-titulo-lista">📋 Todos os Projetos</span>
    </h4>
    <div id="times-projetos-lista"></div>
  </div>

</div>
<!-- Fim Visão por Times -->

<footer class="footer">

<!-- FOOTER -->
<footer style="background-color: #1a1a2e; color: #eee; padding: 40px 0 20px; margin-top: 50px;">
  <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-bottom: 30px;">
      
      <div>
        <h4 style="color: #3498db; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Sistema SGI</h4>
        <p style="font-size: 13px; line-height: 1.6; color: #bbb; margin: 0;">
          Sistema de Gerenciamento de Implantações para controle eficiente de projetos e acompanhamento de entregas.
        </p>
      </div>
      
      <div>
        <h4 style="color: #3498db; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Contato</h4>
        
        <!-- Email -->
        <p style="font-size: 13px; color: #bbb; margin: 10px 0;">
          <a href="mailto:guilherme.reginato@linx.com.br?subject=Contato%20via%20Sistema%20SGI&body=Olá%20Guilherme,%0A%0AGostaria%20de%20entrar%20em%20contato%20sobre%20o%20Sistema%20de%20Gerenciamento%20de%20Implantações.%0A%0AAtenciosamente," 
             style="color: #bbb; text-decoration: none; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px;" 
             onmouseover="this.style.color='#3498db'; this.style.transform='translateX(3px)'" 
             onmouseout="this.style.color='#bbb'; this.style.transform='translateX(0)'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            <span>guilherme.reginato@linx.com.br</span>
          </a>
        </p>
        
        <!-- WhatsApp -->
        <p style="font-size: 13px; color: #bbb; margin: 10px 0;">
          <a href="https://wa.me/5547996790866?text=Olá,%20Guilherme!%20%0A%0AAcessei%20o%20*Sistema%20de%20Gerenciamento%20de%20Implantações*%20e%20gostaria%20de%20mais%20informações." 
             target="_blank" 
             rel="noopener noreferrer"
             style="color: #bbb; text-decoration: none; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px;" 
             onmouseover="this.style.color='#25D366'; this.style.transform='translateX(3px)'" 
             onmouseout="this.style.color='#bbb'; this.style.transform='translateX(0)'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
            </svg>
            <span>(47) 99679-0866</span>
          </a>
        </p>
        
        <!-- LinkedIn -->
        <p style="font-size: 13px; color: #bbb; margin: 10px 0;">
          <a href="https://www.linkedin.com/in/guilherme-leite-reginato-894aa9228/" 
             target="_blank" 
             rel="noopener noreferrer"
             style="color: #bbb; text-decoration: none; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px;" 
             onmouseover="this.style.color='#0077b5'; this.style.transform='translateX(3px)'" 
             onmouseout="this.style.color='#bbb'; this.style.transform='translateX(0)'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
              <rect x="2" y="9" width="4" height="12"></rect>
              <circle cx="4" cy="4" r="2"></circle>
            </svg>
            <span>LinkedIn</span>
          </a>
        </p>
      </div>
      
      <div>
        <h4 style="color: #3498db; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Desenvolvedor</h4>
        <p style="font-size: 13px; color: #bbb; line-height: 1.8; margin: 0;">
          <strong style="color: #fff; font-size: 14px;">Guilherme Leite Reginato</strong><br>
        </p>
      </div>
      
    </div>
    
    <div style="border-top: 1px solid #333; padding-top: 20px; text-align: center;">
      <p style="font-size: 12px; color: #999; margin: 5px 0;">
        © 2025 Sistema de Gerenciamento de Implantações. Todos os direitos reservados.
      </p>
      <p style="font-size: 11px; color: #777; margin: 5px 0;">
        Versão 2.0.0 | Desenvolvido por Guilherme Leite Reginato
      </p>
    </div>
  </div>
</footer>

<!-- Firebase SDK -->
<script type="module">
  // Import das bibliotecas Firebase
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';  // Sua configuração do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDtFGPrvQpcmQEPfgtZCWNSbsSfnCRqnQM",
    authDomain: "sgi-sistema.firebaseapp.com",
    projectId: "sgi-sistema",
    storageBucket: "sgi-sistema.firebasestorage.app",
    messagingSenderId: "844986494867",
    appId: "1:844986494867:web:4f46410cd2e219ee3cc266",
    measurementId: "G-NXRH4592N5"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Executar migração ao carregar
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    migrarImplantacoesParaTimes();
  }, 1500);
});

  // Tornar disponível globalmente para usar em outros scripts
  window.db = db;
  window.auth = auth;
  window.firebaseFirestore = { 
    collection, 
    addDoc, 
    getDocs, 
    query, 
    where, 
    doc, 
    updateDoc, 
    deleteDoc 
  };
  window.firebaseAuth = {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  sendPasswordResetEmail
};

  // 👤 Verificar estado de autenticação ao carregar
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log('✅ Usuário já autenticado:', user.email);
      window.usuarioLogado = user.email;
    } else {
      console.log('ℹ️ Nenhum usuário autenticado');
      window.usuarioLogado = null;
    }
  });

  console.log('🔥 Firebase conectado com sucesso!');

</script>
</body>
</html>